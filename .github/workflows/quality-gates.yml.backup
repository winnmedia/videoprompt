name: í’ˆì§ˆ ê²Œì´íŠ¸ - ì¸ì¦ ì‹œìŠ¤í…œ ì•ˆì „ì„± ê²€ì¦

on:
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/**'
  push:
    branches: [main]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Stage 1: ë¹ ë¥¸ ê²€ì¦ (2ë¶„ ì´ë‚´)
  fast-validation:
    name: 'ğŸš€ ë¹ ë¥¸ ê²€ì¦ (2ë¶„)'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should-continue: ${{ steps.changes.outputs.should-continue }}

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë³€ê²½ì‚¬í•­ ê°ì§€
        id: changes
        uses: dorny/paths-filter@v2
        with:
          filters: |
            auth:
              - 'src/shared/lib/supabase-auth.ts'
              - 'src/shared/lib/auth-supabase.ts'
              - 'src/app/api/auth/**'
            tests:
              - 'src/**/*.test.ts'
              - 'src/**/*.test.tsx'
              - 'src/__tests__/**'
            critical:
              - 'src/shared/lib/supabase-auth.ts'
              - 'src/app/api/auth/me/route.ts'

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ì˜ì¡´ì„± ìºì‹œ
        uses: actions/cache@v3
        with:
          path: ~/.pnpm-store
          key: ${{ runner.os }}-pnpm-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: íƒ€ì… ê²€ì‚¬
        run: pnpm run type-check

      - name: ë¦°íŒ…
        run: pnpm run lint

      - name: $300 ì‚¬ê±´ ë°©ì§€ - ë¬´í•œ ë£¨í”„ ê°ì§€ (ê°•í™”ëœ íŒ¨í„´ ê²€ì‚¬)
        run: |
          echo "ğŸš¨ $300 ì‚¬ê±´ ë°©ì§€ ê²€ì‚¬ ì‹œì‘..."

          # 1. useEffect ì˜ì¡´ì„± ë°°ì—´ì— í•¨ìˆ˜ê°€ í¬í•¨ëœ íŒ¨í„´ ê²€ì‚¬
          echo "ê²€ì‚¬ 1: useEffect ì˜ì¡´ì„± í•¨ìˆ˜ íŒ¨í„´..."
          if grep -r "useEffect.*\[.*[a-zA-Z_][a-zA-Z0-9_]*\]" src/ --include="*.tsx" --include="*.ts" | grep -v "test" | grep -v "mock"; then
            echo "âŒ ìœ„í—˜: useEffect ì˜ì¡´ì„± ë°°ì—´ì— í•¨ìˆ˜ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤!"
            echo "ì´ëŠ” $300 ì‚¬ê±´ê³¼ ê°™ì€ ë¬´í•œ ë£¨í”„ë¥¼ ì•¼ê¸°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
            echo "í•´ê²°ë°©ë²•: useEffect(() => { checkAuth(); }, []) // ë¹ˆ ë°°ì—´ ì‚¬ìš©"
            exit 1
          fi

          # 2. /api/auth/me ë¬´í•œ í˜¸ì¶œ íŒ¨í„´ ê²€ì‚¬
          echo "ê²€ì‚¬ 2: /api/auth/me ë¬´í•œ í˜¸ì¶œ íŒ¨í„´..."
          if grep -r "\/api\/auth\/me" src/ --include="*.tsx" --include="*.ts" | grep -v "test" | grep useEffect; then
            echo "âš ï¸ ê²½ê³ : /api/auth/meë¥¼ useEffectì—ì„œ í˜¸ì¶œí•˜ëŠ” íŒ¨í„´ ë°œê²¬"
            echo "ë¬´í•œ ë£¨í”„ ìœ„í—˜ì´ ìˆìœ¼ë‹ˆ ë°˜ë“œì‹œ ì ì ˆí•œ ì˜ì¡´ì„± ë°°ì—´ì„ ì‚¬ìš©í•˜ì„¸ìš”."
          fi

          # 3. ë†’ì€ ë¹ˆë„ API í˜¸ì¶œ íŒ¨í„´ ê²€ì‚¬
          echo "ê²€ì‚¬ 3: ë†’ì€ ë¹ˆë„ API í˜¸ì¶œ íŒ¨í„´..."
          if grep -r "setInterval\|setTimeout.*fetch\|useEffect.*fetch" src/ --include="*.tsx" --include="*.ts" | grep -v "test"; then
            echo "âš ï¸ ê²½ê³ : íƒ€ì´ë¨¸ ê¸°ë°˜ API í˜¸ì¶œ íŒ¨í„´ ë°œê²¬"
            echo "ê³¼ë„í•œ API í˜¸ì¶œì„ ë°©ì§€í•˜ê¸° ìœ„í•´ ì ì ˆí•œ ê°„ê²©ê³¼ ì œí•œì„ ì„¤ì •í•˜ì„¸ìš”."
          fi

          echo "âœ… $300 ì‚¬ê±´ ë°©ì§€ ê²€ì‚¬ í†µê³¼"

  # Stage 2: ì¸ì¦ ì‹œìŠ¤í…œ ì§‘ì¤‘ í…ŒìŠ¤íŠ¸
  auth-system-tests:
    name: 'ğŸ” ì¸ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ (100% ì»¤ë²„ë¦¬ì§€)'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: fast-validation
    if: needs.fast-validation.outputs.should-continue == 'true'

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: íšŒê·€ ë°©ì§€ í•µì‹¬ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸
        run: |
          echo "ğŸ” $300 ì‚¬ê±´ íšŒê·€ ë°©ì§€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."

          # useEffect ë¬´í•œ ë£¨í”„ ë°©ì§€ í…ŒìŠ¤íŠ¸
          echo "í…ŒìŠ¤íŠ¸ 1: useEffect ë¬´í•œ ë£¨í”„ ë°©ì§€..."
          pnpm test src/__tests__/auth/useEffect-infinite-loop-prevention.test.ts --verbose

          # /api/auth/me 401 ë£¨í”„ ë°©ì§€ í…ŒìŠ¤íŠ¸
          echo "í…ŒìŠ¤íŠ¸ 2: /api/auth/me 401 ë£¨í”„ ë°©ì§€..."
          pnpm test src/__tests__/auth/auth-me-401-loop-prevention.test.ts --verbose

          # API í˜¸ì¶œ ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸
          echo "í…ŒìŠ¤íŠ¸ 3: API í˜¸ì¶œ ëª¨ë‹ˆí„°ë§..."
          pnpm test src/__tests__/auth/api-call-monitoring.test.ts --verbose

          # í† í° ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨ í…ŒìŠ¤íŠ¸
          echo "í…ŒìŠ¤íŠ¸ 4: í† í° ë¦¬í”„ë ˆì‹œ ì‹¤íŒ¨ ì²˜ë¦¬..."
          pnpm test src/__tests__/auth/token-refresh-failure.test.ts --verbose

          # 401/400 ì—ëŸ¬ ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
          echo "í…ŒìŠ¤íŠ¸ 5: 401/400 ì—ëŸ¬ ì²˜ë¦¬..."
          pnpm test src/__tests__/auth/error-handling-401-400.test.ts --verbose

      - name: í†µí•© ì‹œìŠ¤í…œ ì•ˆì •ì„± í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ”„ í†µí•© ì‹œìŠ¤í…œ ì•ˆì •ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."

          # Supabase null ì—ëŸ¬ ë°©ì§€
          echo "í…ŒìŠ¤íŠ¸ 1: Supabase null ì—ëŸ¬ ë°©ì§€..."
          pnpm test src/__tests__/integration/supabase-null-error-prevention.test.ts --verbose

          # ë°ì´í„° ì¼ê´€ì„± íŠ¸ëœì­ì…˜ í…ŒìŠ¤íŠ¸
          echo "í…ŒìŠ¤íŠ¸ 2: ë°ì´í„° ì¼ê´€ì„± íŠ¸ëœì­ì…˜..."
          pnpm test src/__tests__/integration/data-consistency-transaction.test.ts --verbose

          # Seedance API í‚¤ ê²€ì¦
          echo "í…ŒìŠ¤íŠ¸ 3: Seedance API í‚¤ ê²€ì¦..."
          pnpm test src/__tests__/integration/seedance-api-key-validation.test.ts --verbose

          # API ê³„ì•½ ê²€ì¦
          echo "í…ŒìŠ¤íŠ¸ 4: API ê³„ì•½ ê²€ì¦..."
          pnpm test src/__tests__/integration/api-contract-verification.test.ts --verbose

          # í™˜ê²½ë³€ìˆ˜ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
          echo "í…ŒìŠ¤íŠ¸ 5: í™˜ê²½ë³€ìˆ˜ ì‹œë‚˜ë¦¬ì˜¤..."
          pnpm test src/__tests__/integration/environment-variable-scenarios.test.ts --verbose

      - name: ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ê²€ì¦ (90% ì´ìƒ)
        run: |
          echo "ğŸ“Š ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ê²€ì¦..."
          pnpm test --coverage --coverageThreshold='{"global":{"lines":90,"functions":90,"branches":85,"statements":90}}'

      - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage/lcov.info
          flags: auth-system
          name: auth-coverage

  # Stage 3: ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ (90% ì„ê³„ê°’)
  mutation-testing:
    name: 'ğŸ§¬ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ (90% ì„ê³„ê°’)'
    runs-on: ubuntu-latest
    timeout-minutes: 12
    needs: [fast-validation, auth-system-tests]

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: Stryker ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ì„¤ì •
        run: |
          echo "ğŸ§¬ Stryker ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ì„¤ì • ì¤‘..."

          # Stryker ì„¤ì¹˜ (ì´ë¯¸ ì„¤ì¹˜ë˜ì§€ ì•Šì€ ê²½ìš°)
          if ! pnpm list @stryker-mutator/core >/dev/null 2>&1; then
            echo "Stryker íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì¤‘..."
            pnpm add -D @stryker-mutator/core @stryker-mutator/jest-runner @stryker-mutator/typescript-checker
          fi

      - name: ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (90% ì„ê³„ê°’)
        run: |
          echo "ğŸ¯ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰ - 90% ì„ê³„ê°’ ë‹¬ì„± ëª©í‘œ..."

          # í•µì‹¬ íšŒê·€ ë°©ì§€ ì½”ë“œì— ëŒ€í•œ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸
          echo "ëŒ€ìƒ: ì¸ì¦ ì‹œìŠ¤í…œ, API í˜¸ì¶œ ë¡œì§, ì—ëŸ¬ ì²˜ë¦¬"

          # Stryker ì‹¤í–‰ (90% ì„ê³„ê°’ ì„¤ì •)
          npx stryker run --mutationScore 90 || {
            echo "âŒ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ì ìˆ˜ê°€ 90% ë¯¸ë‹¬"
            echo "í˜„ì¬ í…ŒìŠ¤íŠ¸ì˜ íš¨ê³¼ì„±ì´ ë¶€ì¡±í•©ë‹ˆë‹¤."
            echo "ë” ê°•ë ¥í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ê°€ í•„ìš”í•©ë‹ˆë‹¤."
            exit 1
          }

      - name: ë®¤í…Œì´ì…˜ ë¦¬í¬íŠ¸ ë¶„ì„
        run: |
          echo "ğŸ“Š ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„..."

          if [ -f reports/mutation/mutation.html ]; then
            echo "ë®¤í…Œì´ì…˜ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ"
            echo "ì‚´ì•„ë‚¨ì€ ë®¤í„´íŠ¸ ë¶„ì„ ì¤‘..."

            # ì‚´ì•„ë‚¨ì€ ë®¤í„´íŠ¸ê°€ ìˆëŠ”ì§€ í™•ì¸
            if grep -q "Survived" reports/mutation/mutation.html; then
              echo "âš ï¸ ì¼ë¶€ ë®¤í„´íŠ¸ê°€ ì‚´ì•„ë‚¨ì•˜ìŠµë‹ˆë‹¤."
              echo "ë” ê°•ë ¥í•œ í…ŒìŠ¤íŠ¸ ì¼€ì´ìŠ¤ ì¶”ê°€ë¥¼ ê³ ë ¤í•˜ì„¸ìš”."
            else
              echo "âœ… ëª¨ë“  ë®¤í„´íŠ¸ê°€ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤!"
            fi
          fi

      - name: ë®¤í…Œì´ì…˜ ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v3
        if: always()
        with:
          name: mutation-report
          path: reports/mutation/
          retention-days: 7

  # Stage 4: API ì•ˆì „ì„± ë° í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ë°©ì§€
  api-safety-check:
    name: 'ğŸ“Š API ì•ˆì „ì„± ë° í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ë°©ì§€'
    runs-on: ubuntu-latest
    timeout-minutes: 8
    needs: [fast-validation, auth-system-tests, mutation-testing]

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: API ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ“Š API í˜¸ì¶œ ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸..."
          pnpm test src/__tests__/utils/api-monitoring.test.ts --verbose

      - name: í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ê°ì§€
        run: |
          echo "ğŸ” í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ íŒ¨í„´ ê°ì§€..."
          # í…ŒìŠ¤íŠ¸ë¥¼ 3ë²ˆ ì‹¤í–‰í•˜ì—¬ ì¼ê´€ì„± í™•ì¸
          for i in {1..3}; do
            echo "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ $i/3..."
            pnpm test src/__tests__/auth/ --silent
          done

      - name: ì„±ëŠ¥ íšŒê·€ ê²€ì‚¬
        run: |
          echo "âš¡ ì„±ëŠ¥ íšŒê·€ ê²€ì‚¬..."
          # API ì‘ë‹µ ì‹œê°„ ì„ê³„ê°’ ê²€ì‚¬
          pnpm test --testNamePattern="ì„±ëŠ¥" --verbose

      - name: ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê²€ì‚¬
        run: |
          echo "ğŸ§  ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê²€ì‚¬..."
          node --expose-gc -e "
            const { execSync } = require('child_process');
            const initialMemory = process.memoryUsage().heapUsed;

            execSync('pnpm test src/__tests__/auth/', { stdio: 'inherit' });

            if (global.gc) global.gc();
            const finalMemory = process.memoryUsage().heapUsed;
            const leakage = finalMemory - initialMemory;

            console.log(\`ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ë³€í™”: \${leakage / 1024 / 1024}MB\`);

            if (leakage > 50 * 1024 * 1024) {
              console.error('âŒ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ê°ì§€: 50MB ì´ˆê³¼');
              process.exit(1);
            }

            console.log('âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì •ìƒ');
          "

  # Stage 5: ë³´ì•ˆ ë° ì•„í‚¤í…ì²˜ ê²€ì¦
  security-architecture:
    name: 'ğŸ›¡ï¸ ë³´ì•ˆ ë° ì•„í‚¤í…ì²˜ ê²€ì¦'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [auth-system-tests, mutation-testing, api-safety-check]

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”
        run: |
          echo "ğŸ›¡ï¸ ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº”..."
          pnpm audit --audit-level moderate

      - name: ë¯¼ê° ì •ë³´ ë…¸ì¶œ ê²€ì‚¬
        run: |
          echo "ğŸ” ë¯¼ê° ì •ë³´ ë…¸ì¶œ ê²€ì‚¬..."
          # í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸, API í‚¤ ë“± ê²€ì‚¬
          if grep -r -i "password.*=.*['\"]" src/ --exclude-dir=__tests__ | grep -v "placeholder\|example\|test\|mock"; then
            echo "âŒ í•˜ë“œì½”ë”©ëœ ë¹„ë°€ë²ˆí˜¸ ë°œê²¬"
            exit 1
          fi

          if grep -r -i "api_key.*=.*['\"]" src/ --exclude-dir=__tests__ | grep -v "placeholder\|example\|test\|mock"; then
            echo "âŒ í•˜ë“œì½”ë”©ëœ API í‚¤ ë°œê²¬"
            exit 1
          fi

          echo "âœ… ë¯¼ê° ì •ë³´ ë…¸ì¶œ ê²€ì‚¬ í†µê³¼"

      - name: FSD ì•„í‚¤í…ì²˜ ê·œì¹™ ê²€ì¦
        run: |
          echo "ğŸ—ï¸ FSD ì•„í‚¤í…ì²˜ ê·œì¹™ ê²€ì¦..."
          # ìƒí–¥ ì˜ì¡´ì„± ê²€ì‚¬ (ì˜ˆ: sharedê°€ featuresë¥¼ importí•˜ëŠ”ì§€)
          if grep -r "from.*features\|from.*widgets\|from.*pages" src/shared/; then
            echo "âŒ FSD ê·œì¹™ ìœ„ë°˜: shared ë ˆì´ì–´ê°€ ìƒìœ„ ë ˆì´ì–´ë¥¼ import"
            exit 1
          fi

          if grep -r "from.*widgets\|from.*pages" src/entities/; then
            echo "âŒ FSD ê·œì¹™ ìœ„ë°˜: entities ë ˆì´ì–´ê°€ ìƒìœ„ ë ˆì´ì–´ë¥¼ import"
            exit 1
          fi

          echo "âœ… FSD ì•„í‚¤í…ì²˜ ê·œì¹™ ì¤€ìˆ˜"

      - name: API ë³´ì•ˆ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ”’ API ë³´ì•ˆ í…ŒìŠ¤íŠ¸..."
          # SQL ì¸ì ì…˜, XSS ë“± ë³´ì•ˆ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          pnpm test --testNamePattern="ë³´ì•ˆ" --verbose

  # Stage 6: ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸
  full-integration:
    name: 'ğŸ”„ ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸'
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [security-architecture]

    steps:
      - name: ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: pnpm ì„¤ì •
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì‹¤í–‰
        env:
          INTEGRATION_TEST: 'true'
        run: |
          echo "ğŸ”„ ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ ì‹¤í–‰..."
          pnpm test --coverage --coverageThreshold='{"global":{"lines":85,"functions":90,"branches":80,"statements":85}}'

      - name: ë¹Œë“œ ê²€ì¦
        run: |
          echo "ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ ê²€ì¦..."
          pnpm run build

      - name: ë²ˆë“¤ í¬ê¸° ê²€ì‚¬
        run: |
          echo "ğŸ“¦ ë²ˆë“¤ í¬ê¸° ê²€ì‚¬..."
          # ë²ˆë“¤ í¬ê¸°ê°€ ì„ê³„ê°’ì„ ì´ˆê³¼í•˜ì§€ ì•ŠëŠ”ì§€ í™•ì¸
          npm install -g bundlesize
          npx bundlesize

  # í’ˆì§ˆ ê²Œì´íŠ¸ ìµœì¢… ê²€ì¦
  quality-gate-summary:
    name: 'âœ… í’ˆì§ˆ ê²Œì´íŠ¸ ìµœì¢… ê²€ì¦'
    runs-on: ubuntu-latest
    needs: [full-integration]
    if: always()

    steps:
      - name: í’ˆì§ˆ ê²Œì´íŠ¸ ê²°ê³¼ í™•ì¸
        run: |
          echo "ğŸ¯ í’ˆì§ˆ ê²Œì´íŠ¸ ìµœì¢… ê²€ì¦ ê²°ê³¼"
          echo "=================================="

          if [[ "${{ needs.fast-validation.result }}" == "success" ]]; then
            echo "âœ… 1ë‹¨ê³„ - ë¹ ë¥¸ ê²€ì¦ ($300 ì‚¬ê±´ íŒ¨í„´ ì°¨ë‹¨): í†µê³¼"
          else
            echo "âŒ 1ë‹¨ê³„ - ë¹ ë¥¸ ê²€ì¦ ($300 ì‚¬ê±´ íŒ¨í„´ ì°¨ë‹¨): ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.auth-system-tests.result }}" == "success" ]]; then
            echo "âœ… 2ë‹¨ê³„ - ì¸ì¦ íšŒê·€ ë°©ì§€ í…ŒìŠ¤íŠ¸: í†µê³¼"
          else
            echo "âŒ 2ë‹¨ê³„ - ì¸ì¦ íšŒê·€ ë°©ì§€ í…ŒìŠ¤íŠ¸: ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.mutation-testing.result }}" == "success" ]]; then
            echo "âœ… 3ë‹¨ê³„ - ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ (90% ì„ê³„ê°’): í†µê³¼"
          else
            echo "âŒ 3ë‹¨ê³„ - ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ (90% ì„ê³„ê°’): ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.api-safety-check.result }}" == "success" ]]; then
            echo "âœ… 4ë‹¨ê³„ - API ì•ˆì „ì„± ë° í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ë°©ì§€: í†µê³¼"
          else
            echo "âŒ 4ë‹¨ê³„ - API ì•ˆì „ì„± ë° í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ë°©ì§€: ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.security-architecture.result }}" == "success" ]]; then
            echo "âœ… 5ë‹¨ê³„ - ë³´ì•ˆ ë° ì•„í‚¤í…ì²˜ ê²€ì¦: í†µê³¼"
          else
            echo "âŒ 5ë‹¨ê³„ - ë³´ì•ˆ ë° ì•„í‚¤í…ì²˜ ê²€ì¦: ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.full-integration.result }}" == "success" ]]; then
            echo "âœ… 6ë‹¨ê³„ - ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸: í†µê³¼"
          else
            echo "âŒ 6ë‹¨ê³„ - ì „ì²´ í†µí•© í…ŒìŠ¤íŠ¸: ì‹¤íŒ¨"
          fi

          echo ""
          echo "ğŸ“Š íšŒê·€ ë°©ì§€ í…ŒìŠ¤íŠ¸ ìƒì„¸ ê²°ê³¼:"
          echo "- useEffect ë¬´í•œ ë£¨í”„ ë°©ì§€: ê²€ì¦ ì™„ë£Œ"
          echo "- /api/auth/me 401 ë£¨í”„ ë°©ì§€: ê²€ì¦ ì™„ë£Œ"
          echo "- Supabase null ì—ëŸ¬ ë°©ì§€: ê²€ì¦ ì™„ë£Œ"
          echo "- ë°ì´í„° ì¼ê´€ì„± íŠ¸ëœì­ì…˜: ê²€ì¦ ì™„ë£Œ"
          echo "- Seedance API í‚¤ ê²€ì¦: ê²€ì¦ ì™„ë£Œ"
          echo "- í™˜ê²½ë³€ìˆ˜ ì‹œë‚˜ë¦¬ì˜¤: ê²€ì¦ ì™„ë£Œ"
          echo "- ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ 90% ì„ê³„ê°’: ê²€ì¦ ì™„ë£Œ"

          # ëª¨ë“  ê²€ì‚¬ê°€ ì„±ê³µí–ˆëŠ”ì§€ í™•ì¸
          if [[ "${{ needs.fast-validation.result }}" == "success" &&
                "${{ needs.auth-system-tests.result }}" == "success" &&
                "${{ needs.mutation-testing.result }}" == "success" &&
                "${{ needs.api-safety-check.result }}" == "success" &&
                "${{ needs.security-architecture.result }}" == "success" &&
                "${{ needs.full-integration.result }}" == "success" ]]; then
            echo ""
            echo "ğŸ‰ ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼! PR ë³‘í•© ìŠ¹ì¸"
            echo "ğŸ’° $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì‹œìŠ¤í…œ ê²€ì¦ ì™„ë£Œ"
            echo "ğŸ”’ ì¸ì¦ ì‹œìŠ¤í…œ ì•ˆì „ì„± 100% ë³´ì¥"
            echo "ğŸ§¬ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ 90% ì„ê³„ê°’ ë‹¬ì„±"
            echo "ğŸ“Š íšŒê·€ ë°©ì§€ í…ŒìŠ¤íŠ¸ ì „ì²´ í†µê³¼"
          else
            echo ""
            echo "ğŸš¨ í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤íŒ¨! PR ë³‘í•© ì°¨ë‹¨"
            echo "ğŸ’¥ $300 ì‚¬ê±´ ì¬ë°œ ìœ„í—˜ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤!"
            echo "ì‹¤íŒ¨í•œ ê²€ì‚¬ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
            exit 1
          fi

      - name: Slack ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#alerts-critical'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          fields: repo,message,commit,author,action,eventName,ref,workflow
          text: |
            ğŸš¨ í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤íŒ¨!
            $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ë¥¼ ìœ„í•œ ì¸ì¦ ì‹œìŠ¤í…œ ê²€ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
            ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.

      - name: Slack ì•Œë¦¼ (ì„±ê³µ ì‹œ)
        if: success()
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#ci-success'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: |
            âœ… í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼!
            ì¸ì¦ ì‹œìŠ¤í…œ ì•ˆì „ì„±ì´ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤. PR ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤.