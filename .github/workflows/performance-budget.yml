name: Performance Budget Check

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  performance-budget:
    name: Performance Budget Validation
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Get pnpm store directory
        shell: bash
        run: echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build
        env:
          NODE_ENV: production

      - name: Check bundle size
        run: node scripts/performance-budget-check.js --bundle

      - name: Setup Lighthouse CI
        run: |
          pnpm add -D @lhci/cli@0.12.x
          mkdir -p .lighthouseci

      - name: Start application for testing
        run: |
          pnpm start &
          echo $! > .server_pid
          # Wait for server to be ready
          npx wait-on http://localhost:3000 --timeout 60000
        env:
          NODE_ENV: production

      - name: Run Lighthouse CI
        run: |
          npx lhci autorun --config=lighthouserc.js
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Check Lighthouse results
        run: node scripts/performance-budget-check.js --lighthouse

      - name: Check API performance
        run: node scripts/performance-budget-check.js --api
        env:
          TEST_URL: http://localhost:3000

      - name: Stop application
        if: always()
        run: |
          if [ -f .server_pid ]; then
            kill $(cat .server_pid) || true
            rm .server_pid
          fi

      - name: Upload Lighthouse artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 7

      - name: Comment PR with performance results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Lighthouse Í≤∞Í≥º ÏùΩÍ∏∞
            const resultsDir = '.lighthouseci';
            let comment = '## üéØ Performance Budget Check Results\n\n';
            
            try {
              const lhciDir = fs.readdirSync(resultsDir).find(dir => dir.startsWith('lhr-'));
              if (lhciDir) {
                const resultFiles = fs.readdirSync(path.join(resultsDir, lhciDir))
                  .filter(file => file.endsWith('.json'));
                
                if (resultFiles.length > 0) {
                  const result = JSON.parse(
                    fs.readFileSync(path.join(resultsDir, lhciDir, resultFiles[0]), 'utf8')
                  );
                  
                  const scores = {
                    Performance: Math.round(result.categories.performance.score * 100),
                    Accessibility: Math.round(result.categories.accessibility.score * 100),
                    'Best Practices': Math.round(result.categories['best-practices'].score * 100),
                    SEO: Math.round(result.categories.seo.score * 100)
                  };
                  
                  comment += '### Lighthouse Scores\n\n';
                  comment += '| Category | Score | Status |\n';
                  comment += '|----------|--------|--------|\n';
                  
                  for (const [category, score] of Object.entries(scores)) {
                    const status = score >= 90 ? '‚úÖ' : score >= 70 ? '‚ö†Ô∏è' : '‚ùå';
                    comment += `| ${category} | ${score}/100 | ${status} |\n`;
                  }
                  
                  // Core Web Vitals
                  const cwv = {
                    LCP: Math.round(result.audits['largest-contentful-paint']?.numericValue || 0),
                    INP: Math.round(result.audits['interaction-to-next-paint']?.numericValue || 0),
                    CLS: (result.audits['cumulative-layout-shift']?.numericValue || 0).toFixed(3)
                  };
                  
                  comment += '\n### Core Web Vitals\n\n';
                  comment += '| Metric | Value | Budget | Status |\n';
                  comment += '|--------|--------|--------|---------|\n';
                  
                  const budgets = { LCP: 2500, INP: 200, CLS: 0.1 };
                  for (const [metric, value] of Object.entries(cwv)) {
                    const budget = budgets[metric];
                    const numValue = parseFloat(value);
                    const status = numValue <= budget ? '‚úÖ' : '‚ùå';
                    const unit = metric === 'CLS' ? '' : 'ms';
                    const budgetUnit = metric === 'CLS' ? '' : 'ms';
                    comment += `| ${metric} | ${value}${unit} | ${budget}${budgetUnit} | ${status} |\n`;
                  }
                }
              }
            } catch (error) {
              comment += '‚ö†Ô∏è Could not parse Lighthouse results\n';
            }
            
            comment += '\n---\n';
            comment += '*Performance budget check completed. See [action logs](' + 
              process.env.GITHUB_SERVER_URL + '/' + process.env.GITHUB_REPOSITORY + 
              '/actions/runs/' + process.env.GITHUB_RUN_ID + ') for detailed results.*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  lighthouse-comparison:
    name: Lighthouse Performance Comparison
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build and test PR
        run: |
          pnpm build
          pnpm start &
          echo $! > .server_pid
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Lighthouse on PR
        run: |
          pnpm add -D @lhci/cli@0.12.x
          npx lhci autorun --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Stop PR server
        if: always()
        run: |
          if [ -f .server_pid ]; then
            kill $(cat .server_pid) || true
            rm .server_pid
          fi

      - name: Checkout base branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.base_ref }}

      - name: Build and test base
        run: |
          pnpm install --frozen-lockfile
          pnpm build
          pnpm start &
          echo $! > .server_pid_base
          npx wait-on http://localhost:3000 --timeout 60000

      - name: Run Lighthouse on base
        run: |
          npx lhci autorun --upload.target=temporary-public-storage
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}

      - name: Stop base server
        if: always()
        run: |
          if [ -f .server_pid_base ]; then
            kill $(cat .server_pid_base) || true
            rm .server_pid_base
          fi

  bundle-analysis:
    name: Bundle Size Analysis
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build application
        run: pnpm build

      - name: Analyze bundle
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            function getDirectorySize(dir) {
              let size = 0;
              const files = fs.readdirSync(dir);
              
              for (const file of files) {
                const filePath = path.join(dir, file);
                const stat = fs.statSync(filePath);
                
                if (stat.isDirectory()) {
                  size += getDirectorySize(filePath);
                } else {
                  size += stat.size;
                }
              }
              
              return size;
            }
            
            function formatSize(bytes) {
              const kb = bytes / 1024;
              const mb = kb / 1024;
              return mb >= 1 ? `${mb.toFixed(2)} MB` : `${kb.toFixed(2)} KB`;
            }
            
            const staticDir = '.next/static';
            if (!fs.existsSync(staticDir)) {
              console.log('No build artifacts found');
              return;
            }
            
            const jsSize = getDirectorySize(path.join(staticDir, 'chunks')) || 0;
            const cssSize = getDirectorySize(path.join(staticDir, 'css')) || 0;
            const totalSize = jsSize + cssSize;
            
            const comment = `## üì¶ Bundle Size Analysis
            
            | Asset Type | Size | Budget | Status |
            |-----------|------|---------|---------|
            | JavaScript | ${formatSize(jsSize)} | 1.00 MB | ${jsSize <= 1024*1024 ? '‚úÖ' : '‚ùå'} |
            | CSS | ${formatSize(cssSize)} | 256.00 KB | ${cssSize <= 256*1024 ? '‚úÖ' : '‚ùå'} |
            | **Total** | **${formatSize(totalSize)}** | **2.00 MB** | **${totalSize <= 2*1024*1024 ? '‚úÖ' : '‚ùå'}** |
            
            ${totalSize > 2*1024*1024 ? '‚ö†Ô∏è Bundle size exceeds budget. Consider code splitting or removing unused dependencies.' : '‚úÖ Bundle size is within budget.'}
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });