name: 03. Performance & Quality
# í†µí•©ëœ ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ë° í’ˆì§ˆ ë³´ì¦ íŒŒì´í”„ë¼ì¸

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize]
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ ì„±ëŠ¥ ë² ì´ìŠ¤ë¼ì¸ ì²´í¬
    - cron: '0 9 * * *'
  workflow_dispatch:
    inputs:
      performance_mode:
        description: 'Performance test mode'
        required: false
        default: 'standard'
        type: choice
        options:
          - 'standard'
          - 'comprehensive'
          - 'stress'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  LIGHTHOUSE_CI_BUILD_PATH: '.next'

# ë™ì‹œ ì‹¤í–‰ ì œí•œ
concurrency:
  group: performance-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ğŸ“Š Stage 1: ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦
  performance-budget-check:
    name: 'âš¡ Performance Budget Check'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ë²ˆë“¤ ì‚¬ì´ì¦ˆ ë¶„ì„
      - name: Bundle Size Analysis
        run: |
          echo "ğŸ“± ë²ˆë“¤ í¬ê¸° ë¶„ì„..."

          pnpm build

          # ë²ˆë“¤ í¬ê¸° ì²´í¬
          MAIN_BUNDLE_SIZE=$(du -b .next/static/chunks/pages/_app-*.js 2>/dev/null | cut -f1 | head -1 || echo "0")
          MAX_BUNDLE_SIZE=500000  # 500KB

          echo "ë©”ì¸ ë²ˆë“¤ í¬ê¸°: $MAIN_BUNDLE_SIZE bytes"
          echo "ìµœëŒ€ í—ˆìš© í¬ê¸°: $MAX_BUNDLE_SIZE bytes"

          if [ "$MAIN_BUNDLE_SIZE" -gt "$MAX_BUNDLE_SIZE" ]; then
            echo "âŒ ë²ˆë“¤ í¬ê¸°ê°€ ì˜ˆì‚°ì„ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!"
            echo "ì´ˆê³¼ëŸ‰: $(( MAIN_BUNDLE_SIZE - MAX_BUNDLE_SIZE )) bytes"
            exit 1
          fi

          echo "âœ… ë²ˆë“¤ í¬ê¸° ì˜ˆì‚° í†µê³¼"

      # Core Web Vitals ì²´í¬
      - name: Core Web Vitals Check
        run: |
          echo "âš¡ Core Web Vitals ì²´í¬..."

          # Lighthouse CI ì„¤ì •
          echo '{
            "ci": {
              "collect": {
                "startServerCommand": "pnpm start",
                "startServerReadyPattern": "ready",
                "url": ["http://localhost:3000"]
              },
              "assert": {
                "assertions": {
                  "categories:performance": ["error", {"minScore": 0.9}],
                  "categories:accessibility": ["error", {"minScore": 0.9}],
                  "categories:best-practices": ["error", {"minScore": 0.9}],
                  "categories:seo": ["error", {"minScore": 0.9}]
                }
              }
            }
          }' > lighthouserc.json

          # Lighthouse CI ì‹¤í–‰
          npx @lhci/cli@0.12.x autorun || {
            echo "âŒ Lighthouse ì„±ëŠ¥ ê¸°ì¤€ ë¯¸ë‹¬!"
            exit 1
          }

      # ì„±ëŠ¥ íšŒê·€ ê²€ì‚¬
      - name: Performance Regression Check
        run: |
          echo "ğŸ“ˆ ì„±ëŠ¥ íšŒê·€ ê²€ì‚¬..."

          # ì´ì „ ë¹Œë“œì™€ ë¹„êµ (ë² ì´ìŠ¤ ë¸Œëœì¹˜)
          git checkout ${{ github.base_ref }}
          pnpm install --frozen-lockfile
          pnpm build

          # í˜„ì¬ ë²ˆë“¤ í¬ê¸° ì €ì¥
          BASE_SIZE=$(du -sb .next | cut -f1)

          # PR ë¸Œëœì¹˜ë¡œ ëŒì•„ê°€ê¸°
          git checkout ${{ github.sha }}
          pnpm install --frozen-lockfile
          pnpm build

          # PR ë²ˆë“¤ í¬ê¸°
          PR_SIZE=$(du -sb .next | cut -f1)

          # íšŒê·€ ê²€ì‚¬ (10% ì´ìƒ ì¦ê°€ ì‹œ ì‹¤íŒ¨)
          REGRESSION_THRESHOLD=$(echo "$BASE_SIZE * 1.1" | bc)

          echo "ë² ì´ìŠ¤ ë¹Œë“œ í¬ê¸°: $BASE_SIZE bytes"
          echo "PR ë¹Œë“œ í¬ê¸°: $PR_SIZE bytes"
          echo "íšŒê·€ ì„ê³„ê°’: $REGRESSION_THRESHOLD bytes"

          if (( $(echo "$PR_SIZE > $REGRESSION_THRESHOLD" | bc -l) )); then
            INCREASE_PERCENT=$(echo "scale=2; ($PR_SIZE - $BASE_SIZE) * 100 / $BASE_SIZE" | bc)
            echo "âŒ ì„±ëŠ¥ íšŒê·€ ê°ì§€! ë¹Œë“œ í¬ê¸°ê°€ ${INCREASE_PERCENT}% ì¦ê°€í–ˆìŠµë‹ˆë‹¤."
            exit 1
          fi

          echo "âœ… ì„±ëŠ¥ íšŒê·€ ì—†ìŒ"

  # ğŸ§ª Stage 2: ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ í’ˆì§ˆ
  mutation-testing:
    name: 'ğŸ§¬ Mutation Testing & Code Quality'
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ì²´í¬
      - name: Test Coverage Analysis
        run: |
          echo "ğŸ“Š í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ë¶„ì„..."

          pnpm test:coverage

          # ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ì²´í¬
          COVERAGE=$(npm run test:coverage:report -- --reporter=text-summary | grep "Lines" | grep -oP '\d+(?=\.\d+%)' | head -1)
          MIN_COVERAGE=85

          echo "í˜„ì¬ ì»¤ë²„ë¦¬ì§€: ${COVERAGE}%"
          echo "ìµœì†Œ ìš”êµ¬ ì»¤ë²„ë¦¬ì§€: ${MIN_COVERAGE}%"

          if [ "$COVERAGE" -lt "$MIN_COVERAGE" ]; then
            echo "âŒ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ê°€ ê¸°ì¤€ì— ë¯¸ë‹¬í•©ë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€ í†µê³¼"

      # ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸
      - name: Mutation Testing with Stryker
        run: |
          echo "ğŸ§¬ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."

          # Stryker ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸
          if command -v stryker &> /dev/null; then
            pnpm run test:mutation || {
              echo "âŒ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
              echo "í…ŒìŠ¤íŠ¸ì˜ í’ˆì§ˆì„ ê°œì„ í•´ì•¼ í•©ë‹ˆë‹¤."
              exit 1
            }
          else
            echo "âš ï¸ Stryker ë¯¸ì„¤ì¹˜ - ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ê±´ë„ˆëœ€"
          fi

      # ì½”ë“œ ë³µì¡ë„ ë¶„ì„
      - name: Code Complexity Analysis
        run: |
          echo "ğŸ” ì½”ë“œ ë³µì¡ë„ ë¶„ì„..."

          # ESLint complexity ê·œì¹™
          pnpm lint:complexity || {
            echo "âŒ ì½”ë“œ ë³µì¡ë„ê°€ ê¸°ì¤€ì„ ì´ˆê³¼í•©ë‹ˆë‹¤!"
            exit 1
          }

          echo "âœ… ì½”ë“œ ë³µì¡ë„ ê¸°ì¤€ í†µê³¼"

  # ğŸš€ Stage 3: ì¢…í•© ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ (ìŠ¤ì¼€ì¤„/ìˆ˜ë™ ì‹¤í–‰)
  comprehensive-performance-test:
    name: 'ğŸš€ Comprehensive Performance Test'
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    timeout-minutes: 45

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ì „ì²´ ë¹Œë“œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸
      - name: Build Performance Test
        run: |
          echo "ğŸ—ï¸ ë¹Œë“œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸..."

          start_time=$(date +%s)
          pnpm build
          end_time=$(date +%s)

          build_duration=$((end_time - start_time))
          max_build_time=300  # 5ë¶„

          echo "ë¹Œë“œ ì‹œê°„: ${build_duration}ì´ˆ"
          echo "ìµœëŒ€ í—ˆìš© ì‹œê°„: ${max_build_time}ì´ˆ"

          if [ "$build_duration" -gt "$max_build_time" ]; then
            echo "âŒ ë¹Œë“œ ì‹œê°„ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… ë¹Œë“œ ì„±ëŠ¥ ê¸°ì¤€ í†µê³¼"

      # ë¡œë“œ í…ŒìŠ¤íŠ¸ (ê°€ë²¼ìš´)
      - name: Load Testing
        run: |
          echo "âš¡ ë¡œë“œ í…ŒìŠ¤íŠ¸..."

          # ì„œë²„ ì‹œì‘
          pnpm start &
          SERVER_PID=$!

          # ì„œë²„ ì¤€ë¹„ ëŒ€ê¸°
          sleep 30

          # ApacheBenchë¡œ ë¡œë“œ í…ŒìŠ¤íŠ¸
          if command -v ab &> /dev/null; then
            ab -n 100 -c 10 http://localhost:3000/ || {
              echo "âŒ ë¡œë“œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
              kill $SERVER_PID
              exit 1
            }
          else
            echo "âš ï¸ ApacheBench ë¯¸ì„¤ì¹˜ - ë¡œë“œ í…ŒìŠ¤íŠ¸ ê±´ë„ˆëœ€"
          fi

          # ì„œë²„ ì¢…ë£Œ
          kill $SERVER_PID

          echo "âœ… ë¡œë“œ í…ŒìŠ¤íŠ¸ í†µê³¼"

      # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í”„ë¡œíŒŒì¼ë§
      - name: Memory Usage Profiling
        run: |
          echo "ğŸ’¾ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í”„ë¡œíŒŒì¼ë§..."

          # ë¹Œë“œ ì‹œ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì²´í¬
          /usr/bin/time -v pnpm build 2>&1 | grep "Maximum resident set size" | grep -oP '\d+' > memory_usage.txt

          MEMORY_KB=$(cat memory_usage.txt)
          MEMORY_MB=$((MEMORY_KB / 1024))
          MAX_MEMORY_MB=2048  # 2GB

          echo "ìµœëŒ€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰: ${MEMORY_MB}MB"
          echo "í—ˆìš© í•œë„: ${MAX_MEMORY_MB}MB"

          if [ "$MEMORY_MB" -gt "$MAX_MEMORY_MB" ]; then
            echo "âŒ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ì´ í•œë„ë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ ì •ìƒ"

  # ğŸ¯ Stage 4: ì„±ëŠ¥ ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸
  performance-baseline-update:
    name: 'ğŸ“Š Performance Baseline Update'
    runs-on: ubuntu-latest
    needs: [performance-budget-check, mutation-testing, comprehensive-performance-test]
    if: always() && github.event_name == 'schedule'
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # í˜„ì¬ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      - name: Collect Performance Metrics
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘..."

          pnpm build

          # ë²ˆë“¤ í¬ê¸°
          BUNDLE_SIZE=$(du -sb .next | cut -f1)

          # íŒŒì¼ ìˆ˜
          FILE_COUNT=$(find .next -type f | wc -l)

          # ë©”íŠ¸ë¦­ ì €ì¥
          echo "bundle_size:$BUNDLE_SIZE" > performance_metrics.txt
          echo "file_count:$FILE_COUNT" >> performance_metrics.txt
          echo "timestamp:$(date +%s)" >> performance_metrics.txt

          cat performance_metrics.txt

      # ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸ (Gitìœ¼ë¡œ ì €ì¥)
      - name: Update Performance Baseline
        run: |
          echo "ğŸ“ˆ ì„±ëŠ¥ ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸..."

          # ì„±ëŠ¥ íˆìŠ¤í† ë¦¬ ë””ë ‰í† ë¦¬ ìƒì„±
          mkdir -p .github/performance-history

          # íƒ€ì„ìŠ¤íƒ¬í”„ íŒŒì¼ëª…ìœ¼ë¡œ ì €ì¥
          cp performance_metrics.txt .github/performance-history/$(date +%Y-%m-%d).txt

          # Git ì»¤ë°‹ (ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸)
          git config user.name "Performance Bot"
          git config user.email "performance@videoprompt.com"

          git add .github/performance-history/
          git commit -m "chore: update performance baseline $(date +%Y-%m-%d)" || echo "ë² ì´ìŠ¤ë¼ì¸ ë³€ê²½ ì‚¬í•­ ì—†ìŒ"

  # ğŸ“Š ê²°ê³¼ ìš”ì•½ ë° ë³´ê³ 
  performance-quality-summary:
    name: 'ğŸ“Š Performance & Quality Summary'
    runs-on: ubuntu-latest
    needs: [performance-budget-check, mutation-testing, comprehensive-performance-test]
    if: always()

    steps:
      - name: Performance Quality Results Summary
        run: |
          echo "ğŸ“Š ì„±ëŠ¥ ë° í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ ìš”ì•½"
          echo "======================================"

          if [[ "${{ needs.performance-budget-check.result }}" == "success" ]]; then
            echo "âœ… ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦: í†µê³¼"
          elif [[ "${{ needs.performance-budget-check.result }}" == "skipped" ]]; then
            echo "â¸ï¸ ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦: ê±´ë„ˆëœ€"
          else
            echo "âŒ ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦: ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.mutation-testing.result }}" == "success" ]]; then
            echo "âœ… ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸: í†µê³¼"
          elif [[ "${{ needs.mutation-testing.result }}" == "skipped" ]]; then
            echo "â¸ï¸ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸: ê±´ë„ˆëœ€"
          else
            echo "âŒ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸: ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.comprehensive-performance-test.result }}" == "success" ]]; then
            echo "âœ… ì¢…í•© ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: í†µê³¼"
          elif [[ "${{ needs.comprehensive-performance-test.result }}" == "skipped" ]]; then
            echo "â¸ï¸ ì¢…í•© ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ê±´ë„ˆëœ€"
          else
            echo "âŒ ì¢…í•© ì„±ëŠ¥ í…ŒìŠ¤íŠ¸: ì‹¤íŒ¨"
          fi

      # ì„±ëŠ¥ ì‹¤íŒ¨ ì•Œë¦¼
      - name: Performance Failure Notification
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#alerts-performance'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: |
            âš¡ ì„±ëŠ¥ ë° í’ˆì§ˆ ê²€ì‚¬ ì‹¤íŒ¨!
            PR: ${{ github.event.pull_request.html_url }}
            ì„±ëŠ¥ íšŒê·€ ë˜ëŠ” í’ˆì§ˆ ì €í•˜ê°€ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.

      # ì„±ëŠ¥ ì„±ê³µ ì•Œë¦¼ (ë² ì´ìŠ¤ë¼ì¸ ì—…ë°ì´íŠ¸ ì‹œ)
      - name: Performance Success Notification
        if: success() && github.event_name == 'schedule'
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#performance-reports'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: |
            ğŸ“Š ì¼ì¼ ì„±ëŠ¥ ì²´í¬ ì™„ë£Œ!
            ëª¨ë“  ì„±ëŠ¥ ë©”íŠ¸ë¦­ì´ ì •ìƒ ë²”ìœ„ ë‚´ì— ìˆìŠµë‹ˆë‹¤.
            ë² ì´ìŠ¤ë¼ì¸ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.