name: Grace QA ë¬´ê´€ìš© í’ˆì§ˆ ê²Œì´íŠ¸

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

env:
  NODE_VERSION: '18'
  PNPM_VERSION: '8'

jobs:
  # Grace 1ë‹¨ê³„: ë¹ ë¥¸ ì‹¤íŒ¨ ì²´í¬ (3ë¶„ ì´ë‚´)
  grace-quick-gates:
    name: 'ğŸš¨ Grace ê¸´ê¸‰ ì²´í¬ (3ë¶„ ë‚´ ì‹¤íŒ¨ì‹œ ì¦‰ì‹œ ì°¨ë‹¨)'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      cost-risk: ${{ steps.cost-check.outputs.risk-detected }}
      fsd-violations: ${{ steps.fsd-check.outputs.violations }}
      flaky-tests: ${{ steps.flaky-check.outputs.detected }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Grace Priority 1: $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ (ìµœìš°ì„ )
      - name: ğŸš¨ $300 ì‚¬ê±´ ë°©ì§€ ê²€ì‚¬
        id: cost-check
        run: |
          echo "=== Grace QA: $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì‹œìŠ¤í…œ ==="

          # 1. ë¹„ìš© ë°©ì§€ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          pnpm test src/__tests__/quality-gates/cost-prevention.test.ts --reporter=verbose

          # 2. ì‹¤ì‹œê°„ ì½”ë“œ ìŠ¤ìº”
          pnpm test src/__tests__/quality-gates/zero-tolerance-300-prevention.test.ts --reporter=verbose

          # 3. ìœ„í—˜ íŒ¨í„´ ê°ì§€
          RISK_DETECTED=$(pnpm test --reporter=json | grep -o '"numFailedTests":[0-9]*' | cut -d':' -f2)

          if [ "$RISK_DETECTED" != "0" ]; then
            echo "ğŸš¨ CRITICAL: $300 ìœ„í—˜ íŒ¨í„´ ê°ì§€!"
            echo "risk-detected=true" >> $GITHUB_OUTPUT
            exit 1
          else
            echo "âœ… $300 ì‚¬ê±´ ë°©ì§€ ì‹œìŠ¤í…œ í†µê³¼"
            echo "risk-detected=false" >> $GITHUB_OUTPUT
          fi

      # Grace Priority 2: í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ 0% í—ˆìš©
      - name: ğŸ¯ í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ê°ì§€ (3íšŒ ì—°ì† ì‹¤í–‰)
        id: flaky-check
        run: |
          echo "=== Grace QA: í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ 0% í—ˆìš© ì‹œìŠ¤í…œ ==="

          # í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ê°ì§€ê¸° ì‹¤í–‰
          pnpm test src/__tests__/quality-gates/anti-flaky-test-system.test.ts --reporter=verbose

          # 3íšŒ ì—°ì† í•µì‹¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          for i in {1..3}; do
            echo "í”Œë˜í‚¤ ê²€ì¦ ì‹¤í–‰ $i/3..."
            if ! pnpm test src/__tests__/auth/ --reporter=json --silent; then
              echo "ğŸš¨ CRITICAL: í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ê°ì§€ - ì‹¤í–‰ $iì—ì„œ ì‹¤íŒ¨!"
              echo "detected=true" >> $GITHUB_OUTPUT
              exit 1
            fi
            sleep 2
          done

          echo "âœ… í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ê²€ì‚¬ í†µê³¼"
          echo "detected=false" >> $GITHUB_OUTPUT

      # Grace Priority 3: FSD ì•„í‚¤í…ì²˜ ê°•ì œ
      - name: ğŸ—ï¸ FSD ì•„í‚¤í…ì²˜ ìœ„ë°˜ ê²€ì‚¬
        id: fsd-check
        run: |
          echo "=== Grace QA: FSD ì•„í‚¤í…ì²˜ ë¬´ê´€ìš© ê°•ì œ ==="

          # FSD ìœ„ë°˜ ê°ì§€ê¸° ì‹¤í–‰
          pnpm test src/__tests__/quality-gates/fsd-architecture-enforcer.test.ts --reporter=verbose

          # ESLint FSD ê·œì¹™ ì‹¤í–‰
          if ! pnpm lint; then
            echo "ğŸš¨ CRITICAL: FSD ì•„í‚¤í…ì²˜ ìœ„ë°˜!"
            echo "violations=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          echo "âœ… FSD ì•„í‚¤í…ì²˜ ê²€ì‚¬ í†µê³¼"
          echo "violations=false" >> $GITHUB_OUTPUT

      # ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì•Œë¦¼
      - name: ğŸš¨ Grace ê¸´ê¸‰ ì°¨ë‹¨ ì•Œë¦¼
        if: failure()
        run: |
          echo "::error::ğŸš¨ Grace QA ë¬´ê´€ìš© ì •ì±…: ë¹ ë¥¸ ì‹¤íŒ¨ ê²Œì´íŠ¸ì—ì„œ ì°¨ë‹¨ë¨!"
          echo "::error::ë¹„ìš© ìœ„í—˜: ${{ steps.cost-check.outputs.risk-detected }}"
          echo "::error::í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸: ${{ steps.flaky-check.outputs.detected }}"
          echo "::error::FSD ìœ„ë°˜: ${{ steps.fsd-check.outputs.violations }}"
          echo "::error::ì¦‰ì‹œ ìˆ˜ì • í›„ ì¬ì‹œë„í•˜ì„¸ìš”."

  # Grace 2ë‹¨ê³„: ì™„ì „ í’ˆì§ˆ ê²€ì¦ (10ë¶„ ì´ë‚´)
  grace-comprehensive-gates:
    name: 'ğŸ”¬ Grace ì™„ì „ í’ˆì§ˆ ê²€ì¦'
    runs-on: ubuntu-latest
    needs: grace-quick-gates
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # íŒŒì´í”„ë¼ì¸ í†µí•© í…ŒìŠ¤íŠ¸
      - name: ğŸ”— íŒŒì´í”„ë¼ì¸ í†µí•© í…ŒìŠ¤íŠ¸
        run: |
          echo "=== Grace QA: í•µì‹¬ íŒŒì´í”„ë¼ì¸ í†µí•© ê²€ì¦ ==="
          pnpm test src/__tests__/tdd/pipeline-integration-red-green-refactor.test.ts --reporter=verbose

          # í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          INTEGRATION_TEST=true pnpm test src/__tests__/integration/ --reporter=verbose

      # API ê³„ì•½ ê²€ì¦
      - name: ğŸ“‹ API ê³„ì•½ íšŒê·€ ë°©ì§€ ê²€ì‚¬
        run: |
          echo "=== Grace QA: API ê³„ì•½ ë¶ˆì¼ì¹˜ ë°©ì§€ ==="
          pnpm test src/__tests__/quality-gates/api-contract-regression-prevention.test.ts --reporter=verbose

      # ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ (ì»¤ë²„ë¦¬ì§€ í¬í•¨)
      - name: ğŸ§ª ì „ì²´ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ + ì»¤ë²„ë¦¬ì§€
        run: |
          echo "=== Grace QA: ì „ì²´ í…ŒìŠ¤íŠ¸ ê²€ì¦ ==="
          INTEGRATION_TEST=true pnpm test --coverage --reporter=verbose

          # ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’ ê²€ì¦ (Grace ê¸°ì¤€: 85% ì´ìƒ)
          COVERAGE_THRESHOLD=85
          LINES_COVERAGE=$(node -e "
            const fs = require('fs');
            try {
              const coverage = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
              console.log(coverage.total.lines.pct);
            } catch(e) {
              console.log('0');
            }
          ")

          echo "í˜„ì¬ ì»¤ë²„ë¦¬ì§€: ${LINES_COVERAGE}%"

          if (( $(echo "$LINES_COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
            echo "ğŸš¨ CRITICAL: ì»¤ë²„ë¦¬ì§€ ${LINES_COVERAGE}% < ${COVERAGE_THRESHOLD}% (Grace ê¸°ì¤€ ë¯¸ë‹¬)"
            exit 1
          fi

          echo "âœ… ì»¤ë²„ë¦¬ì§€ ${LINES_COVERAGE}% >= ${COVERAGE_THRESHOLD}% í†µê³¼"

      # íƒ€ì… ê²€ì‚¬ ë° ë¹Œë“œ ê²€ì¦
      - name: ğŸ”§ íƒ€ì… ê²€ì‚¬ & ë¹Œë“œ ê²€ì¦
        run: |
          echo "=== Grace QA: íƒ€ì… ì•ˆì •ì„± & ë¹Œë“œ ê²€ì¦ ==="

          # TypeScript íƒ€ì… ê²€ì‚¬
          pnpm run type-check

          # í”„ë¡œë•ì…˜ ë¹Œë“œ
          pnpm run build

          echo "âœ… íƒ€ì… ê²€ì‚¬ ë° ë¹Œë“œ í†µê³¼"

      # ì„±ëŠ¥ ë° ë³´ì•ˆ ê²€ì‚¬
      - name: âš¡ ì„±ëŠ¥ & ë³´ì•ˆ ê²€ì‚¬
        run: |
          echo "=== Grace QA: ì„±ëŠ¥ & ë³´ì•ˆ ê²€ì¦ ==="

          # ì˜ì¡´ì„± ì·¨ì•½ì  ê²€ì‚¬
          pnpm audit --audit-level moderate

          # ì„±ëŠ¥ íšŒê·€ í…ŒìŠ¤íŠ¸
          pnpm test src/__tests__/performance/ --reporter=verbose

          echo "âœ… ì„±ëŠ¥ & ë³´ì•ˆ ê²€ì‚¬ í†µê³¼"

  # Grace 3ë‹¨ê³„: Mutation Testing (ì£¼ë§/ì•¼ê°„ë§Œ)
  grace-mutation-testing:
    name: 'ğŸ§¬ Grace Mutation Testing (80% ê¸°ì¤€)'
    runs-on: ubuntu-latest
    needs: grace-comprehensive-gates
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Mutation Score ê²€ì¦
      - name: ğŸ§¬ Mutation Testing ì‹¤í–‰
        run: |
          echo "=== Grace QA: Mutation Score 80% ìµœì†Œ ê¸°ì¤€ ==="

          # Mutation Testing ê²€ì¦ê¸° ë¨¼ì € ì‹¤í–‰
          pnpm test src/__tests__/quality-gates/mutation-score-enforcer.test.ts --reporter=verbose

          # ì‹¤ì œ Stryker Mutation Testing ì‹¤í–‰ (í•µì‹¬ íŒŒì¼ë§Œ)
          npx stryker run --configFile stryker-critical.conf.mjs

          # Mutation Score ê²€ì¦
          MUTATION_SCORE=$(node -e "
            const fs = require('fs');
            try {
              const report = JSON.parse(fs.readFileSync('reports/mutation/mutation-report.json', 'utf8'));
              console.log(Math.round(report.mutationScore || 0));
            } catch(e) {
              console.log('0');
            }
          ")

          echo "í˜„ì¬ Mutation Score: ${MUTATION_SCORE}%"

          if [ "$MUTATION_SCORE" -lt 80 ]; then
            echo "ğŸš¨ CRITICAL: Mutation Score ${MUTATION_SCORE}% < 80% (Grace ê¸°ì¤€ ë¯¸ë‹¬)"
            echo "ìƒì¡´í•œ ë®¤í„´íŠ¸ë¥¼ ë¶„ì„í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ ê°œì„ í•˜ì„¸ìš”."
            exit 1
          fi

          echo "âœ… Mutation Testing ${MUTATION_SCORE}% >= 80% í†µê³¼"

      # Mutation ë³´ê³ ì„œ ì—…ë¡œë“œ
      - name: ğŸ“Š Mutation Testing ë³´ê³ ì„œ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: mutation-testing-report
          path: reports/mutation/
          retention-days: 30

  # Grace ìµœì¢… ë‹¨ê³„: ë°°í¬ ìŠ¹ì¸
  grace-deployment-approval:
    name: 'âœ… Grace QA ìµœì¢… ìŠ¹ì¸'
    runs-on: ubuntu-latest
    needs: [grace-quick-gates, grace-comprehensive-gates]
    if: always()

    steps:
      - name: ğŸ¯ Grace QA ìµœì¢… íŒì •
        run: |
          echo "=== Grace QA ë¬´ê´€ìš© í’ˆì§ˆ ê²Œì´íŠ¸ ìµœì¢… ê²°ê³¼ ==="

          # ëª¨ë“  ì´ì „ job ê²°ê³¼ í™•ì¸
          QUICK_GATES="${{ needs.grace-quick-gates.result }}"
          COMPREHENSIVE_GATES="${{ needs.grace-comprehensive-gates.result }}"

          echo "ë¹ ë¥¸ ê²Œì´íŠ¸: $QUICK_GATES"
          echo "ì™„ì „ ê²Œì´íŠ¸: $COMPREHENSIVE_GATES"

          if [ "$QUICK_GATES" != "success" ] || [ "$COMPREHENSIVE_GATES" != "success" ]; then
            echo "ğŸš¨ Grace QA ë¬´ê´€ìš© ì •ì±…: í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤íŒ¨!"
            echo ""
            echo "ì‹¤íŒ¨ ì‚¬ìœ :"
            echo "- ë¹„ìš© ìœ„í—˜: ${{ needs.grace-quick-gates.outputs.cost-risk }}"
            echo "- í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸: ${{ needs.grace-quick-gates.outputs.flaky-tests }}"
            echo "- FSD ìœ„ë°˜: ${{ needs.grace-quick-gates.outputs.fsd-violations }}"
            echo ""
            echo "ğŸ”§ ì¡°ì¹˜ ì‚¬í•­:"
            echo "1. ëª¨ë“  í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí•  ë•Œê¹Œì§€ ë°°í¬ ì°¨ë‹¨"
            echo "2. $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì‹œìŠ¤í…œ ê²€í† "
            echo "3. í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ì¦‰ì‹œ ê²©ë¦¬ ë° ìˆ˜ì •"
            echo "4. FSD ì•„í‚¤í…ì²˜ ìœ„ë°˜ ìˆ˜ì •"
            echo "5. Grace QA ìŠ¹ì¸ í›„ ë°°í¬ ì§„í–‰"

            exit 1
          fi

          echo "ğŸ† Grace QA ìµœì¢… ìŠ¹ì¸!"
          echo "âœ… ëª¨ë“  ë¬´ê´€ìš© í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼"
          echo "âœ… $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ í™•ì¸"
          echo "âœ… í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ 0% í™•ì¸"
          echo "âœ… FSD ì•„í‚¤í…ì²˜ ì¤€ìˆ˜ í™•ì¸"
          echo "âœ… API ê³„ì•½ ì¼ì¹˜ í™•ì¸"
          echo ""
          echo "ğŸš€ ë°°í¬ ìŠ¹ì¸ - í”„ë¡œë•ì…˜ ë°°í¬ ê°€ëŠ¥"

      # ì„±ê³µ ì‹œ ë°°í¬ íƒœê·¸ ìƒì„±
      - name: ğŸ·ï¸ Grace ìŠ¹ì¸ íƒœê·¸ ìƒì„±
        if: success() && github.ref == 'refs/heads/main'
        run: |
          TIMESTAMP=$(date -u +"%Y%m%d-%H%M%S")
          TAG_NAME="grace-approved-${TIMESTAMP}"

          git config --local user.email "grace-qa@videoprompt.ai"
          git config --local user.name "Grace QA Lead"

          git tag -a "$TAG_NAME" -m "Grace QA ë¬´ê´€ìš© í’ˆì§ˆ ê²Œì´íŠ¸ ìŠ¹ì¸

          ğŸ† ëª¨ë“  í’ˆì§ˆ ê¸°ì¤€ í†µê³¼:
          - $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ âœ…
          - í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ 0% âœ…
          - FSD ì•„í‚¤í…ì²˜ ì¤€ìˆ˜ âœ…
          - API ê³„ì•½ ì¼ì¹˜ âœ…
          - ì»¤ë²„ë¦¬ì§€ 85%+ âœ…

          ë°°í¬ ìŠ¹ì¸ ì‹œê°: $TIMESTAMP UTC"

          git push origin "$TAG_NAME"

          echo "âœ… Grace ìŠ¹ì¸ íƒœê·¸ ìƒì„±: $TAG_NAME"

  # Slack ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-results:
    name: 'ğŸ“¢ ê²°ê³¼ ì•Œë¦¼'
    runs-on: ubuntu-latest
    needs: [grace-deployment-approval]
    if: always()

    steps:
      - name: ğŸ“± Grace QA ê²°ê³¼ ì•Œë¦¼
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          RESULT="${{ needs.grace-deployment-approval.result }}"

          if [ "$RESULT" = "success" ]; then
            MESSAGE="ğŸ† Grace QA ë¬´ê´€ìš© í’ˆì§ˆ ê²Œì´íŠ¸ ìŠ¹ì¸!

            âœ… ëª¨ë“  í’ˆì§ˆ ê¸°ì¤€ í†µê³¼
            âœ… $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ í™•ì¸
            âœ… í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ 0% ë‹¬ì„±
            âœ… FSD ì•„í‚¤í…ì²˜ ì™„ì „ ì¤€ìˆ˜

            ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ìŠ¹ì¸ë¨"
            COLOR="good"
          else
            MESSAGE="ğŸš¨ Grace QA ë¬´ê´€ìš© ì •ì±…: í’ˆì§ˆ ê²Œì´íŠ¸ ì°¨ë‹¨!

            âŒ í’ˆì§ˆ ê¸°ì¤€ ë¯¸ë‹¬ë¡œ ë°°í¬ ì°¨ë‹¨
            ğŸ”§ ì¦‰ì‹œ ìˆ˜ì • í›„ ì¬ì‹œë„ í•„ìš”

            ğŸ“‹ ìƒì„¸ ë¡œê·¸: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            COLOR="danger"
          fi

          # Slack ì•Œë¦¼ (Webhookì´ ì„¤ì •ëœ ê²½ìš°ì—ë§Œ)
          if [ -n "$SLACK_WEBHOOK" ]; then
            curl -X POST -H 'Content-type: application/json' \
              --data "{
                \"attachments\": [{
                  \"color\": \"$COLOR\",
                  \"text\": \"$MESSAGE\",
                  \"footer\": \"Grace QA Lead - ë¬´ê´€ìš© í’ˆì§ˆ ì •ì±…\"
                }]
              }" \
              "$SLACK_WEBHOOK"
          fi

          echo "$MESSAGE"