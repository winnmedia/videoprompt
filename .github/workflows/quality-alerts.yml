name: Quality Alerts & Monitoring

on:
  workflow_run:
    workflows: ["Enhanced Quality Gates - Zero Regression Policy"]
    types: [completed]
  schedule:
    # ë§¤ ì‹œê°„ë§ˆë‹¤ í’ˆì§ˆ ì§€í‘œ ìˆ˜ì§‘
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      alert_type:
        description: 'Type of alert to test'
        required: false
        default: 'test'
        type: choice
        options:
          - test
          - coverage
          - performance
          - security

env:
  SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
  SLACK_CHANNEL_CRITICAL: '#alerts-critical'
  SLACK_CHANNEL_WARNING: '#quality-alerts'
  SLACK_CHANNEL_INFO: '#ci-status'

jobs:
  # ğŸ” í’ˆì§ˆ ì§€í‘œ ìˆ˜ì§‘ ë° ë¶„ì„
  collect-quality-metrics:
    name: 'ğŸ“Š Collect Quality Metrics'
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion != 'skipped'
    outputs:
      quality-status: ${{ steps.analyze.outputs.quality-status }}
      alert-level: ${{ steps.analyze.outputs.alert-level }}
      metrics-summary: ${{ steps.analyze.outputs.metrics-summary }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Download test artifacts
        if: github.event.workflow_run
        uses: actions/download-artifact@v4
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.workflow_run.id }}
          path: ./artifacts

      - name: Analyze Quality Metrics
        id: analyze
        run: |
          echo "ğŸ“Š í’ˆì§ˆ ì§€í‘œ ë¶„ì„ ì¤‘..."

          # ê¸°ë³¸ í’ˆì§ˆ ìƒíƒœ
          QUALITY_STATUS="unknown"
          ALERT_LEVEL="info"
          METRICS_SUMMARY=""

          # ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼ í™•ì¸
          if [ "${{ github.event.workflow_run.conclusion }}" = "success" ]; then
            QUALITY_STATUS="good"
            ALERT_LEVEL="info"
            METRICS_SUMMARY="âœ… All quality gates passed"
          elif [ "${{ github.event.workflow_run.conclusion }}" = "failure" ]; then
            QUALITY_STATUS="critical"
            ALERT_LEVEL="critical"
            METRICS_SUMMARY="âŒ Quality gates failed - immediate attention required"
          fi

          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ íŒŒì¼ ë¶„ì„ (ìˆëŠ” ê²½ìš°)
          if [ -f "./artifacts/test-results/results.json" ]; then
            echo "ğŸ” í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë¶„ì„ ì¤‘..."

            # Node.jsë¡œ JSON íŒŒì‹±
            ANALYSIS=$(node -e "
              try {
                const fs = require('fs');
                const results = JSON.parse(fs.readFileSync('./artifacts/test-results/results.json', 'utf8'));

                const totalTests = results.numTotalTests || 0;
                const failedTests = results.numFailedTests || 0;
                const passedTests = results.numPassedTests || 0;
                const failureRate = totalTests > 0 ? (failedTests / totalTests * 100).toFixed(1) : 0;

                console.log(JSON.stringify({
                  totalTests,
                  failedTests,
                  passedTests,
                  failureRate,
                  status: failedTests > 0 ? 'failed' : 'passed'
                }));
              } catch (e) {
                console.log(JSON.stringify({ error: 'Could not parse test results' }));
              }
            ")

            echo "Test analysis: $ANALYSIS"
            echo "test-analysis=$ANALYSIS" >> $GITHUB_OUTPUT

            # ì‹¤íŒ¨ìœ¨ì´ ë†’ìœ¼ë©´ ì•Œë¦¼ ë ˆë²¨ ì¡°ì •
            FAILURE_RATE=$(echo "$ANALYSIS" | jq -r '.failureRate // 0')
            if (( $(echo "$FAILURE_RATE > 10" | bc -l) )); then
              ALERT_LEVEL="critical"
              QUALITY_STATUS="critical"
            elif (( $(echo "$FAILURE_RATE > 5" | bc -l) )); then
              ALERT_LEVEL="warning"
              QUALITY_STATUS="warning"
            fi
          fi

          # ì»¤ë²„ë¦¬ì§€ ì •ë³´ ë¶„ì„ (ìˆëŠ” ê²½ìš°)
          if [ -f "./artifacts/coverage/coverage-summary.json" ]; then
            echo "ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ë¶„ì„ ì¤‘..."

            COVERAGE_ANALYSIS=$(node -e "
              try {
                const fs = require('fs');
                const coverage = JSON.parse(fs.readFileSync('./artifacts/coverage/coverage-summary.json', 'utf8'));
                const total = coverage.total || {};

                const lines = total.lines?.pct || 0;
                const functions = total.functions?.pct || 0;
                const branches = total.branches?.pct || 0;
                const statements = total.statements?.pct || 0;

                const avgCoverage = (lines + functions + branches + statements) / 4;

                console.log(JSON.stringify({
                  lines, functions, branches, statements, avgCoverage,
                  status: avgCoverage >= 85 ? 'good' : avgCoverage >= 75 ? 'warning' : 'critical'
                }));
              } catch (e) {
                console.log(JSON.stringify({ error: 'Could not parse coverage' }));
              }
            ")

            echo "Coverage analysis: $COVERAGE_ANALYSIS"
            echo "coverage-analysis=$COVERAGE_ANALYSIS" >> $GITHUB_OUTPUT
          fi

          # ìµœì¢… ê²°ê³¼ ì„¤ì •
          echo "quality-status=$QUALITY_STATUS" >> $GITHUB_OUTPUT
          echo "alert-level=$ALERT_LEVEL" >> $GITHUB_OUTPUT
          echo "metrics-summary=$METRICS_SUMMARY" >> $GITHUB_OUTPUT

          echo "ğŸ“Š ë¶„ì„ ì™„ë£Œ:"
          echo "  Quality Status: $QUALITY_STATUS"
          echo "  Alert Level: $ALERT_LEVEL"
          echo "  Summary: $METRICS_SUMMARY"

  # ğŸš¨ $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ëª¨ë‹ˆí„°ë§
  monitor-cost-prevention:
    name: 'ğŸ’° $300 Incident Prevention Monitor'
    runs-on: ubuntu-latest
    needs: collect-quality-metrics
    if: needs.collect-quality-metrics.outputs.alert-level == 'critical'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Check for Infinite Loop Patterns
        id: check-patterns
        run: |
          echo "ğŸ” ë¬´í•œ ë£¨í”„ íŒ¨í„´ ê²€ì‚¬ ì¤‘..."

          VIOLATIONS=0
          VIOLATION_DETAILS=""

          # 1. useEffect ì˜ì¡´ì„± ë°°ì—´ ê²€ì‚¬
          echo "1. useEffect ì˜ì¡´ì„± ë°°ì—´ ê²€ì‚¬..."
          USEEFFECT_VIOLATIONS=$(grep -r "useEffect.*\[.*[a-zA-Z_][a-zA-Z0-9_]*\]" src/ --include="*.tsx" --include="*.ts" | grep -v "test" | wc -l)
          if [ $USEEFFECT_VIOLATIONS -gt 0 ]; then
            VIOLATIONS=$((VIOLATIONS + USEEFFECT_VIOLATIONS))
            VIOLATION_DETAILS="${VIOLATION_DETAILS}\n- useEffect ì˜ì¡´ì„± ë°°ì—´ ìœ„í—˜: ${USEEFFECT_VIOLATIONS}ê°œ"
          fi

          # 2. API í˜¸ì¶œ íŒ¨í„´ ê²€ì‚¬
          echo "2. ìœ„í—˜í•œ API í˜¸ì¶œ íŒ¨í„´ ê²€ì‚¬..."
          API_VIOLATIONS=$(grep -r "setInterval.*fetch\|setTimeout.*fetch" src/ --include="*.tsx" --include="*.ts" | grep -v "test" | wc -l)
          if [ $API_VIOLATIONS -gt 0 ]; then
            VIOLATIONS=$((VIOLATIONS + API_VIOLATIONS))
            VIOLATION_DETAILS="${VIOLATION_DETAILS}\n- ìœ„í—˜í•œ API íŒ¨í„´: ${API_VIOLATIONS}ê°œ"
          fi

          # 3. ë¬´í•œ ì¬ê·€ ê²€ì‚¬
          echo "3. ë¬´í•œ ì¬ê·€ íŒ¨í„´ ê²€ì‚¬..."
          RECURSION_VIOLATIONS=$(grep -r "function.*\(\).*{.*\1\(\)" src/ --include="*.tsx" --include="*.ts" | grep -v "test" | wc -l)
          if [ $RECURSION_VIOLATIONS -gt 0 ]; then
            VIOLATIONS=$((VIOLATIONS + RECURSION_VIOLATIONS))
            VIOLATION_DETAILS="${VIOLATION_DETAILS}\n- ë¬´í•œ ì¬ê·€ íŒ¨í„´: ${RECURSION_VIOLATIONS}ê°œ"
          fi

          echo "violations=$VIOLATIONS" >> $GITHUB_OUTPUT
          echo "details=$VIOLATION_DETAILS" >> $GITHUB_OUTPUT

          if [ $VIOLATIONS -gt 0 ]; then
            echo "ğŸš¨ $300 ì‚¬ê±´ ìœ„í—˜ íŒ¨í„´ ë°œê²¬!"
            echo "ì´ ìœ„ë°˜ ì‚¬í•­: $VIOLATIONSê°œ"
            echo -e "ìƒì„¸:$VIOLATION_DETAILS"
            exit 1
          else
            echo "âœ… $300 ì‚¬ê±´ ìœ„í—˜ íŒ¨í„´ ì—†ìŒ"
          fi

      - name: Critical Alert - $300 Pattern Detected
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: ${{ env.SLACK_CHANNEL_CRITICAL }}
          webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
          text: |
            ğŸš¨ **CRITICAL: $300 ì‚¬ê±´ ì¬ë°œ ìœ„í—˜ ê°ì§€!**

            **Repository:** ${{ github.repository }}
            **Branch:** ${{ github.ref_name }}
            **Commit:** ${{ github.sha }}
            **Triggered by:** ${{ github.actor }}

            **âš ï¸ ê°ì§€ëœ ìœ„í—˜ íŒ¨í„´:**
            ${{ steps.check-patterns.outputs.details }}

            **ğŸ”§ ì¦‰ì‹œ ì¡°ì¹˜ í•„ìš”:**
            1. í•´ë‹¹ ì½”ë“œ ìˆ˜ì •
            2. useEffect ì˜ì¡´ì„± ë°°ì—´ í™•ì¸
            3. API í˜¸ì¶œ íŒ¨í„´ ê²€í† 
            4. ë¬´í•œ ë£¨í”„ ê°€ëŠ¥ì„± ì œê±°

            **ğŸ“‹ Action Required:** @channel
            ì´ëŠ” $300 ì‚¬ê±´ê³¼ ë™ì¼í•œ íŒ¨í„´ì…ë‹ˆë‹¤. ì¦‰ì‹œ í™•ì¸í•˜ê³  ìˆ˜ì •í•´ì£¼ì„¸ìš”.

  # ğŸ“ˆ í’ˆì§ˆ íŠ¸ë Œë“œ ì•Œë¦¼
  quality-trend-notification:
    name: 'ğŸ“ˆ Quality Trend Notification'
    runs-on: ubuntu-latest
    needs: collect-quality-metrics
    if: always()

    steps:
      - name: Generate Quality Report
        id: report
        run: |
          # í’ˆì§ˆ ìƒíƒœì— ë”°ë¥¸ ì´ëª¨ì§€ ë° ìƒ‰ìƒ ì„¤ì •
          case "${{ needs.collect-quality-metrics.outputs.quality-status }}" in
            "good")
              EMOJI="âœ…"
              COLOR="good"
              ;;
            "warning")
              EMOJI="âš ï¸"
              COLOR="warning"
              ;;
            "critical")
              EMOJI="ğŸš¨"
              COLOR="danger"
              ;;
            *)
              EMOJI="ğŸ”"
              COLOR="#cccccc"
              ;;
          esac

          echo "emoji=$EMOJI" >> $GITHUB_OUTPUT
          echo "color=$COLOR" >> $GITHUB_OUTPUT

          # ì±„ë„ ì„ íƒ
          if [ "${{ needs.collect-quality-metrics.outputs.alert-level }}" = "critical" ]; then
            echo "channel=${{ env.SLACK_CHANNEL_CRITICAL }}" >> $GITHUB_OUTPUT
          elif [ "${{ needs.collect-quality-metrics.outputs.alert-level }}" = "warning" ]; then
            echo "channel=${{ env.SLACK_CHANNEL_WARNING }}" >> $GITHUB_OUTPUT
          else
            echo "channel=${{ env.SLACK_CHANNEL_INFO }}" >> $GITHUB_OUTPUT
          fi

      - name: Send Quality Report to Slack
        if: env.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          channel: ${{ steps.report.outputs.channel }}
          webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
          custom_payload: |
            {
              "attachments": [
                {
                  "color": "${{ steps.report.outputs.color }}",
                  "title": "${{ steps.report.outputs.emoji }} VideoPlanet Quality Report",
                  "fields": [
                    {
                      "title": "Status",
                      "value": "${{ needs.collect-quality-metrics.outputs.quality-status }}",
                      "short": true
                    },
                    {
                      "title": "Alert Level",
                      "value": "${{ needs.collect-quality-metrics.outputs.alert-level }}",
                      "short": true
                    },
                    {
                      "title": "Repository",
                      "value": "${{ github.repository }}",
                      "short": true
                    },
                    {
                      "title": "Branch",
                      "value": "${{ github.ref_name }}",
                      "short": true
                    },
                    {
                      "title": "Workflow",
                      "value": "${{ github.workflow }}",
                      "short": true
                    },
                    {
                      "title": "Triggered by",
                      "value": "${{ github.actor }}",
                      "short": true
                    },
                    {
                      "title": "Summary",
                      "value": "${{ needs.collect-quality-metrics.outputs.metrics-summary }}",
                      "short": false
                    }
                  ],
                  "footer": "VideoPlanet Quality Monitor",
                  "footer_icon": "https://github.com/favicon.ico",
                  "ts": ${{ github.event.head_commit.timestamp && github.event.head_commit.timestamp || github.event.workflow_run.created_at && github.event.workflow_run.created_at || 'Math.floor(Date.now()/1000)' }}
                }
              ]
            }

  # ğŸ“Š ì£¼ê°„ í’ˆì§ˆ ë¦¬í¬íŠ¸ (ë§¤ì£¼ ì›”ìš”ì¼)
  weekly-quality-report:
    name: 'ğŸ“Š Weekly Quality Report'
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '0 9 * * 1' # ë§¤ì£¼ ì›”ìš”ì¼ 9ì‹œ

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Generate Weekly Report
        id: weekly
        run: |
          echo "ğŸ“Š ì£¼ê°„ í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„± ì¤‘..."

          # GitHub APIë¥¼ í†µí•´ ìµœê·¼ 7ì¼ê°„ì˜ ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ì •ë³´ ìˆ˜ì§‘
          WEEK_AGO=$(date -d '7 days ago' --iso-8601)

          # API í˜¸ì¶œë¡œ ë°ì´í„° ìˆ˜ì§‘ (ì‹¤ì œ êµ¬í˜„ì—ì„œëŠ” GitHub API ì‚¬ìš©)
          echo "collecting_data=true" >> $GITHUB_OUTPUT
          echo "week_start=$WEEK_AGO" >> $GITHUB_OUTPUT

          # ì£¼ê°„ í†µê³„ (ì˜ˆì‹œ ë°ì´í„°)
          echo "total_builds=42" >> $GITHUB_OUTPUT
          echo "successful_builds=38" >> $GITHUB_OUTPUT
          echo "failed_builds=4" >> $GITHUB_OUTPUT
          echo "success_rate=90.5" >> $GITHUB_OUTPUT
          echo "avg_build_time=4.2" >> $GITHUB_OUTPUT

      - name: Send Weekly Report
        if: env.SLACK_WEBHOOK_URL
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          channel: ${{ env.SLACK_CHANNEL_INFO }}
          webhook_url: ${{ env.SLACK_WEBHOOK_URL }}
          custom_payload: |
            {
              "text": "ğŸ“Š VideoPlanet ì£¼ê°„ í’ˆì§ˆ ë¦¬í¬íŠ¸",
              "attachments": [
                {
                  "color": "good",
                  "title": "ğŸ“ˆ ì£¼ê°„ í’ˆì§ˆ ì§€í‘œ (${{ steps.weekly.outputs.week_start }} ~ í˜„ì¬)",
                  "fields": [
                    {
                      "title": "ì´ ë¹Œë“œ ìˆ˜",
                      "value": "${{ steps.weekly.outputs.total_builds }}íšŒ",
                      "short": true
                    },
                    {
                      "title": "ì„±ê³µë¥ ",
                      "value": "${{ steps.weekly.outputs.success_rate }}%",
                      "short": true
                    },
                    {
                      "title": "ì„±ê³µí•œ ë¹Œë“œ",
                      "value": "${{ steps.weekly.outputs.successful_builds }}íšŒ",
                      "short": true
                    },
                    {
                      "title": "ì‹¤íŒ¨í•œ ë¹Œë“œ",
                      "value": "${{ steps.weekly.outputs.failed_builds }}íšŒ",
                      "short": true
                    },
                    {
                      "title": "í‰ê·  ë¹Œë“œ ì‹œê°„",
                      "value": "${{ steps.weekly.outputs.avg_build_time }}ë¶„",
                      "short": true
                    },
                    {
                      "title": "$300 ì‚¬ê±´ ë°©ì§€",
                      "value": "âœ… ìœ„í—˜ íŒ¨í„´ 0ê±´",
                      "short": true
                    }
                  ],
                  "footer": "ë§¤ì£¼ ì›”ìš”ì¼ ìë™ ìƒì„±",
                  "ts": ${{ Math.floor(Date.now()/1000) }}
                }
              ]
            }

  # ğŸ”§ ìë™ ì´ìŠˆ ìƒì„± (í’ˆì§ˆ ë¬¸ì œ ë°œìƒ ì‹œ)
  create-quality-issue:
    name: 'ğŸ”§ Create Quality Issue'
    runs-on: ubuntu-latest
    needs: [collect-quality-metrics, monitor-cost-prevention]
    if: failure() && needs.collect-quality-metrics.outputs.alert-level == 'critical'

    steps:
      - name: Create GitHub Issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = `ğŸš¨ Critical Quality Issue Detected - ${new Date().toISOString().split('T')[0]}`;
            const body = `
            ## ğŸš¨ Critical Quality Issue Detected

            **Alert Level:** Critical
            **Quality Status:** ${{ needs.collect-quality-metrics.outputs.quality-status }}
            **Workflow Run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

            ### ğŸ“Š Metrics Summary
            ${{ needs.collect-quality-metrics.outputs.metrics-summary }}

            ### ğŸ” Detected Issues
            - Workflow execution failed
            - Quality gates not passed
            - Potential regression detected

            ### ğŸš¨ $300 Incident Prevention
            This alert is part of our $300 incident prevention system. Immediate action required.

            ### ğŸ”§ Action Items
            - [ ] Review failed tests
            - [ ] Check for infinite loop patterns
            - [ ] Verify API call frequencies
            - [ ] Update test coverage if needed
            - [ ] Run full regression test suite

            ### ğŸ“‹ Assignees
            Please assign this to the appropriate team member immediately.

            ---
            **Auto-generated by Quality Monitor**
            **Timestamp:** ${new Date().toISOString()}
            `;

            try {
              const issue = await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['critical', 'quality', 'regression', 'auto-generated'],
                assignees: ['${{ github.actor }}']
              });

              console.log(`Created issue #${issue.data.number}: ${title}`);
            } catch (error) {
              console.error('Failed to create issue:', error);
            }