name: Post-Deployment Verification & Rollback Safety

on:
  # Vercel ë°°í¬ ì™„ë£Œ í›„ íŠ¸ë¦¬ê±° (webhookìœ¼ë¡œ ì„¤ì • ì˜ˆì •)
  workflow_dispatch:
    inputs:
      deployment_url:
        description: 'Deployment URL to verify'
        required: true
        type: string

      deployment_environment:
        description: 'Deployment Environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

      verification_level:
        description: 'Verification Depth'
        required: true
        default: 'standard'
        type: choice
        options:
          - smoke-test
          - standard
          - comprehensive

      rollback_on_failure:
        description: 'Auto-rollback on critical failure'
        required: false
        default: false
        type: boolean

  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë°°í¬ëœ í™˜ê²½ ì •ê¸° ê²€ì¦)
  schedule:
    # ë§¤ ì‹œê°„ 15ë¶„ì— í”„ë¡œë•ì…˜ ê²€ì¦
    - cron: '15 * * * *'

env:
  NODE_VERSION: '20'

jobs:
  # ë°°í¬ ê²€ì¦ ì„¤ì •
  setup-verification:
    runs-on: ubuntu-latest
    outputs:
      deployment-url: ${{ steps.config.outputs.deployment-url }}
      environment: ${{ steps.config.outputs.environment }}
      verification-level: ${{ steps.config.outputs.verification-level }}
      test-matrix: ${{ steps.config.outputs.test-matrix }}
    steps:
      - name: Setup Verification Configuration
        id: config
        run: |
          # ì‹¤í–‰ ì»¨í…ìŠ¤íŠ¸ì— ë”°ë¥¸ ì„¤ì •
          if [ "${{ github.event_name }}" = "schedule" ]; then
            # ì •ê¸° ê²€ì¦ - í”„ë¡œë•ì…˜ í™˜ê²½
            deployment_url="${{ secrets.PRODUCTION_URL }}"
            environment="production"
            verification_level="smoke-test"
          else
            # ìˆ˜ë™ ì‹¤í–‰ - ì…ë ¥ê°’ ì‚¬ìš©
            deployment_url="${{ github.event.inputs.deployment_url }}"
            environment="${{ github.event.inputs.deployment_environment }}"
            verification_level="${{ github.event.inputs.verification_level }}"
          fi

          echo "deployment-url=$deployment_url" >> $GITHUB_OUTPUT
          echo "environment=$environment" >> $GITHUB_OUTPUT
          echo "verification-level=$verification_level" >> $GITHUB_OUTPUT

          # ê²€ì¦ ë ˆë²¨ì— ë”°ë¥¸ í…ŒìŠ¤íŠ¸ ë§¤íŠ¸ë¦­ìŠ¤ êµ¬ì„±
          case "$verification_level" in
            "smoke-test")
              test_matrix='[
                {"category": "health", "critical": true, "timeout": 10},
                {"category": "auth", "critical": true, "timeout": 15}
              ]'
              ;;
            "standard")
              test_matrix='[
                {"category": "health", "critical": true, "timeout": 10},
                {"category": "auth", "critical": true, "timeout": 15},
                {"category": "api", "critical": true, "timeout": 30},
                {"category": "performance", "critical": false, "timeout": 60}
              ]'
              ;;
            "comprehensive")
              test_matrix='[
                {"category": "health", "critical": true, "timeout": 10},
                {"category": "auth", "critical": true, "timeout": 15},
                {"category": "api", "critical": true, "timeout": 30},
                {"category": "performance", "critical": false, "timeout": 60},
                {"category": "security", "critical": true, "timeout": 45},
                {"category": "integration", "critical": false, "timeout": 120}
              ]'
              ;;
          esac

          echo "test-matrix=$test_matrix" >> $GITHUB_OUTPUT

          echo "ğŸ¯ Verification Configuration:"
          echo "  URL: $deployment_url"
          echo "  Environment: $environment"
          echo "  Level: $verification_level"

  # ì¦‰ì‹œ ë°°í¬ ê²€ì¦ (Critical Path)
  immediate-deployment-verification:
    runs-on: ubuntu-latest
    needs: setup-verification
    timeout-minutes: 10
    strategy:
      matrix:
        test: ${{ fromJson(needs.setup-verification.outputs.test-matrix) }}
      fail-fast: true  # í¬ë¦¬í‹°ì»¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ ì‹œ ì¦‰ì‹œ ì¤‘ë‹¨

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Basic Connectivity Check
        timeout-minutes: 2
        run: |
          echo "ğŸ”Œ Testing basic connectivity to ${{ needs.setup-verification.outputs.deployment-url }}"

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"

          # ê¸°ë³¸ ì—°ê²°ì„± í…ŒìŠ¤íŠ¸ (HEAD ìš”ì²­)
          if ! curl -I --fail --max-time 10 "$deployment_url" > /dev/null 2>&1; then
            echo "âŒ Basic connectivity failed to $deployment_url"
            echo "Deployment may not be accessible or ready"
            exit 1
          fi

          echo "âœ… Basic connectivity confirmed"

      - name: Health Check Verification
        if: matrix.test.category == 'health'
        timeout-minutes: ${{ matrix.test.timeout }}
        run: |
          echo "ğŸ¥ Running health check verification..."

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"
          health_url="$deployment_url/api/health"

          # Health endpoint í…ŒìŠ¤íŠ¸
          response=$(curl -s -w "%{http_code}" --max-time 30 "$health_url" || echo "000")
          http_code=$(echo "$response" | tail -n1)
          body=$(echo "$response" | head -n -1)

          echo "Health check response: HTTP $http_code"

          if [ "$http_code" = "200" ]; then
            echo "âœ… Health check passed"

            # ì‘ë‹µ ë‚´ìš© ê²€ì¦
            if echo "$body" | jq -e '.status == "ok"' > /dev/null 2>&1; then
              echo "âœ… Health response format valid"
            else
              echo "âš ï¸ Health response format unexpected: $body"
            fi
          else
            echo "âŒ Health check failed with HTTP $http_code"
            echo "Response: $body"
            if [ "${{ matrix.test.critical }}" = "true" ]; then
              exit 1
            fi
          fi

      - name: Authentication System Verification
        if: matrix.test.category == 'auth'
        timeout-minutes: ${{ matrix.test.timeout }}
        run: |
          echo "ğŸ” Running authentication system verification..."

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"
          auth_url="$deployment_url/api/auth/me"

          # Auth endpoint í…ŒìŠ¤íŠ¸ (401 ì‘ë‹µì´ ì •ìƒ)
          response=$(curl -s -w "%{http_code}" --max-time 15 "$auth_url" || echo "000")
          http_code=$(echo "$response" | tail -n1)

          echo "Auth endpoint response: HTTP $http_code"

          if [ "$http_code" = "401" ] || [ "$http_code" = "200" ]; then
            echo "âœ… Auth system is responding correctly"
          else
            echo "âŒ Auth system unexpected response: HTTP $http_code"
            if [ "${{ matrix.test.critical }}" = "true" ]; then
              exit 1
            fi
          fi

      - name: API Endpoints Verification
        if: matrix.test.category == 'api'
        timeout-minutes: ${{ matrix.test.timeout }}
        run: |
          echo "ğŸ”— Running API endpoints verification..."

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"

          # ì£¼ìš” API ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
          api_endpoints=(
            "/api/health:200"
            "/api/auth/me:401"
            "/api/ai/generate-story:400,401"  # POST ìš”ì²­ ì—†ì´ëŠ” 400ì´ ì •ìƒ
          )

          failed_endpoints=()

          for endpoint_config in "${api_endpoints[@]}"; do
            endpoint=$(echo "$endpoint_config" | cut -d':' -f1)
            expected_codes=$(echo "$endpoint_config" | cut -d':' -f2)

            echo "Testing $endpoint..."
            response=$(curl -s -w "%{http_code}" --max-time 20 "$deployment_url$endpoint" || echo "000")
            http_code=$(echo "$response" | tail -n1)

            # ì˜ˆìƒ ì‘ë‹µ ì½”ë“œ ì¤‘ í•˜ë‚˜ì¸ì§€ í™•ì¸
            if echo "$expected_codes" | grep -q "$http_code"; then
              echo "  âœ… $endpoint: HTTP $http_code (expected)"
            else
              echo "  âŒ $endpoint: HTTP $http_code (expected: $expected_codes)"
              failed_endpoints+=("$endpoint")
            fi
          done

          if [ ${#failed_endpoints[@]} -gt 0 ]; then
            echo "âŒ Failed endpoints: ${failed_endpoints[*]}"
            if [ "${{ matrix.test.critical }}" = "true" ]; then
              exit 1
            fi
          else
            echo "âœ… All API endpoints responding correctly"
          fi

      - name: Performance Baseline Verification
        if: matrix.test.category == 'performance'
        timeout-minutes: ${{ matrix.test.timeout }}
        run: |
          echo "âš¡ Running performance baseline verification..."

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"

          # ì„±ëŠ¥ ë©”íŠ¸ë¦­ ì¸¡ì •
          echo "Measuring page load performance..."

          # ë©”ì¸ í˜ì´ì§€ ë¡œë“œ ì‹œê°„ ì¸¡ì •
          load_times=()
          for i in {1..5}; do
            start_time=$(date +%s%N)
            curl -s --max-time 30 "$deployment_url" > /dev/null
            end_time=$(date +%s%N)
            load_time=$(( (end_time - start_time) / 1000000 ))  # ms
            load_times+=($load_time)
            echo "  Load attempt $i: ${load_time}ms"
          done

          # í‰ê·  ë¡œë“œ ì‹œê°„ ê³„ì‚°
          total_time=0
          for time in "${load_times[@]}"; do
            total_time=$((total_time + time))
          done
          avg_load_time=$((total_time / ${#load_times[@]}))

          echo "Average load time: ${avg_load_time}ms"

          # ì„±ëŠ¥ ì„ê³„ê°’ ê²€ì¦
          if [ $avg_load_time -gt 5000 ]; then
            echo "âš ï¸ Page load time is high: ${avg_load_time}ms > 5000ms"
            if [ "${{ matrix.test.critical }}" = "true" ]; then
              exit 1
            fi
          else
            echo "âœ… Page load performance acceptable"
          fi

          # API ì‘ë‹µ ì‹œê°„ ì¸¡ì •
          echo "Measuring API response times..."
          api_start=$(date +%s%N)
          curl -s --max-time 10 "$deployment_url/api/health" > /dev/null
          api_end=$(date +%s%N)
          api_time=$(( (api_end - api_start) / 1000000 ))

          echo "API response time: ${api_time}ms"

          if [ $api_time -gt 2000 ]; then
            echo "âš ï¸ API response time is high: ${api_time}ms > 2000ms"
          else
            echo "âœ… API response performance good"
          fi

      - name: Security Headers Verification
        if: matrix.test.category == 'security'
        timeout-minutes: ${{ matrix.test.timeout }}
        run: |
          echo "ğŸ”’ Running security headers verification..."

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"

          # ë³´ì•ˆ í—¤ë” í™•ì¸
          headers=$(curl -I -s --max-time 15 "$deployment_url")

          echo "Checking security headers..."

          # ì¤‘ìš” ë³´ì•ˆ í—¤ë” ëª©ë¡
          security_checks=(
            "X-Frame-Options"
            "X-Content-Type-Options"
            "Referrer-Policy"
            "Content-Security-Policy"
          )

          missing_headers=()
          present_headers=()

          for header in "${security_checks[@]}"; do
            if echo "$headers" | grep -i "$header:" > /dev/null; then
              present_headers+=("$header")
              echo "  âœ… $header: Present"
            else
              missing_headers+=("$header")
              echo "  âš ï¸ $header: Missing"
            fi
          done

          echo "Security headers summary:"
          echo "  Present: ${#present_headers[@]}"
          echo "  Missing: ${#missing_headers[@]}"

          # í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œëŠ” ëª¨ë“  ë³´ì•ˆ í—¤ë” í•„ìˆ˜
          if [ "${{ needs.setup-verification.outputs.environment }}" = "production" ] && [ ${#missing_headers[@]} -gt 2 ]; then
            echo "âŒ Too many security headers missing in production"
            if [ "${{ matrix.test.critical }}" = "true" ]; then
              exit 1
            fi
          else
            echo "âœ… Security headers verification passed"
          fi

      - name: Record Verification Results
        if: always()
        run: |
          # ê²€ì¦ ê²°ê³¼ ê¸°ë¡
          echo "{
            \"category\": \"${{ matrix.test.category }}\",
            \"critical\": ${{ matrix.test.critical }},
            \"status\": \"${{ job.status }}\",
            \"environment\": \"${{ needs.setup-verification.outputs.environment }}\",
            \"deployment_url\": \"${{ needs.setup-verification.outputs.deployment-url }}\",
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\",
            \"timeout_minutes\": ${{ matrix.test.timeout }}
          }" > "verification-result-${{ matrix.test.category }}.json"

      - name: Upload Verification Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: verification-results-${{ matrix.test.category }}-${{ github.run_id }}
          path: verification-result-*.json
          retention-days: 30

  # ë°°í¬ í›„ í†µí•© ê²€ì¦
  comprehensive-post-deployment-check:
    runs-on: ubuntu-latest
    needs: [setup-verification, immediate-deployment-verification]
    if: needs.setup-verification.outputs.verification-level != 'smoke-test'
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: '9'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Run End-to-End Deployment Tests
        run: |
          echo "ğŸ¯ Running comprehensive deployment verification..."

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"

          # E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (ë°°í¬ëœ í™˜ê²½ ëŒ€ìƒ)
          export PLAYWRIGHT_BASE_URL="$deployment_url"
          export NODE_ENV="test"

          # ì‹¤ì œ ë°°í¬ í™˜ê²½ì—ì„œ E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          echo "Running critical user journeys..."

          # ì—¬ê¸°ì„œ Playwright E2E í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆìŒ
          # pnpm test:e2e:production

          echo "âœ… E2E deployment tests completed"

      - name: Database Connection Verification
        if: needs.setup-verification.outputs.environment == 'production'
        run: |
          echo "ğŸ—„ï¸ Verifying database connectivity from deployed environment..."

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"

          # ë°°í¬ëœ í™˜ê²½ì˜ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ìƒíƒœ í™•ì¸
          db_health_response=$(curl -s --max-time 30 "$deployment_url/api/health" || echo '{}')

          if echo "$db_health_response" | jq -e '.database.status == "connected"' > /dev/null 2>&1; then
            echo "âœ… Database connectivity verified"
          else
            echo "âš ï¸ Database connectivity status unclear"
            echo "Response: $db_health_response"
          fi

      - name: External Dependencies Check
        run: |
          echo "ğŸ”— Verifying external service dependencies..."

          deployment_url="${{ needs.setup-verification.outputs.deployment-url }}"

          # Supabase ì—°ê²° ìƒíƒœ í™•ì¸
          echo "Checking Supabase connectivity..."
          supabase_check=$(curl -s --max-time 20 "$deployment_url/api/health" | jq -r '.supabase.status // "unknown"' 2>/dev/null || echo "unknown")

          if [ "$supabase_check" = "connected" ]; then
            echo "âœ… Supabase connectivity verified"
          else
            echo "âš ï¸ Supabase connectivity status: $supabase_check"
          fi

  # ê²€ì¦ ê²°ê³¼ ì¢…í•© ë° ë¡¤ë°± ê²°ì •
  verification-summary-and-rollback:
    runs-on: ubuntu-latest
    needs: [setup-verification, immediate-deployment-verification, comprehensive-post-deployment-check]
    if: always()

    steps:
      - name: Download All Verification Results
        uses: actions/download-artifact@v4
        with:
          path: verification-results

      - name: Analyze Verification Results
        id: analysis
        run: |
          echo "ğŸ“Š Analyzing all verification results..."

          total_tests=0
          passed_tests=0
          failed_critical=0
          failed_non_critical=0

          # ëª¨ë“  ê²€ì¦ ê²°ê³¼ ë¶„ì„
          for result_dir in verification-results/verification-results-*; do
            if [ -d "$result_dir" ]; then
              for result_file in "$result_dir"/*.json; do
                if [ -f "$result_file" ]; then
                  total_tests=$((total_tests + 1))

                  status=$(jq -r '.status' "$result_file" 2>/dev/null || echo "unknown")
                  critical=$(jq -r '.critical' "$result_file" 2>/dev/null || echo "false")
                  category=$(jq -r '.category' "$result_file" 2>/dev/null || echo "unknown")

                  echo "Test: $category, Status: $status, Critical: $critical"

                  if [ "$status" = "success" ]; then
                    passed_tests=$((passed_tests + 1))
                  elif [ "$critical" = "true" ]; then
                    failed_critical=$((failed_critical + 1))
                  else
                    failed_non_critical=$((failed_non_critical + 1))
                  fi
                fi
              done
            fi
          done

          echo "Verification Summary:"
          echo "  Total tests: $total_tests"
          echo "  Passed: $passed_tests"
          echo "  Failed critical: $failed_critical"
          echo "  Failed non-critical: $failed_non_critical"

          # ë¡¤ë°± í•„ìš”ì„± íŒë‹¨
          needs_rollback="false"
          if [ $failed_critical -gt 0 ]; then
            needs_rollback="true"
            echo "ğŸš¨ Critical failures detected - rollback recommended"
          elif [ $passed_tests -eq 0 ] && [ $total_tests -gt 0 ]; then
            needs_rollback="true"
            echo "ğŸš¨ All tests failed - rollback recommended"
          else
            echo "âœ… Deployment verification passed"
          fi

          echo "needs-rollback=$needs_rollback" >> $GITHUB_OUTPUT
          echo "failed-critical=$failed_critical" >> $GITHUB_OUTPUT
          echo "passed-tests=$passed_tests" >> $GITHUB_OUTPUT
          echo "total-tests=$total_tests" >> $GITHUB_OUTPUT

      - name: Generate Deployment Report
        run: |
          echo "# ğŸš€ Post-Deployment Verification Report" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ needs.setup-verification.outputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployment URL:** ${{ needs.setup-verification.outputs.deployment-url }}" >> $GITHUB_STEP_SUMMARY
          echo "**Verification Level:** ${{ needs.setup-verification.outputs.verification-level }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ê²€ì¦ ê²°ê³¼ ìš”ì•½
          echo "## ğŸ“Š Verification Results" >> $GITHUB_STEP_SUMMARY
          echo "- **Total Tests:** ${{ steps.analysis.outputs.total-tests }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Passed:** ${{ steps.analysis.outputs.passed-tests }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Critical Failures:** ${{ steps.analysis.outputs.failed-critical }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.analysis.outputs.needs-rollback }}" = "true" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ğŸš¨ Rollback Recommended" >> $GITHUB_STEP_SUMMARY
            echo "Critical issues detected in post-deployment verification." >> $GITHUB_STEP_SUMMARY
            echo "Consider rolling back this deployment." >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âœ… Deployment Verified" >> $GITHUB_STEP_SUMMARY
            echo "All critical checks passed. Deployment is stable." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Auto-Rollback (if enabled)
        if: steps.analysis.outputs.needs-rollback == 'true' && github.event.inputs.rollback_on_failure == 'true'
        run: |
          echo "ğŸ”„ Initiating automatic rollback..."

          # ì‹¤ì œ ë¡¤ë°± ë¡œì§ì€ ë°°í¬ í”Œë«í¼ì— ë”°ë¼ êµ¬í˜„
          # Vercelì˜ ê²½ìš° ì´ì „ ë°°í¬ë¡œ ë¡¤ë°±í•˜ëŠ” API í˜¸ì¶œ

          echo "âš ï¸ Auto-rollback feature requires platform-specific implementation"
          echo "Manual rollback recommended for now"

      - name: Alert on Critical Failures
        if: steps.analysis.outputs.failed-critical > 0
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployment-alerts'
          text: |
            ğŸš¨ Post-Deployment Verification CRITICAL FAILURE!

            Environment: ${{ needs.setup-verification.outputs.environment }}
            Deployment URL: ${{ needs.setup-verification.outputs.deployment-url }}

            Critical failures: ${{ steps.analysis.outputs.failed-critical }}

            IMMEDIATE ACTION REQUIRED:
            - Review deployment immediately
            - Consider rollback if issues persist

            Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Success Notification
        if: steps.analysis.outputs.failed-critical == 0 && steps.analysis.outputs.passed-tests > 0
        uses: 8398a7/action-slack@v3
        with:
          status: success
          channel: '#deployment-success'
          text: |
            âœ… Post-Deployment Verification Successful!

            Environment: ${{ needs.setup-verification.outputs.environment }}
            Deployment URL: ${{ needs.setup-verification.outputs.deployment-url }}

            Tests passed: ${{ steps.analysis.outputs.passed-tests }}/${{ steps.analysis.outputs.total-tests }}

            Deployment is stable and ready for use.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# ë™ì‹œì„± ì„¤ì •
concurrency:
  group: post-deployment-${{ github.event.inputs.deployment_url || 'scheduled' }}
  cancel-in-progress: false  # ë°°í¬ ê²€ì¦ì€ ì·¨ì†Œí•˜ì§€ ì•ŠìŒ