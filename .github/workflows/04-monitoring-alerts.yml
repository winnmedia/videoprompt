name: 04. Monitoring & Alerts
# í†µí•©ëœ ëª¨ë‹ˆí„°ë§ ë° ì•Œë¦¼ ì‹œìŠ¤í…œ

on:
  schedule:
    # ë§¤ 15ë¶„ë§ˆë‹¤ í—¬ìŠ¤ ì²´í¬
    - cron: '*/15 * * * *'
    # ë§¤ì¼ ì˜¤ì „ 6ì‹œ ì¼ì¼ ë³´ê³ ì„œ
    - cron: '0 6 * * *'
    # ë§¤ì£¼ ì›”ìš”ì¼ ì˜¤ì „ 9ì‹œ ì£¼ê°„ ë³´ê³ ì„œ
    - cron: '0 9 * * 1'
  workflow_dispatch:
    inputs:
      monitoring_mode:
        description: 'Monitoring mode'
        required: false
        default: 'health-check'
        type: choice
        options:
          - 'health-check'
          - 'security-scan'
          - 'performance-audit'
          - 'full-diagnostic'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ğŸ©º Stage 1: ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬ (15ë¶„ë§ˆë‹¤)
  basic-health-check:
    name: 'ğŸ©º Basic Health Check'
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && github.event.schedule == '*/15 * * * *'
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ ìƒíƒœ ì²´í¬
      - name: Production Service Status
        run: |
          echo "ğŸ©º í”„ë¡œë•ì…˜ ì„œë¹„ìŠ¤ ìƒíƒœ ì²´í¬..."

          # ë©”ì¸ ì„œë¹„ìŠ¤ í—¬ìŠ¤ ì²´í¬
          services=(
            "${{ secrets.NEXT_PUBLIC_APP_URL }}"
            "${{ secrets.NEXT_PUBLIC_APP_URL }}/api/health"
            "${{ secrets.NEXT_PUBLIC_APP_URL }}/api/auth/health"
          )

          failed_services=()

          for service in "${services[@]}"; do
            echo "Testing $service..."
            if ! curl -f --max-time 10 --silent "$service" > /dev/null; then
              failed_services+=("$service")
              echo "âŒ $service ì ‘ê·¼ ë¶ˆê°€"
            else
              echo "âœ… $service ì •ìƒ"
            fi
          done

          if [ ${#failed_services[@]} -gt 0 ]; then
            echo "ğŸš¨ ì‹¤íŒ¨í•œ ì„œë¹„ìŠ¤ë“¤:"
            printf '%s\n' "${failed_services[@]}"
            exit 1
          fi

          echo "âœ… ëª¨ë“  ì„œë¹„ìŠ¤ ì •ìƒ"

      # ì‘ë‹µ ì‹œê°„ ì²´í¬
      - name: Response Time Check
        run: |
          echo "â±ï¸ ì‘ë‹µ ì‹œê°„ ì²´í¬..."

          start_time=$(date +%s%N)
          curl -s "${{ secrets.NEXT_PUBLIC_APP_URL }}/api/health" > /dev/null
          end_time=$(date +%s%N)

          duration=$(( (end_time - start_time) / 1000000 ))
          max_response_time=3000  # 3ì´ˆ

          echo "API ì‘ë‹µ ì‹œê°„: ${duration}ms"
          echo "ìµœëŒ€ í—ˆìš© ì‹œê°„: ${max_response_time}ms"

          if [ $duration -gt $max_response_time ]; then
            echo "âŒ ì‘ë‹µ ì‹œê°„ì´ ë„ˆë¬´ ê¹ë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… ì‘ë‹µ ì‹œê°„ ì •ìƒ"

      # SSL ì¸ì¦ì„œ ì²´í¬
      - name: SSL Certificate Check
        run: |
          echo "ğŸ”’ SSL ì¸ì¦ì„œ ì²´í¬..."

          domain=$(echo "${{ secrets.NEXT_PUBLIC_APP_URL }}" | sed 's|https\?://||' | cut -d'/' -f1)

          expiry_date=$(echo | openssl s_client -servername "$domain" -connect "$domain:443" 2>/dev/null | openssl x509 -noout -dates | grep notAfter | cut -d'=' -f2)
          expiry_epoch=$(date -d "$expiry_date" +%s)
          current_epoch=$(date +%s)
          days_until_expiry=$(( (expiry_epoch - current_epoch) / 86400 ))

          echo "SSL ì¸ì¦ì„œ ë§Œë£Œì¼: $expiry_date"
          echo "ë§Œë£Œê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜: $days_until_expiryì¼"

          if [ $days_until_expiry -lt 30 ]; then
            echo "âš ï¸ SSL ì¸ì¦ì„œê°€ 30ì¼ ì´ë‚´ì— ë§Œë£Œë©ë‹ˆë‹¤!"
          fi

          if [ $days_until_expiry -lt 7 ]; then
            echo "âŒ SSL ì¸ì¦ì„œê°€ ê³§ ë§Œë£Œë©ë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… SSL ì¸ì¦ì„œ ì •ìƒ"

  # ğŸ”’ Stage 2: ë³´ì•ˆ ìŠ¤ìº” (ìˆ˜ë™/ìŠ¤ì¼€ì¤„)
  security-scan:
    name: 'ğŸ”’ Security Scan'
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.monitoring_mode == 'security-scan') ||
      (github.event_name == 'schedule' && github.event.schedule == '0 6 * * *')
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ì˜ì¡´ì„± ë³´ì•ˆ ì²´í¬
      - name: Dependency Security Audit
        run: |
          echo "ğŸ›¡ï¸ ì˜ì¡´ì„± ë³´ì•ˆ ê°ì‚¬..."

          # npm audit
          pnpm audit --audit-level high || {
            echo "âŒ ê³ ìœ„í—˜ ë³´ì•ˆ ì·¨ì•½ì  ë°œê²¬!"
            exit 1
          }

          echo "âœ… ì˜ì¡´ì„± ë³´ì•ˆ ì •ìƒ"

      # í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ìŠ¤ìº”
      - name: Hardcoded Secrets Scan
        run: |
          echo "ğŸ” í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ìŠ¤ìº”..."

          # ê³µí†µ ì‹œí¬ë¦¿ íŒ¨í„´ë“¤
          secret_patterns=(
            "password.*=.*['\"][^'\"]*['\"]"
            "api[_-]?key.*=.*['\"][^'\"]*['\"]"
            "secret.*=.*['\"][^'\"]*['\"]"
            "token.*=.*['\"][^'\"]*['\"]"
            "auth.*=.*['\"][^'\"]*['\"]"
          )

          found_secrets=false

          for pattern in "${secret_patterns[@]}"; do
            if grep -r -i -E "$pattern" src/ --include="*.ts" --include="*.tsx" --include="*.js" --include="*.jsx" | grep -v test | grep -v mock; then
              echo "âš ï¸ ì ì¬ì  í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ë°œê²¬: $pattern"
              found_secrets=true
            fi
          done

          if [ "$found_secrets" = true ]; then
            echo "âŒ í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… í•˜ë“œì½”ë”©ëœ ì‹œí¬ë¦¿ ì—†ìŒ"

      # API ë³´ì•ˆ í…ŒìŠ¤íŠ¸
      - name: API Security Test
        run: |
          echo "ğŸ›¡ï¸ API ë³´ì•ˆ í…ŒìŠ¤íŠ¸..."

          # ê¸°ë³¸ ë³´ì•ˆ í—¤ë” ì²´í¬
          response=$(curl -I -s "${{ secrets.NEXT_PUBLIC_APP_URL }}/api/health")

          # Security headers ì²´í¬
          if ! echo "$response" | grep -i "x-frame-options"; then
            echo "âš ï¸ X-Frame-Options í—¤ë” ëˆ„ë½"
          fi

          if ! echo "$response" | grep -i "x-content-type-options"; then
            echo "âš ï¸ X-Content-Type-Options í—¤ë” ëˆ„ë½"
          fi

          if ! echo "$response" | grep -i "x-xss-protection"; then
            echo "âš ï¸ X-XSS-Protection í—¤ë” ëˆ„ë½"
          fi

          echo "âœ… API ë³´ì•ˆ ì²´í¬ ì™„ë£Œ"

  # ğŸ“Š Stage 3: ì„±ëŠ¥ ê°ì‚¬ (ìˆ˜ë™/ìŠ¤ì¼€ì¤„)
  performance-audit:
    name: 'ğŸ“Š Performance Audit'
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.monitoring_mode == 'performance-audit') ||
      (github.event_name == 'schedule' && github.event.schedule == '0 6 * * *')
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # í”„ë¡œë•ì…˜ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
      - name: Production Performance Metrics
        run: |
          echo "ğŸ“Š í”„ë¡œë•ì…˜ ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘..."

          # ì‘ë‹µ ì‹œê°„ ì¸¡ì • (ì—¬ëŸ¬ ë²ˆ)
          total_time=0
          num_tests=5

          for i in $(seq 1 $num_tests); do
            start_time=$(date +%s%N)
            curl -s "${{ secrets.NEXT_PUBLIC_APP_URL }}" > /dev/null
            end_time=$(date +%s%N)

            duration=$(( (end_time - start_time) / 1000000 ))
            total_time=$((total_time + duration))

            echo "í…ŒìŠ¤íŠ¸ $i: ${duration}ms"
          done

          avg_time=$((total_time / num_tests))
          echo "í‰ê·  ì‘ë‹µ ì‹œê°„: ${avg_time}ms"

          # ì„±ëŠ¥ ê¸°ì¤€ ì²´í¬
          if [ $avg_time -gt 2000 ]; then
            echo "âŒ í‰ê·  ì‘ë‹µ ì‹œê°„ì´ ê¸°ì¤€(2000ms)ì„ ì´ˆê³¼í•©ë‹ˆë‹¤!"
            exit 1
          fi

          echo "âœ… ì„±ëŠ¥ ê¸°ì¤€ í†µê³¼"

      # Lighthouse í”„ë¡œë•ì…˜ ê°ì‚¬
      - name: Lighthouse Production Audit
        run: |
          echo "ğŸ” Lighthouse í”„ë¡œë•ì…˜ ê°ì‚¬..."

          npx lighthouse "${{ secrets.NEXT_PUBLIC_APP_URL }}" \
            --only-categories=performance \
            --output=json \
            --output-path=lighthouse-results.json \
            --chrome-flags="--headless --no-sandbox"

          # ì„±ëŠ¥ ì ìˆ˜ ì¶”ì¶œ
          performance_score=$(node -p "JSON.parse(require('fs').readFileSync('lighthouse-results.json', 'utf8')).categories.performance.score * 100")

          echo "Lighthouse ì„±ëŠ¥ ì ìˆ˜: $performance_score"

          if [ $(echo "$performance_score < 90" | bc) -eq 1 ]; then
            echo "âš ï¸ Lighthouse ì„±ëŠ¥ ì ìˆ˜ê°€ 90 ë¯¸ë§Œì…ë‹ˆë‹¤!"
          fi

          echo "âœ… Lighthouse ê°ì‚¬ ì™„ë£Œ"

  # ğŸ—„ï¸ Stage 4: ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë‹ˆí„°ë§
  database-monitoring:
    name: 'ğŸ—„ï¸ Database Monitoring'
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' && github.event.inputs.monitoring_mode == 'full-diagnostic') ||
      (github.event_name == 'schedule' && github.event.schedule == '0 6 * * *')
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì²´í¬
      - name: Database Connection Check
        run: |
          echo "ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì²´í¬..."

          # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° í…ŒìŠ¤íŠ¸
          if ! pnpm run db:ping; then
            echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹¤íŒ¨"
            exit 1
          fi

          echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì •ìƒ"

      # ë°ì´í„°ë² ì´ìŠ¤ í—¬ìŠ¤ ì²´í¬
      - name: Database Health Check
        run: |
          echo "ğŸ©º ë°ì´í„°ë² ì´ìŠ¤ í—¬ìŠ¤ ì²´í¬..."

          # ê¸°ë³¸ ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
          if ! pnpm run db:health-check; then
            echo "âŒ ë°ì´í„°ë² ì´ìŠ¤ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
            exit 1
          fi

          echo "âœ… ë°ì´í„°ë² ì´ìŠ¤ í—¬ìŠ¤ ì •ìƒ"

  # ğŸ“Š Stage 5: ì¼ì¼/ì£¼ê°„ ë³´ê³ ì„œ
  monitoring-report:
    name: 'ğŸ“Š Monitoring Report'
    runs-on: ubuntu-latest
    needs: [basic-health-check, security-scan, performance-audit, database-monitoring]
    if: always() && (github.event.schedule == '0 6 * * *' || github.event.schedule == '0 9 * * 1')
    timeout-minutes: 5

    steps:
      - name: Generate Monitoring Report
        run: |
          echo "ğŸ“Š ëª¨ë‹ˆí„°ë§ ë³´ê³ ì„œ ìƒì„±..."

          report_type="ì¼ì¼"
          if [[ "${{ github.event.schedule }}" == "0 9 * * 1" ]]; then
            report_type="ì£¼ê°„"
          fi

          echo "====== VideoPlanet $report_type ëª¨ë‹ˆí„°ë§ ë³´ê³ ì„œ ======"
          echo "ìƒì„± ì‹œê°„: $(date)"
          echo ""

          # í—¬ìŠ¤ ì²´í¬ ê²°ê³¼
          if [[ "${{ needs.basic-health-check.result }}" == "success" ]]; then
            echo "âœ… ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬: ì •ìƒ"
          else
            echo "âŒ ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬: ë¬¸ì œ ê°ì§€"
          fi

          # ë³´ì•ˆ ìŠ¤ìº” ê²°ê³¼
          if [[ "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "âœ… ë³´ì•ˆ ìŠ¤ìº”: ë¬¸ì œ ì—†ìŒ"
          elif [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            echo "âŒ ë³´ì•ˆ ìŠ¤ìº”: ë¬¸ì œ ê°ì§€"
          else
            echo "â¸ï¸ ë³´ì•ˆ ìŠ¤ìº”: ê±´ë„ˆëœ€"
          fi

          # ì„±ëŠ¥ ê°ì‚¬ ê²°ê³¼
          if [[ "${{ needs.performance-audit.result }}" == "success" ]]; then
            echo "âœ… ì„±ëŠ¥ ê°ì‚¬: ê¸°ì¤€ ì¶©ì¡±"
          elif [[ "${{ needs.performance-audit.result }}" == "failure" ]]; then
            echo "âŒ ì„±ëŠ¥ ê°ì‚¬: ê¸°ì¤€ ë¯¸ë‹¬"
          else
            echo "â¸ï¸ ì„±ëŠ¥ ê°ì‚¬: ê±´ë„ˆëœ€"
          fi

          # ë°ì´í„°ë² ì´ìŠ¤ ëª¨ë‹ˆí„°ë§ ê²°ê³¼
          if [[ "${{ needs.database-monitoring.result }}" == "success" ]]; then
            echo "âœ… ë°ì´í„°ë² ì´ìŠ¤: ì •ìƒ"
          elif [[ "${{ needs.database-monitoring.result }}" == "failure" ]]; then
            echo "âŒ ë°ì´í„°ë² ì´ìŠ¤: ë¬¸ì œ ê°ì§€"
          else
            echo "â¸ï¸ ë°ì´í„°ë² ì´ìŠ¤: ê±´ë„ˆëœ€"
          fi

          echo ""
          echo "ìƒì„¸ ì •ë³´ëŠ” GitHub Actions ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."

  # ğŸš¨ ê¸´ê¸‰ ì•Œë¦¼ ì²˜ë¦¬
  critical-alert-handler:
    name: 'ğŸš¨ Critical Alert Handler'
    runs-on: ubuntu-latest
    needs: [basic-health-check, security-scan, performance-audit, database-monitoring]
    if: always() && (failure() || contains(needs.*.result, 'failure'))

    steps:
      - name: Critical Issue Detection
        run: |
          echo "ğŸš¨ ê¸´ê¸‰ ì´ìŠˆ ê°ì§€!"

          # ì‹¤íŒ¨í•œ ê²€ì‚¬ë“¤ ì‹ë³„
          failed_checks=""

          if [[ "${{ needs.basic-health-check.result }}" == "failure" ]]; then
            failed_checks="$failed_checks\n- ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.security-scan.result }}" == "failure" ]]; then
            failed_checks="$failed_checks\n- ë³´ì•ˆ ìŠ¤ìº”ì—ì„œ ë¬¸ì œ ë°œê²¬"
          fi

          if [[ "${{ needs.performance-audit.result }}" == "failure" ]]; then
            failed_checks="$failed_checks\n- ì„±ëŠ¥ ê°ì‚¬ ê¸°ì¤€ ë¯¸ë‹¬"
          fi

          if [[ "${{ needs.database-monitoring.result }}" == "failure" ]]; then
            failed_checks="$failed_checks\n- ë°ì´í„°ë² ì´ìŠ¤ ë¬¸ì œ ê°ì§€"
          fi

          echo "ì‹¤íŒ¨í•œ ê²€ì‚¬ë“¤:$failed_checks"

      # ê¸´ê¸‰ Slack ì•Œë¦¼
      - name: Critical Slack Alert
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#alerts-critical'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          text: |
            ğŸš¨ CRITICAL: VideoPlanet ì‹œìŠ¤í…œ ë¬¸ì œ ê°ì§€!

            ì‹œê°„: $(date)

            ì‹¤íŒ¨í•œ ê²€ì‚¬:
            ${{ steps.critical-issue-detection.outputs.failed-checks }}

            ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!
            GitHub Actions: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

      # ì´ë©”ì¼ ì•Œë¦¼ (ì¶”ê°€ ë³´ì•ˆ)
      - name: Critical Email Alert
        if: contains(needs.security-scan.result, 'failure') || contains(needs.database-monitoring.result, 'failure')
        run: |
          echo "ğŸ“§ ê¸´ê¸‰ ìƒí™©ìœ¼ë¡œ ì¸í•œ ì´ë©”ì¼ ì•Œë¦¼ íŠ¸ë¦¬ê±°"
          # ì‹¤ì œ ì´ë©”ì¼ ì „ì†¡ ë¡œì§ì€ ì—¬ê¸°ì— êµ¬í˜„
          # (ì˜ˆ: SendGrid, AWS SES ë“± ì‚¬ìš©)

  # ğŸ¯ ì •ê¸° ìœ ì§€ë³´ìˆ˜ ì•Œë¦¼
  maintenance-reminders:
    name: 'ğŸ”§ Maintenance Reminders'
    runs-on: ubuntu-latest
    if: github.event.schedule == '0 9 * * 1'  # ì£¼ê°„ ì‹¤í–‰
    timeout-minutes: 5

    steps:
      - name: Weekly Maintenance Reminder
        run: |
          echo "ğŸ”§ ì£¼ê°„ ìœ ì§€ë³´ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸..."

          echo "ë‹¤ìŒ í•­ëª©ë“¤ì„ ì ê²€í•˜ì„¸ìš”:"
          echo "- ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ í™•ì¸"
          echo "- ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©"
          echo "- ë¡œê·¸ ì •ë¦¬"
          echo "- ë°±ì—… ìƒíƒœ í™•ì¸"
          echo "- ì„±ëŠ¥ íŠ¸ë Œë“œ ë¶„ì„"

      # ì£¼ê°„ ìœ ì§€ë³´ìˆ˜ ì•Œë¦¼
      - name: Weekly Maintenance Slack Notification
        uses: 8398a7/action-slack@v3
        with:
          status: custom
          channel: '#maintenance'
          webhook_url: ${{ secrets.SLACK_WEBHOOK_URL }}
          custom_payload: |
            {
              "text": "ğŸ”§ ì£¼ê°„ ìœ ì§€ë³´ìˆ˜ ì²´í¬ë¦¬ìŠ¤íŠ¸",
              "attachments": [
                {
                  "color": "warning",
                  "fields": [
                    {
                      "title": "ì´ë²ˆ ì£¼ ì ê²€ í•­ëª©",
                      "value": "â€¢ ì˜ì¡´ì„± ì—…ë°ì´íŠ¸ í™•ì¸\nâ€¢ ë³´ì•ˆ íŒ¨ì¹˜ ì ìš©\nâ€¢ ë¡œê·¸ ì •ë¦¬\nâ€¢ ë°±ì—… ìƒíƒœ í™•ì¸\nâ€¢ ì„±ëŠ¥ íŠ¸ë Œë“œ ë¶„ì„",
                      "short": false
                    }
                  ]
                }
              ]
            }