name: Vercel Deployment Safety & Build Determinism
# Vercel ë°°í¬ ì „ ë¹Œë“œ ì•ˆì •ì„± ë° ê²°ì •ì„± ê²€ì¦

on:
  deployment_status:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'next.config.mjs'
      - 'vercel.json'
      - 'prisma/**'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
  VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}

# ë™ì‹œ ì‹¤í–‰ ì œí•œ (ë¦¬ì†ŒìŠ¤ ìµœì í™”)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ğŸ” Stage 1: Vercel ë¹Œë“œ ì‚¬ì „ ê²€ì¦
  pre-deployment-validation:
    name: 'ğŸ” Pre-deployment Build Validation'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    outputs:
      should-deploy: ${{ steps.validation.outputs.should-deploy }}
      build-hash: ${{ steps.build-info.outputs.build-hash }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Prisma í´ë¼ì´ì–¸íŠ¸ ìƒì„± ê²€ì¦
      - name: Prisma Client Generation Test
        run: |
          echo "ğŸ”§ Prisma Client ìƒì„± ê²€ì¦..."
          pnpm prisma generate

          # ìƒì„±ëœ í´ë¼ì´ì–¸íŠ¸ê°€ ì˜¬ë°”ë¥¸ì§€ ê²€ì¦
          if [ ! -f "node_modules/.prisma/client/index.js" ]; then
            echo "âŒ Prisma Client ìƒì„± ì‹¤íŒ¨!"
            exit 1
          fi

          echo "âœ… Prisma Client ìƒì„± ì„±ê³µ"

      # í™˜ê²½ë³€ìˆ˜ ê²€ì¦ (Vercelê³¼ ë™ì¼í•œ ì¡°ê±´)
      - name: Environment Variables Validation
        run: |
          echo "ğŸŒ í™˜ê²½ë³€ìˆ˜ ê²€ì¦..."

          # í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ì²´í¬ ë¦¬ìŠ¤íŠ¸
          required_vars=(
            "DATABASE_URL"
            "JWT_SECRET"
            "NEXT_PUBLIC_APP_URL"
            "SUPABASE_URL"
            "SUPABASE_ANON_KEY"
          )

          missing_vars=()
          for var in "${required_vars[@]}"; do
            if [ -z "${!var:-}" ] && [ -z "${{ secrets[var] || '' }}" ]; then
              missing_vars+=("$var")
            fi
          done

          if [ ${#missing_vars[@]} -eq 0 ]; then
            echo "âœ… ëª¨ë“  í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸ë¨"
          else
            echo "âŒ ëˆ„ë½ëœ í™˜ê²½ë³€ìˆ˜: ${missing_vars[*]}"
            echo "Vercelì—ì„œ í•´ë‹¹ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•´ì£¼ì„¸ìš”."
            exit 1
          fi
        env:
          DATABASE_URL: ${{ secrets.DATABASE_URL || 'postgresql://test:test@localhost:5432/test' }}
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'ci-test-secret-32-chars-minimum-length' }}
          NEXT_PUBLIC_APP_URL: ${{ secrets.NEXT_PUBLIC_APP_URL || 'http://localhost:3000' }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL || 'https://ci-test.supabase.co' }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY || 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test-ci-token' }}

      # Vercelê³¼ ë™ì¼í•œ ë¹Œë“œ ì‹¤í–‰
      - name: Vercel-identical Build Test
        id: build-test
        run: |
          echo "ğŸ—ï¸ Vercel ë™ì¼ ì¡°ê±´ ë¹Œë“œ í…ŒìŠ¤íŠ¸..."

          # Vercel buildCommandì™€ ë™ì¼í•˜ê²Œ ì‹¤í–‰
          pnpm run vercel-build

          echo "âœ… Vercel ë¹Œë“œ í…ŒìŠ¤íŠ¸ ì„±ê³µ"

      # ë¹Œë“œ ê²°ì •ì„± ê²€ì¦ (2íšŒ ë¹Œë“œ ë¹„êµ)
      - name: Build Determinism Check
        run: |
          echo "ğŸ”„ ë¹Œë“œ ê²°ì •ì„± ê²€ì¦..."

          # ì²« ë²ˆì§¸ ë¹Œë“œ
          rm -rf .next
          pnpm run vercel-build
          cp -r .next .next.first

          # ë‘ ë²ˆì§¸ ë¹Œë“œ
          rm -rf .next
          pnpm run vercel-build
          cp -r .next .next.second

          # ë¹Œë“œ ê²°ê³¼ ë¹„êµ
          if diff -r .next.first .next.second > /dev/null 2>&1; then
            echo "âœ… ë¹Œë“œ ê²°ì •ì„± ê²€ì¦ ì„±ê³µ - ë™ì¼í•œ ê²°ê³¼"
          else
            echo "âŒ ë¹Œë“œ ê²°ì •ì„± ì‹¤íŒ¨ - ë¹Œë“œë§ˆë‹¤ ë‹¤ë¥¸ ê²°ê³¼"
            echo "ì°¨ì´ì :"
            diff -r .next.first .next.second || true
            exit 1
          fi

      # ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘
      - name: Collect Build Information
        id: build-info
        run: |
          echo "ğŸ“Š ë¹Œë“œ ì •ë³´ ìˆ˜ì§‘..."

          build_size=$(du -sh .next | cut -f1)
          build_hash=$(find .next -type f -exec sha256sum {} \; | sha256sum | cut -d' ' -f1)

          echo "build-hash=$build_hash" >> $GITHUB_OUTPUT
          echo "build-size=$build_size" >> $GITHUB_OUTPUT

          echo "âœ… ë¹Œë“œ í¬ê¸°: $build_size"
          echo "âœ… ë¹Œë“œ í•´ì‹œ: $build_hash"

      - name: Validation Result
        id: validation
        run: |
          echo "should-deploy=true" >> $GITHUB_OUTPUT
          echo "âœ… ëª¨ë“  ì‚¬ì „ ê²€ì¦ í†µê³¼ - Vercel ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"

  # ğŸš€ Stage 2: Vercel ë°°í¬ (ì‹¤ì œ ë°°í¬ëŠ” Vercelì´ ì²˜ë¦¬)
  vercel-deployment-monitor:
    name: 'ğŸ“¡ Vercel Deployment Monitor'
    runs-on: ubuntu-latest
    needs: pre-deployment-validation
    if: needs.pre-deployment-validation.outputs.should-deploy == 'true'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      # Vercel ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§
      - name: Monitor Vercel Deployment
        run: |
          echo "ğŸ“¡ Vercel ë°°í¬ ìƒíƒœ ëª¨ë‹ˆí„°ë§..."

          # ìµœê·¼ ë°°í¬ ìƒíƒœ í™•ì¸
          vercel ls --token=${{ secrets.VERCEL_TOKEN }} || {
            echo "âš ï¸ Vercel CLI ì¸ì¦ ì‹¤íŒ¨ - ìˆ˜ë™ í™•ì¸ í•„ìš”"
            exit 0
          }

          echo "âœ… Vercel ë°°í¬ ìƒíƒœ í™•ì¸ ì™„ë£Œ"

  # ğŸ” Stage 3: ë°°í¬ í›„ ê²€ì¦
  post-deployment-verification:
    name: 'âœ… Post-deployment Health Check'
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, vercel-deployment-monitor]
    if: github.event_name == 'deployment_status' && github.event.deployment_status.state == 'success'
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Health Check
        run: |
          echo "ğŸ¥ ë°°í¬ í›„ í—¬ìŠ¤ ì²´í¬..."

          # ë°°í¬ëœ URL í™•ì¸
          DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"

          if [ -z "$DEPLOYMENT_URL" ]; then
            echo "âš ï¸ ë°°í¬ URLì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 0
          fi

          echo "ğŸŒ ë°°í¬ URL: $DEPLOYMENT_URL"

          # ê¸°ë³¸ í—¬ìŠ¤ ì²´í¬
          response=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL" || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… ë°°í¬ í—¬ìŠ¤ ì²´í¬ ì„±ê³µ (HTTP 200)"
          else
            echo "âŒ ë°°í¬ í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (HTTP $response)"

            # ìƒì„¸ ì—ëŸ¬ ë¡œê·¸ ìˆ˜ì§‘
            curl -v "$DEPLOYMENT_URL" || true
            exit 1
          fi

      # API ì—”ë“œí¬ì¸íŠ¸ í—¬ìŠ¤ ì²´í¬
      - name: API Health Check
        run: |
          echo "ğŸ”§ API ì—”ë“œí¬ì¸íŠ¸ í—¬ìŠ¤ ì²´í¬..."

          DEPLOYMENT_URL="${{ github.event.deployment_status.target_url }}"

          if [ -z "$DEPLOYMENT_URL" ]; then
            exit 0
          fi

          # /api/health ì—”ë“œí¬ì¸íŠ¸ ì²´í¬
          api_response=$(curl -s -o /dev/null -w "%{http_code}" "$DEPLOYMENT_URL/api/health" || echo "000")

          if [ "$api_response" = "200" ]; then
            echo "âœ… API í—¬ìŠ¤ ì²´í¬ ì„±ê³µ (HTTP 200)"
          else
            echo "âš ï¸ API í—¬ìŠ¤ ì²´í¬ ì‹¤íŒ¨ (HTTP $api_response) - í™•ì¸ í•„ìš”"
          fi

  # ğŸ“Š ìµœì¢… ê²°ê³¼ ìš”ì•½
  deployment-summary:
    name: 'ğŸ“Š Deployment Quality Summary'
    runs-on: ubuntu-latest
    needs: [pre-deployment-validation, vercel-deployment-monitor, post-deployment-verification]
    if: always()

    steps:
      - name: Deployment Summary
        run: |
          echo "ğŸ“Š Vercel ë°°í¬ í’ˆì§ˆ ìš”ì•½"
          echo "=========================================="

          if [[ "${{ needs.pre-deployment-validation.result }}" == "success" ]]; then
            echo "âœ… ì‚¬ì „ ê²€ì¦: í†µê³¼ (ë¹Œë“œ ê²°ì •ì„±, Prisma, í™˜ê²½ë³€ìˆ˜)"
          else
            echo "âŒ ì‚¬ì „ ê²€ì¦: ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.vercel-deployment-monitor.result }}" == "success" ]]; then
            echo "âœ… ë°°í¬ ëª¨ë‹ˆí„°ë§: ì„±ê³µ"
          else
            echo "âš ï¸ ë°°í¬ ëª¨ë‹ˆí„°ë§: ìŠ¤í‚µ ë˜ëŠ” ì‹¤íŒ¨"
          fi

          if [[ "${{ needs.post-deployment-verification.result }}" == "success" ]]; then
            echo "âœ… ë°°í¬ í›„ ê²€ì¦: ì„±ê³µ"
          else
            echo "âš ï¸ ë°°í¬ í›„ ê²€ì¦: ìŠ¤í‚µ ë˜ëŠ” ì‹¤íŒ¨"
          fi

          # ì „ì²´ ê²°ê³¼ í‰ê°€
          if [[ "${{ needs.pre-deployment-validation.result }}" == "success" ]]; then
            echo ""
            echo "ğŸ‰ Vercel ë°°í¬ í’ˆì§ˆ ê²€ì¦ ì™„ë£Œ!"
            echo "ğŸ”§ ë¹Œë“œ ê²°ì •ì„±: ë³´ì¥ë¨"
            echo "âš¡ Prisma ì•ˆì •ì„±: ê²€ì¦ë¨"
            echo "ğŸŒ í™˜ê²½ë³€ìˆ˜: ìœ íš¨í•¨"

            if [[ -n "${{ needs.pre-deployment-validation.outputs.build-hash }}" ]]; then
              echo "ğŸ” ë¹Œë“œ í•´ì‹œ: ${{ needs.pre-deployment-validation.outputs.build-hash }}"
            fi
          else
            echo ""
            echo "ğŸš¨ ë°°í¬ í’ˆì§ˆ ê²€ì¦ ì‹¤íŒ¨!"
            echo "ìœ„ ì‹¤íŒ¨í•œ ê²€ì¦ì„ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”."
          fi