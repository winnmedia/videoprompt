name: ğŸ›¡ï¸ Grace QA Lead Quality Gates

on:
  pull_request:
    branches: [main, develop]
    paths:
      - 'src/**'
      - 'scripts/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'tsconfig.json'
      - 'vitest.config.*'
      - 'eslint.config.*'
      - '.github/workflows/**'
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      mutation_testing:
        description: 'Run full mutation testing'
        required: false
        default: 'false'
        type: boolean
      quality_level:
        description: 'Quality check level'
        required: false
        default: 'standard'
        type: choice
        options:
          - 'quick'
          - 'standard'
          - 'comprehensive'

# Graceì˜ ë¬´ê´€ìš© ì •ì±…: ë™ì‹œ ì‹¤í–‰ ë°©ì§€
concurrency:
  group: quality-gates-${{ github.ref }}
  cancel-in-progress: true

# í™˜ê²½ ë³€ìˆ˜ ì„¤ì •
env:
  NODE_VERSION: '20.19.0'
  PNPM_VERSION: '9.0.0'
  # Grace QA ì „ìš© í™˜ê²½
  GRACE_QA_MODE: 'true'
  MUTATION_TESTING_ENABLED: ${{ github.event.inputs.mutation_testing || 'false' }}
  QUALITY_LEVEL: ${{ github.event.inputs.quality_level || 'standard' }}

jobs:
  # Stage 1: ë¹ ë¥¸ ê²€ì¦ (2ë¶„ ì´ë‚´ - Grace ê¸°ì¤€)
  fast-validation:
    name: ğŸš€ Fast Validation (Grace Stage 1)
    runs-on: ubuntu-latest
    timeout-minutes: 5
    outputs:
      should_continue: ${{ steps.validation.outputs.continue }}
      cost_risk_detected: ${{ steps.cost_check.outputs.risk_detected }}

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ”§ Setup Node.js & pnpm
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ğŸ’¾ Cache Dependencies
        uses: actions/cache@v4
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: deps-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: deps-${{ runner.os }}-

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸš¨ $300 Cost Prevention Check (ìµœìš°ì„ )
        id: cost_check
        run: |
          echo "ğŸš¨ Grace QA: $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ê²€ì‚¬ ì‹œì‘"

          # TDD ê¸°ë°˜ ë¹„ìš© ë°©ì§€ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
          if ! pnpm test src/__tests__/quality-gates/cost-prevention.test.ts; then
            echo "::error::$300 ë°©ì§€ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨!"
            echo "risk_detected=true" >> $GITHUB_OUTPUT
            exit 1
          fi

          # ì½”ë“œë² ì´ìŠ¤ ìŠ¤ìº”
          if find src/ -name "*.tsx" -o -name "*.ts" | grep -v __tests__ | head -10 | xargs -I {} npx tsx scripts/cost-prevention-analyzer.ts {} > cost-analysis.log 2>&1; then
            echo "âœ… ë¹„ìš© ìœ„í—˜ íŒ¨í„´ ì—†ìŒ"
            echo "risk_detected=false" >> $GITHUB_OUTPUT
          else
            echo "::error::ë¹„ìš© ìœ„í—˜ íŒ¨í„´ ê°ì§€ë¨!"
            cat cost-analysis.log
            echo "risk_detected=true" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ” TypeScript Type Check
        run: pnpm run type-check

      - name: ğŸ¯ ESLint (ì—„ê²© ëª¨ë“œ)
        run: |
          pnpm run lint
          # Grace ì¶”ê°€ ê·œì¹™: ê²½ê³ ë„ ì‹¤íŒ¨ ì²˜ë¦¬
          if pnpm run lint 2>&1 | grep -i warning; then
            echo "::error::Grace QA: ESLint ê²½ê³ ë„ í—ˆìš©í•˜ì§€ ì•ŠìŒ"
            exit 1
          fi

      - name: âš¡ Unit Tests (ë¹ ë¥¸ ì‹¤í–‰)
        run: |
          pnpm test --run --coverage=false \
            --exclude="**/integration/**" \
            --exclude="**/e2e/**" \
            --exclude="**/performance/**"

      - name: ğŸ“Š Validation Summary
        id: validation
        run: |
          echo "continue=true" >> $GITHUB_OUTPUT
          echo "âœ… Fast Validation ì™„ë£Œ - Grace QA Stage 1 í†µê³¼"

  # Stage 2: í†µí•© ê²€ì¦ (Graceì˜ í•µì‹¬ í’ˆì§ˆ ê²Œì´íŠ¸)
  integration-validation:
    name: ğŸ”— Integration Validation (Grace Stage 2)
    runs-on: ubuntu-latest
    needs: fast-validation
    if: needs.fast-validation.outputs.should_continue == 'true'
    timeout-minutes: 15

    strategy:
      matrix:
        test-suite:
          - name: 'auth-security'
            pattern: 'src/__tests__/auth/**'
            description: 'ì¸ì¦ ì‹œìŠ¤í…œ ë³´ì•ˆ í…ŒìŠ¤íŠ¸'
          - name: 'api-safety'
            pattern: 'src/__tests__/integration/api-*'
            description: 'API ì•ˆì „ì„± í…ŒìŠ¤íŠ¸'
          - name: 'planning-integrity'
            pattern: 'src/__tests__/planning/**'
            description: 'Planning ë°ì´í„° ë¬´ê²°ì„± í…ŒìŠ¤íŠ¸'

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js & pnpm
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§ª ${{ matrix.test-suite.description }}
        env:
          INTEGRATION_TEST: 'true'
        run: |
          echo "ğŸ§ª Grace QA: ${{ matrix.test-suite.description }} ì‹¤í–‰"

          # í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ë°©ì§€: 3íšŒ ì—°ì† ì„±ê³µ í•„ìš”
          for i in {1..3}; do
            echo "ì‹¤í–‰ $i/3: ${{ matrix.test-suite.description }}"
            if ! pnpm test "${{ matrix.test-suite.pattern }}" --run; then
              echo "::error::í…ŒìŠ¤íŠ¸ ì‹¤í–‰ $i ì‹¤íŒ¨ - í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±"
              exit 1
            fi
          done

          echo "âœ… ${{ matrix.test-suite.description }} 3íšŒ ì—°ì† ì„±ê³µ"

      - name: ğŸ“ˆ Coverage Analysis
        if: matrix.test-suite.name == 'auth-security'
        run: |
          pnpm test "${{ matrix.test-suite.pattern }}" --coverage

          # Grace ê¸°ì¤€: ì¸ì¦ ì‹œìŠ¤í…œ 100% ì»¤ë²„ë¦¬ì§€ í•„ìˆ˜
          if ! node -e "
            const coverage = require('./coverage/coverage-summary.json');
            const authCoverage = coverage.total.lines.pct;
            if (authCoverage < 95) {
              console.error('Grace QA: ì¸ì¦ ì‹œìŠ¤í…œ ì»¤ë²„ë¦¬ì§€ ' + authCoverage + '% < 95%');
              process.exit(1);
            }
            console.log('âœ… ì¸ì¦ ì‹œìŠ¤í…œ ì»¤ë²„ë¦¬ì§€: ' + authCoverage + '%');
          "; then
            exit 1
          fi

  # Stage 3: Graceì˜ ìµœì¢… í’ˆì§ˆ ê²€ì¦
  mutation-testing:
    name: ğŸ§¬ Mutation Testing (Grace Ultimate)
    runs-on: ubuntu-latest
    needs: [fast-validation, integration-validation]
    if: >
      needs.fast-validation.outputs.should_continue == 'true' &&
      needs.fast-validation.outputs.cost_risk_detected == 'false' &&
      (github.event.inputs.mutation_testing == 'true' || github.ref == 'refs/heads/main')
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js & pnpm
        uses: ./.github/actions/setup-node
        with:
          node-version: ${{ env.NODE_VERSION }}
          pnpm-version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“¦ Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸ§¬ Critical System Mutation Testing
        run: |
          echo "ğŸ§¬ Grace QA: í•µì‹¬ ì‹œìŠ¤í…œ Mutation Testing"

          # $300 ë°©ì§€ ì‹œìŠ¤í…œë¶€í„° í…ŒìŠ¤íŠ¸
          npx stryker run --configFile stryker-critical.conf.mjs || {
            echo "::error::$300 ë°©ì§€ ì‹œìŠ¤í…œ Mutation Score 80% ë¯¸ë§Œ!"
            exit 1
          }

      - name: ğŸ† Full Mutation Testing
        if: env.QUALITY_LEVEL == 'comprehensive'
        run: |
          mkdir -p reports/mutation
          npx stryker run

          # Grace í’ˆì§ˆ ê¸°ì¤€ ê²€ì¦
          mutation_score=$(node -e "
            try {
              const report = require('./reports/mutation/mutation-report.json');
              console.log(Math.round(report.thresholds.break));
            } catch(e) {
              console.log('0');
            }
          ")

          if [ "$mutation_score" -lt 80 ]; then
            echo "::error::Mutation Score ${mutation_score}% < 80% (Grace ê¸°ì¤€)"
            exit 1
          fi

          echo "âœ… Mutation Testing í†µê³¼: ${mutation_score}%"

      - name: ğŸ“Š Mutation Report Upload
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: reports/mutation/
          retention-days: 30

  # Stage 4: ìµœì¢… ìŠ¹ì¸ ë° ë°°í¬ ê²Œì´íŠ¸
  grace-final-approval:
    name: ğŸ† Grace QA Final Approval
    runs-on: ubuntu-latest
    needs: [fast-validation, integration-validation, mutation-testing]
    if: always()
    timeout-minutes: 5

    steps:
      - name: ğŸ“Š Quality Gate Analysis
        run: |
          echo "ğŸ† Grace QA Lead ìµœì¢… í’ˆì§ˆ ë¶„ì„"

          # ê° ë‹¨ê³„ ê²°ê³¼ í™•ì¸
          fast_result="${{ needs.fast-validation.result }}"
          integration_result="${{ needs.integration-validation.result }}"
          mutation_result="${{ needs.mutation-testing.result }}"
          cost_risk="${{ needs.fast-validation.outputs.cost_risk_detected }}"

          echo "Fast Validation: $fast_result"
          echo "Integration Tests: $integration_result"
          echo "Mutation Testing: $mutation_result"
          echo "Cost Risk: $cost_risk"

          # Graceì˜ ë¬´ê´€ìš© ì •ì±… ì ìš©
          if [ "$cost_risk" = "true" ]; then
            echo "::error::ğŸš¨ Grace QA: $300 ìœ„í—˜ ê°ì§€ - ë°°í¬ ì¦‰ì‹œ ì°¨ë‹¨!"
            exit 1
          fi

          if [ "$fast_result" != "success" ]; then
            echo "::error::ğŸš¨ Grace QA: Fast Validation ì‹¤íŒ¨ - ê¸°ë³¸ í’ˆì§ˆ ê¸°ì¤€ ë¯¸ë‹¬"
            exit 1
          fi

          if [ "$integration_result" != "success" ]; then
            echo "::error::ğŸš¨ Grace QA: Integration Testing ì‹¤íŒ¨ - ì‹œìŠ¤í…œ í†µí•© í’ˆì§ˆ ë¯¸ë‹¬"
            exit 1
          fi

          # Mutation Testingì€ ì„ íƒì  (main ë¸Œëœì¹˜ëŠ” í•„ìˆ˜)
          if [ "${{ github.ref }}" = "refs/heads/main" ] && [ "$mutation_result" != "success" ]; then
            echo "::error::ğŸš¨ Grace QA: Main ë¸Œëœì¹˜ Mutation Testing í•„ìˆ˜ - ë°°í¬ ì°¨ë‹¨"
            exit 1
          fi

          echo "âœ… Grace QA Lead ìµœì¢… ìŠ¹ì¸: ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼!"
          echo "âœ… $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™"
          echo "âœ… ë¬´ê²°ì„± ë³´ì¥: í”Œë˜í‚¤ í…ŒìŠ¤íŠ¸ 0%, í’ˆì§ˆ ê¸°ì¤€ ë‹¬ì„±"

      - name: ğŸ‰ Quality Gates Passed
        run: |
          echo "ğŸ‰ ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼!"
          echo "Grace QA Lead ìŠ¹ì¸: PR ë³‘í•© ê°€ëŠ¥"
          echo ""
          echo "ğŸ“Š í’ˆì§ˆ ìš”ì•½:"
          echo "- $300 ì‚¬ê±´ ë°©ì§€: âœ…"
          echo "- íƒ€ì… ì•ˆì „ì„±: âœ…"
          echo "- ì½”ë“œ í’ˆì§ˆ: âœ…"
          echo "- í…ŒìŠ¤íŠ¸ í†µê³¼: âœ…"
          echo "- í†µí•© í…ŒìŠ¤íŠ¸: âœ…"
          echo "- ë³´ì•ˆ ê²€ì¦: âœ…"
          echo ""
          echo "ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ!"

  # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ ë° ë¶„ì„
  failure-analysis:
    name: ğŸ“‰ Failure Analysis & Notification
    runs-on: ubuntu-latest
    needs: [fast-validation, integration-validation, mutation-testing, grace-final-approval]
    if: failure()

    steps:
      - name: ğŸ“Š Failure Analysis
        run: |
          echo "ğŸ“‰ Grace QA: í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤íŒ¨ ë¶„ì„"
          echo ""
          echo "ì‹¤íŒ¨ ë‹¨ê³„:"
          echo "- Fast Validation: ${{ needs.fast-validation.result }}"
          echo "- Integration Tests: ${{ needs.integration-validation.result }}"
          echo "- Mutation Testing: ${{ needs.mutation-testing.result }}"
          echo "- Final Approval: ${{ needs.grace-final-approval.result }}"
          echo ""
          echo "ğŸš¨ Grace QA ë¬´ê´€ìš© ì •ì±…: ëª¨ë“  í’ˆì§ˆ ê¸°ì¤€ì„ ì¶©ì¡±í•´ì•¼ í•©ë‹ˆë‹¤."
          echo "ğŸ’¡ ìˆ˜ì • í›„ ë‹¤ì‹œ í‘¸ì‹œí•˜ì—¬ í’ˆì§ˆ ê²Œì´íŠ¸ë¥¼ ì¬ì‹¤í–‰í•˜ì„¸ìš”."

      - name: ğŸš¨ Critical Alert
        if: needs.fast-validation.outputs.cost_risk_detected == 'true'
        run: |
          echo "::error::ğŸš¨ğŸš¨ğŸš¨ CRITICAL: $300 ì‚¬ê±´ ì¬ë°œ ìœ„í—˜ ê°ì§€!"
          echo "::error::Grace QA ê¸´ê¸‰ ëŒ€ì‘: ì¦‰ì‹œ ì½”ë“œ ìˆ˜ì • í•„ìš”"
          echo "::error::ë°°í¬ ì™„ì „ ì°¨ë‹¨: ë¹„ìš© ìœ„í—˜ íŒ¨í„´ ì œê±° í›„ ì¬ì‹œë„"