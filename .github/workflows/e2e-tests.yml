name: E2E Tests - UserJourneyMap 22ë‹¨ê³„

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:

env:
  # ë¹„ìš© ì•ˆì „ í™˜ê²½ ë³€ìˆ˜ ($300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€)
  COST_SAFETY_MAX_API_CALLS: 100
  COST_SAFETY_TIMEOUT: 5000
  CYPRESS_CACHE_FOLDER: ~/.cache/Cypress

jobs:
  quality-gates:
    name: í’ˆì§ˆ ê²Œì´íŠ¸ ê²€ì¦
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: TypeScript íƒ€ì… ê²€ì‚¬
        run: pnpm run typecheck

      - name: ESLint ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
        run: pnpm run lint

      - name: Prettier í¬ë§· ê²€ì‚¬
        run: pnpm run format:check

      - name: Jest ë‹¨ìœ„ í…ŒìŠ¤íŠ¸
        run: pnpm run test

      - name: ìˆœí™˜ ì˜ì¡´ì„± ê²€ì‚¬
        run: pnpm run check:circular-deps

  e2e-tests:
    name: E2E í…ŒìŠ¤íŠ¸ - UserJourneyMap 22ë‹¨ê³„
    runs-on: ubuntu-latest
    needs: quality-gates
    strategy:
      matrix:
        # ë³‘ë ¬ ì‹¤í–‰ìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ì‹œê°„ ë‹¨ì¶•
        shard: [1, 2]
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: Cypress ìºì‹œ ë³µì›
        uses: actions/cache@v4
        with:
          path: ~/.cache/Cypress
          key: cypress-${{ runner.os }}-${{ hashFiles('pnpm-lock.yaml') }}
          restore-keys: |
            cypress-${{ runner.os }}-

      - name: Cypress ì„¤ì¹˜
        run: pnpm cypress install

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: pnpm run build
        env:
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ ì„¤ì •
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
        run: |
          pnpm run start &
          sleep 30
        env:
          PORT: 3000
          NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„ ìƒíƒœ í™•ì¸
        run: |
          timeout 60 bash -c 'until curl -f http://localhost:3000/api/health; do sleep 2; done'

      - name: Cypress E2E í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        uses: cypress-io/github-action@v6
        with:
          command: pnpm cypress run --record false --spec "cypress/e2e/**/*.cy.ts"
          wait-on: 'http://localhost:3000'
          wait-on-timeout: 120
          browser: chrome
          headed: false
        env:
          # ë¹„ìš© ì•ˆì „ ì„¤ì •
          CYPRESS_COST_SAFETY_MAX_API_CALLS: ${{ env.COST_SAFETY_MAX_API_CALLS }}
          CYPRESS_COST_SAFETY_TIMEOUT: ${{ env.COST_SAFETY_TIMEOUT }}
          CYPRESS_COST_SAFETY_ENABLE_MOCKING: true
          # í…ŒìŠ¤íŠ¸ í™˜ê²½ ë³€ìˆ˜
          CYPRESS_BASE_URL: http://localhost:3000
          CYPRESS_NEXT_PUBLIC_SUPABASE_URL: ${{ secrets.NEXT_PUBLIC_SUPABASE_URL }}
          CYPRESS_NEXT_PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }}
          # í…ŒìŠ¤íŠ¸ ì‚¬ìš©ì ì •ë³´
          CYPRESS_TEST_USER_EMAIL: test@videoprompt.com
          CYPRESS_TEST_USER_PASSWORD: TestPassword123!

      - name: í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-results-${{ matrix.shard }}
          path: |
            cypress/screenshots/
            cypress/videos/
            cypress/reports/
          retention-days: 7

      - name: ì„±ëŠ¥ ì˜ˆì‚° ê²€ì‚¬
        if: always()
        run: |
          # Lighthouse CIë¡œ ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦
          if [ -f "lighthouse-ci-results.json" ]; then
            echo "ì„±ëŠ¥ ì˜ˆì‚° ê²€ì¦ ì¤‘..."
            # Core Web Vitals ì²´í¬ ë¡œì§
          fi

  accessibility-tests:
    name: ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ (A11y)
    runs-on: ubuntu-latest
    needs: quality-gates
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: pnpm ì„¤ì¹˜
        uses: pnpm/action-setup@v4
        with:
          version: 8

      - name: ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ
        run: pnpm run build

      - name: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ (ë°±ê·¸ë¼ìš´ë“œ)
        run: |
          pnpm run start &
          sleep 30

      - name: axe-core ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸
        run: |
          # Cypressë¡œ ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
          pnpm cypress run --spec "cypress/e2e/accessibility/*.cy.ts"

  security-scan:
    name: ë³´ì•ˆ ê²€ì‚¬ (SAST)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout ì½”ë“œ
        uses: actions/checkout@v4

      - name: CodeQL ì´ˆê¸°í™”
        uses: github/codeql-action/init@v3
        with:
          languages: javascript

      - name: CodeQL ë¶„ì„
        uses: github/codeql-action/analyze@v3

      - name: npm audit ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
        run: |
          pnpm audit --audit-level moderate

  deployment-readiness:
    name: ë°°í¬ ì¤€ë¹„ì„± ê²€ì¦
    runs-on: ubuntu-latest
    needs: [quality-gates, e2e-tests, accessibility-tests, security-scan]
    if: always()
    steps:
      - name: ëª¨ë“  ê²€ì‚¬ ê²°ê³¼ í™•ì¸
        run: |
          echo "âœ… í’ˆì§ˆ ê²Œì´íŠ¸: ${{ needs.quality-gates.result }}"
          echo "âœ… E2E í…ŒìŠ¤íŠ¸: ${{ needs.e2e-tests.result }}"
          echo "âœ… ì ‘ê·¼ì„± í…ŒìŠ¤íŠ¸: ${{ needs.accessibility-tests.result }}"
          echo "âœ… ë³´ì•ˆ ê²€ì‚¬: ${{ needs.security-scan.result }}"

          if [[ "${{ needs.quality-gates.result }}" == "success" &&
                "${{ needs.e2e-tests.result }}" == "success" &&
                "${{ needs.accessibility-tests.result }}" == "success" &&
                "${{ needs.security-scan.result }}" == "success" ]]; then
            echo "ğŸ‰ ëª¨ë“  ê²€ì¦ í†µê³¼! ë°°í¬ ì¤€ë¹„ ì™„ë£Œ"
          else
            echo "âŒ ì¼ë¶€ ê²€ì¦ ì‹¤íŒ¨. ë°°í¬ ë¶ˆê°€"
            exit 1
          fi

      - name: ë°°í¬ ì¤€ë¹„ ìƒíƒœ ìŠ¬ë™ ì•Œë¦¼
        if: always()
        run: |
          # ìŠ¬ë™ ì›¹í›…ìœ¼ë¡œ ë°°í¬ ì¤€ë¹„ ìƒíƒœ ì•Œë¦¼
          echo "ë°°í¬ ì¤€ë¹„ ìƒíƒœ ì•Œë¦¼ (êµ¬í˜„ ì˜ˆì •)"
