name: Enhanced Quality Gates - Zero Regression Policy

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - 'src/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - '.github/workflows/**'
      - 'scripts/**'
      - 'tests/**'

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'
  MUTATION_THRESHOLD: '75'
  COVERAGE_THRESHOLD: '85'

# ë™ì‹œ ì‹¤í–‰ ì œí•œ (ë¦¬ì†ŒìŠ¤ ìµœì í™”)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # âš¡ Stage 0: Pre-flight ì²´í¬ (30ì´ˆ ì´ë‚´ Fail-Fast)
  pre-flight-check:
    name: 'ğŸš€ Pre-flight Check (30s)'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      should-skip: ${{ steps.skip-check.outputs.should_skip }}
      paths-result: ${{ steps.skip-check.outputs.paths_result }}

    steps:
      - name: Skip Duplicate Actions
        id: skip-check
        uses: fkirc/skip-duplicate-actions@v5
        with:
          concurrent_skipping: 'same_content_newer'
          skip_after_successful_duplicate: 'true'
          paths_ignore: '["**.md", "docs/**", ".gitignore"]'

      - name: Report Pre-flight Status
        run: |
          echo "ğŸš€ Pre-flight ì²´í¬ ì™„ë£Œ"
          echo "Skip: ${{ steps.skip-check.outputs.should_skip }}"
          echo "Paths: ${{ steps.skip-check.outputs.paths_result }}"

  # ğŸ”¥ Stage 1: ì´ˆê³ ì† í’ˆì§ˆ ê²€ì¦ (2ë¶„ ì´ë‚´)
  lightning-fast-quality-check:
    name: 'âš¡ Lightning Fast Quality Check'
    runs-on: ubuntu-latest
    needs: pre-flight-check
    if: needs.pre-flight-check.outputs.should-skip != 'true'
    timeout-minutes: 3

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: ğŸ›¡ï¸ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ (ìµœìš°ì„ )
        run: |
          echo "ğŸ›¡ï¸ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹œì‘..."
          pnpm validate-env || {
            echo "âŒ CRITICAL: í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ì‹¤íŒ¨ - ë°°í¬ ì°¨ë‹¨!"
            echo "í•´ê²°ë°©ë²•: í”„ë¡œì íŠ¸ ë£¨íŠ¸ì˜ .env íŒŒì¼ì— í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ë¥¼ ì„¤ì •í•˜ì„¸ìš”"
            exit 1
          }
          echo "âœ… í™˜ê²½ë³€ìˆ˜ ê²€ì¦ í†µê³¼"

      - name: ğŸš¨ $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì²´í¬ (ìµœìš°ì„ )
        run: |
          echo "ğŸš¨ $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì²´í¬ ì‹œì‘..."

          # 1. useEffect ì˜ì¡´ì„± ë°°ì—´ ìœ„í—˜ íŒ¨í„´
          if grep -r "useEffect.*\[.*[a-zA-Z_][a-zA-Z0-9_]*\]" src/ --include="*.tsx" --include="*.ts" | grep -v "test" | grep -v "\.d\.ts" | head -5; then
            echo "âŒ CRITICAL: useEffect ì˜ì¡´ì„± ë°°ì—´ì— í•¨ìˆ˜ í¬í•¨ - $300 ì‚¬ê±´ ìœ„í—˜!"
            echo "í•´ê²°ë°©ë²•: useEffect(() => { func(); }, []) // ë¹ˆ ë°°ì—´ ì‚¬ìš©"
            exit 1
          fi

          # 2. ë¬´í•œ ì¬ê·€ í˜¸ì¶œ íŒ¨í„´
          if grep -r "setInterval.*checkAuth\|setTimeout.*checkAuth" src/ --include="*.tsx" --include="*.ts" | head -3; then
            echo "âŒ CRITICAL: ì¸ì¦ ê´€ë ¨ ë¬´í•œ í˜¸ì¶œ íŒ¨í„´!"
            exit 1
          fi

          # 3. API ì—”ë“œí¬ì¸íŠ¸ ë³€ê²½ ì²´í¬
          if git diff --name-only HEAD~1 2>/dev/null | grep -E "(route\.ts|api/)" | head -3; then
            echo "ğŸ” API ì—”ë“œí¬ì¸íŠ¸ ë³€ê²½ ê°ì§€ë¨ - ì¶”ê°€ ê²€ì¦ í•„ìš”"
            echo "api-changes=true" >> $GITHUB_OUTPUT
          fi

          echo "âœ… $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì²´í¬ í†µê³¼"

      - name: âš¡ íƒ€ì… ì²´í¬ (ìºì‹œ í™œìš©)
        run: pnpm tsc --noEmit --skipLibCheck --incremental

      - name: ğŸ” ë¦°íŒ… (ë³€ê²½ëœ íŒŒì¼ë§Œ)
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            # PRì˜ ê²½ìš° ë³€ê²½ëœ íŒŒì¼ë§Œ ê²€ì‚¬
            git diff --name-only --diff-filter=ACMRT ${{ github.event.pull_request.base.sha }} HEAD \
              | grep -E '\.(ts|tsx|js|jsx)$' \
              | xargs pnpm eslint --fix-dry-run || exit 1
          else
            pnpm lint
          fi

  # ğŸ§ª Stage 2: í•µì‹¬ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸ (ë³‘ë ¬ ì‹¤í–‰)
  core-test-suite:
    name: 'ğŸ§ª Core Test Suite'
    runs-on: ubuntu-latest
    needs: lightning-fast-quality-check
    timeout-minutes: 8

    strategy:
      fail-fast: true  # í•˜ë‚˜ë¼ë„ ì‹¤íŒ¨í•˜ë©´ ì „ì²´ ì¤‘ë‹¨
      matrix:
        test-group:
          - auth
          - integration
          - unit
          - seedance

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Setup Test Database
        if: matrix.test-group == 'integration'
        run: |
          # í…ŒìŠ¤íŠ¸ìš© PostgreSQL ì»¨í…Œì´ë„ˆ ì‹œì‘
          docker run -d \
            --name test-postgres \
            -e POSTGRES_USER=test \
            -e POSTGRES_PASSWORD=test \
            -e POSTGRES_DB=test \
            -p 5432:5432 \
            postgres:15-alpine

          # DB ì¤€ë¹„ ëŒ€ê¸°
          timeout 30 bash -c 'until docker exec test-postgres pg_isready; do sleep 1; done'

          # ìŠ¤í‚¤ë§ˆ ì ìš©
          DATABASE_URL="postgresql://test:test@localhost:5432/test" pnpm prisma migrate deploy

      - name: ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ê·¸ë£¹ - ${{ matrix.test-group }}
        run: |
          case "${{ matrix.test-group }}" in
            "auth")
              echo "ğŸ” ì¸ì¦ ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              pnpm test:auth --coverage.enabled=true --reporter=verbose
              ;;
            "integration")
              echo "ğŸ”— í†µí•© í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              INTEGRATION_TEST=true pnpm test:integration --coverage.enabled=true
              ;;
            "unit")
              echo "âš™ï¸ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              pnpm test src/shared src/entities --coverage.enabled=true
              ;;
            "seedance")
              echo "ğŸ¬ Seedance API ì—°ë™ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
              echo "ğŸš¨ í•˜ë“œì½”ë”© í‚¤ ë°©ì§€ í…ŒìŠ¤íŠ¸..."
              pnpm test seedance-hardcoded-key-prevention --coverage.enabled=true
              echo "Seedance í”„ë¡œë•ì…˜ ì—ëŸ¬ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸..."
              pnpm test seedance-production-error-scenarios --coverage.enabled=true
              echo "Seedance API í†µí•© í…ŒìŠ¤íŠ¸..."
              INTEGRATION_TEST=true pnpm test seedance-api-integration --coverage.enabled=true
              ;;
          esac
        env:
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          NODE_ENV: test

      - name: ì»¤ë²„ë¦¬ì§€ ì—…ë¡œë“œ
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          flags: ${{ matrix.test-group }}
          name: coverage-${{ matrix.test-group }}

      - name: ì •ë¦¬
        if: always() && matrix.test-group == 'integration'
        run: docker stop test-postgres && docker rm test-postgres

  # ğŸ§¬ Stage 3: ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ (PRì—ì„œë§Œ)
  mutation-testing:
    name: 'ğŸ§¬ Mutation Testing (PR Only)'
    runs-on: ubuntu-latest
    needs: core-test-suite
    if: github.event_name == 'pull_request'
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: Install Stryker (ìºì‹œë¨)
        run: pnpm add -D @stryker-mutator/core @stryker-mutator/vitest-runner @stryker-mutator/typescript-checker

      - name: ë³€ê²½ëœ íŒŒì¼ì— ëŒ€í•œ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸
        run: |
          # PRì—ì„œ ë³€ê²½ëœ ì¤‘ìš” íŒŒì¼ë“¤ë§Œ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸
          CHANGED_FILES=$(git diff --name-only ${{ github.event.pull_request.base.sha }} HEAD | grep -E '\.(ts|tsx)$' | grep -E '(auth|api)' || echo "")

          if [ -n "$CHANGED_FILES" ]; then
            echo "ğŸ§¬ ë³€ê²½ëœ íŒŒì¼ì— ëŒ€í•œ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ì‹¤í–‰:"
            echo "$CHANGED_FILES"

            # Stryker ì„¤ì •ì— ë³€ê²½ëœ íŒŒì¼ ì¶”ê°€
            pnpm stryker run --mutate="$CHANGED_FILES"
          else
            echo "â„¹ï¸ ë®¤í…Œì´ì…˜ í…ŒìŠ¤íŠ¸ ëŒ€ìƒ íŒŒì¼ ë³€ê²½ ì—†ìŒ"
          fi

      - name: ë®¤í…Œì´ì…˜ ìŠ¤ì½”ì–´ ì²´í¬
        run: |
          if [ -f "reports/mutation/mutation-report.json" ]; then
            SCORE=$(node -e "
              const report = require('./reports/mutation/mutation-report.json');
              console.log(report.mutationScore || 0);
            ")

            echo "ğŸ§¬ ë®¤í…Œì´ì…˜ ìŠ¤ì½”ì–´: ${SCORE}%"

            if (( $(echo "$SCORE < ${{ env.MUTATION_THRESHOLD }}" | bc -l) )); then
              echo "âŒ ë®¤í…Œì´ì…˜ ìŠ¤ì½”ì–´ê°€ ì„ê³„ê°’ ${{ env.MUTATION_THRESHOLD }}% ë¯¸ë§Œì…ë‹ˆë‹¤!"
              exit 1
            fi
          fi

      - name: ë®¤í…Œì´ì…˜ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-report
          path: reports/mutation/

  # ğŸ—ï¸ Stage 4: ë¹Œë“œ ë° ìµœì¢… ê²€ì¦
  build-and-final-verification:
    name: 'ğŸ—ï¸ Build & Final Verification'
    runs-on: ubuntu-latest
    needs: [core-test-suite]
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js & pnpm
        uses: ./.github/actions/setup-node-pnpm

      - name: í”„ë¡œë•ì…˜ ë¹Œë“œ
        run: |
          echo "ğŸ—ï¸ í”„ë¡œë•ì…˜ ë¹Œë“œ í…ŒìŠ¤íŠ¸..."
          pnpm build
        env:
          NODE_ENV: production
          # ìµœì†Œ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ë§Œ ì„¤ì •
          JWT_SECRET: 'ci-build-test-secret'
          NEXT_PUBLIC_APP_URL: 'http://localhost:3000'

      - name: ë¹Œë“œ ê²°ê³¼ë¬¼ í¬ê¸° ì²´í¬
        run: |
          echo "ğŸ“Š ë¹Œë“œ ê²°ê³¼ë¬¼ í¬ê¸° ë¶„ì„..."
          du -sh .next/static/chunks/* | sort -h | tail -10

          # ë²ˆë“¤ í¬ê¸° ì„ê³„ê°’ ì²´í¬ (5MB)
          TOTAL_SIZE=$(du -sm .next | cut -f1)
          if [ $TOTAL_SIZE -gt 5 ]; then
            echo "âš ï¸ ê²½ê³ : ë¹Œë“œ í¬ê¸°ê°€ 5MBë¥¼ ì´ˆê³¼í–ˆìŠµë‹ˆë‹¤: ${TOTAL_SIZE}MB"
          fi

      - name: ì¤‘ìš” ê²½ë¡œ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
        run: |
          echo "ğŸ’¨ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
          # Next.js ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹ ë¥¸ ì‹œì‘ ë° í—¬ìŠ¤ ì²´í¬
          timeout 30 pnpm start &
          sleep 5
          curl -f http://localhost:3000 || echo "âš ï¸ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"

  # ğŸ“Š Stage 5: í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„±
  quality-report:
    name: 'ğŸ“Š Quality Gate Summary'
    runs-on: ubuntu-latest
    needs: [lightning-fast-quality-check, core-test-suite, build-and-final-verification]
    if: always()

    steps:
      - name: í’ˆì§ˆ ê²Œì´íŠ¸ ìµœì¢… ê²°ê³¼
        run: |
          echo "# ğŸ† í’ˆì§ˆ ê²Œì´íŠ¸ ìµœì¢… ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # ê° ë‹¨ê³„ ê²°ê³¼ ìš”ì•½
          echo "## ê²€ì¦ ë‹¨ê³„ë³„ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "- âš¡ ê³ ì† í’ˆì§ˆ ì²´í¬: ${{ needs.lightning-fast-quality-check.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ§ª í•µì‹¬ í…ŒìŠ¤íŠ¸ ìŠ¤ìœ„íŠ¸: ${{ needs.core-test-suite.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- ğŸ—ï¸ ë¹Œë“œ ê²€ì¦: ${{ needs.build-and-final-verification.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # íšŒê·€ ë°©ì§€ ìƒíƒœ
          echo "## ğŸš¨ $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ìƒíƒœ" >> $GITHUB_STEP_SUMMARY
          echo "- useEffect ë¬´í•œ ë£¨í”„ íŒ¨í„´: âœ… ê²€ì¦ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- API ì¸ì¦ í˜¸ì¶œ ëª¨ë‹ˆí„°ë§: âœ… ê²€ì¦ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "- ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€: âœ… ê²€ì¦ ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # í’ˆì§ˆ ë©”íŠ¸ë¦­
          echo "## ğŸ“ˆ í’ˆì§ˆ ë©”íŠ¸ë¦­" >> $GITHUB_STEP_SUMMARY
          echo "- ì»¤ë²„ë¦¬ì§€ ì„ê³„ê°’: ${{ env.COVERAGE_THRESHOLD }}%" >> $GITHUB_STEP_SUMMARY
          echo "- ë®¤í…Œì´ì…˜ ì„ê³„ê°’: ${{ env.MUTATION_THRESHOLD }}%" >> $GITHUB_STEP_SUMMARY
          echo "- íƒ€ì… ì•ˆì „ì„±: TypeScript ì—„ê²© ëª¨ë“œ" >> $GITHUB_STEP_SUMMARY
          echo "- ì•„í‚¤í…ì²˜ ê·œì¹™: FSD ê²½ê³„ ê°•ì œ" >> $GITHUB_STEP_SUMMARY

          # ìµœì¢… íŒì •
          if [[ "${{ needs.lightning-fast-quality-check.result }}" == "success" &&
                "${{ needs.core-test-suite.result }}" == "success" &&
                "${{ needs.build-and-final-verification.result }}" == "success" ]]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## ğŸ‰ ê²°ê³¼: ëª¨ë“  í’ˆì§ˆ ê²Œì´íŠ¸ í†µê³¼!" >> $GITHUB_STEP_SUMMARY
            echo "âœ… PR ë³‘í•© ìŠ¹ì¸" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”’ $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì‹œìŠ¤í…œ ì •ìƒ ì‘ë™" >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## âŒ ê²°ê³¼: í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤íŒ¨!" >> $GITHUB_STEP_SUMMARY
            echo "ğŸš« PR ë³‘í•© ì°¨ë‹¨" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”§ ì‹¤íŒ¨í•œ ê²€ì‚¬ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”." >> $GITHUB_STEP_SUMMARY
            exit 1
          fi

      - name: Slack ì•Œë¦¼ (ì‹¤íŒ¨ ì‹œ)
        if: failure()
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#ci-alerts'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
          text: |
            ğŸš¨ í’ˆì§ˆ ê²Œì´íŠ¸ ì‹¤íŒ¨!
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref }}
            Commit: ${{ github.sha }}

            $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì‹œìŠ¤í…œì—ì„œ ë¬¸ì œë¥¼ ê°ì§€í–ˆìŠµë‹ˆë‹¤.
            ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.

# ì¬ì‚¬ìš© ê°€ëŠ¥í•œ GitHub Actions
---
name: 'Setup Node.js and pnpm'
description: 'Node.jsì™€ pnpm ì„¤ì • ë° ì˜ì¡´ì„± ì„¤ì¹˜'

runs:
  using: 'composite'
  steps:
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'pnpm'

    - name: Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: ${{ env.PNPM_VERSION }}

    - name: Install dependencies
      shell: bash
      run: |
        pnpm install --frozen-lockfile --prefer-offline
        echo "âœ… ì˜ì¡´ì„± ì„¤ì¹˜ ì™„ë£Œ"