name: CI/CD - Quality Gates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ğŸ”§ í™˜ê²½ë³€ìˆ˜ ê²€ì¦ - fail-fast ì›ì¹™
  env-validation:
    name: Environment Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # í™˜ê²½ë³€ìˆ˜ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
      - name: Validate Environment Configuration
        run: |
          echo "ğŸ”§ Testing environment validation with missing variables..."

          # í™˜ê²½ë³€ìˆ˜ ì—†ì´ ê²€ì¦ í…ŒìŠ¤íŠ¸ (ì‹¤íŒ¨í•´ì•¼ ì •ìƒ)
          ! node -e "
            require('ts-node/register');
            const { validateEnvironment } = require('./src/shared/lib/env-validation.ts');
            const result = validateEnvironment({ failFast: false, logErrors: false });
            if (result.success) {
              console.error('âŒ Validation should fail without env vars');
              process.exit(1);
            }
            console.log('âœ… Validation correctly failed without env vars');
          "

          echo "ğŸ”§ Testing environment validation with minimal valid variables..."

          # ìµœì†Œ í™˜ê²½ë³€ìˆ˜ë¡œ ê²€ì¦ í…ŒìŠ¤íŠ¸ (ì„±ê³µí•´ì•¼ ì •ìƒ)
          node -e "
            require('ts-node/register');
            process.env.SUPABASE_URL = 'https://test.supabase.co';
            process.env.SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9';
            const { validateEnvironment } = require('./src/shared/lib/env-validation.ts');
            const result = validateEnvironment({ failFast: false, logErrors: false });
            if (!result.success) {
              console.error('âŒ Validation should pass with valid env vars:', result.errors);
              process.exit(1);
            }
            console.log('âœ… Validation correctly passed with valid env vars');
          "

  # ğŸš¨ ë³´ì•ˆ ê¸´ê¸‰ ìˆ˜ì •: í’ˆì§ˆ ê²Œì´íŠ¸ ê°•ì œ
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    needs: env-validation  # í™˜ê²½ë³€ìˆ˜ ê²€ì¦ í†µê³¼ í›„ ì‹¤í–‰
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ë³‘ë ¬ ì‹¤í–‰ìœ¼ë¡œ í”¼ë“œë°± ì†ë„ í–¥ìƒ
      - name: Type Check
        run: pnpm tsc --noEmit

      - name: Lint Check
        run: pnpm run lint --max-warnings=0

      - name: Format Check
        run: pnpm prettier --check .

      - name: Circular Dependencies Check
        run: pnpm madge --circular --extensions ts,tsx src/

      # FSD ê²½ê³„ ê²€ì¦ ì¶”ê°€
      - name: FSD Architecture Boundary Check
        run: |
          echo "ğŸ—ï¸ Checking FSD architecture boundaries..."

          # ìƒí–¥ ì˜ì¡´ì„± ì²´í¬ (shared -> features ë“± ê¸ˆì§€)
          ! grep -r "from.*features" src/shared/ || {
            echo "âŒ VIOLATION: shared layer importing from features layer"
            exit 1
          }

          ! grep -r "from.*widgets" src/shared/ src/entities/ src/features/ || {
            echo "âŒ VIOLATION: lower layers importing from widgets layer"
            exit 1
          }

          ! grep -r "from.*pages" src/shared/ src/entities/ src/features/ src/widgets/ || {
            echo "âŒ VIOLATION: lower layers importing from pages layer"
            exit 1
          }

          echo "âœ… FSD architecture boundaries are intact"
        
  # ë¹Œë“œ ê²€ì¦
  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build (with minimal env)
        run: pnpm build
        env:
          NODE_ENV: production
          # CI í™˜ê²½ë³€ìˆ˜ - í•„ìˆ˜ ìµœì†Œ ì„¤ì •
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'ci-test-secret-do-not-use-in-production' }}
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
          # Supabase í…ŒìŠ¤íŠ¸ í™˜ê²½ë³€ìˆ˜ (ì•ˆì „ì¥ì¹˜ í…ŒìŠ¤íŠ¸ìš©)
          SUPABASE_URL: 'https://ci-test.supabase.co'
          SUPABASE_ANON_KEY: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.test-ci-token'

      # í™˜ê²½ë³€ìˆ˜ ì—†ì´ ë¹Œë“œ í…ŒìŠ¤íŠ¸ (ì‹¤íŒ¨í•´ì•¼ ì •ìƒ - Fail-Fast ê²€ì¦)
      - name: Build without required env (should fail)
        run: |
          echo "ğŸ§ª Testing fail-fast behavior without required environment variables..."

          # í™˜ê²½ë³€ìˆ˜ ì—†ì´ ë¹Œë“œ ì‹œë„ (ì‹¤íŒ¨í•´ì•¼ ì •ìƒ)
          if NODE_ENV=production pnpm build 2>/dev/null; then
            echo "âŒ Build should have failed without required environment variables"
            echo "ğŸš¨ FAIL-FAST mechanism is not working properly"
            exit 1
          else
            echo "âœ… Build correctly failed without required environment variables"
            echo "âœ… FAIL-FAST mechanism is working properly"
          fi
          
  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰  
  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run unit tests
        run: pnpm test:run
        
      # E2E í…ŒìŠ¤íŠ¸ëŠ” PRì—ì„œë§Œ ì‹¤í–‰ (ì‹œê°„ ì ˆì•½)
      - name: Run E2E tests
        if: github.event_name == 'pull_request'
        run: pnpm test:e2e
        
      # 401 ì¸ì¦ ì˜¤ë¥˜ íŠ¹í™” í…ŒìŠ¤íŠ¸ (í•­ìƒ ì‹¤í–‰ - ë³´ì•ˆ ì¤‘ìš”)
      - name: Run 401 Auth Recovery Tests
        run: pnpm test:e2e:auth-401
        env:
          # í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ë³€ìˆ˜
          JWT_SECRET: 'ci-test-secret-401-recovery'
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          NEXT_PUBLIC_APP_URL: 'http://localhost:3100'
        
  # ì„±ëŠ¥ ì²´í¬ (PRì—ì„œë§Œ)
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: build-verification
    timeout-minutes: 5
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Bundle Analysis
        run: |
          pnpm build
          npx @next/bundle-analyzer --help || echo "Bundle analyzer not configured"