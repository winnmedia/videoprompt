name: CI/CD - Quality Gates

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'

jobs:
  # ğŸš¨ ë³´ì•ˆ ê¸´ê¸‰ ìˆ˜ì •: í’ˆì§ˆ ê²Œì´íŠ¸ ê°•ì œ
  quality-gates:
    name: Quality Gates
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      # ë³‘ë ¬ ì‹¤í–‰ìœ¼ë¡œ í”¼ë“œë°± ì†ë„ í–¥ìƒ
      - name: Type Check
        run: pnpm tsc --noEmit
        
      - name: Lint Check
        run: pnpm run lint --max-warnings=0
        
      - name: Format Check  
        run: pnpm prettier --check .
        
      - name: Circular Dependencies Check
        run: pnpm madge --circular --extensions ts,tsx src/
        
  # ë¹Œë“œ ê²€ì¦
  build-verification:
    name: Build Verification
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build
        run: pnpm build
        env:
          NODE_ENV: production
          # CIì—ì„œëŠ” JWT_SECRET í•„ìˆ˜
          JWT_SECRET: ${{ secrets.JWT_SECRET || 'ci-test-secret-do-not-use-in-production' }}
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          NEXT_PUBLIC_APP_URL: 'http://localhost:3000'
          
  # í…ŒìŠ¤íŠ¸ ì‹¤í–‰  
  tests:
    name: Tests
    runs-on: ubuntu-latest
    needs: quality-gates
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run unit tests
        run: pnpm test:run
        
      # E2E í…ŒìŠ¤íŠ¸ëŠ” PRì—ì„œë§Œ ì‹¤í–‰ (ì‹œê°„ ì ˆì•½)
      - name: Run E2E tests
        if: github.event_name == 'pull_request'
        run: pnpm test:e2e
        
      # 401 ì¸ì¦ ì˜¤ë¥˜ íŠ¹í™” í…ŒìŠ¤íŠ¸ (í•­ìƒ ì‹¤í–‰ - ë³´ì•ˆ ì¤‘ìš”)
      - name: Run 401 Auth Recovery Tests
        run: pnpm test:e2e:auth-401
        env:
          # í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ë³€ìˆ˜
          JWT_SECRET: 'ci-test-secret-401-recovery'
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          NEXT_PUBLIC_APP_URL: 'http://localhost:3100'
        
  # ì„±ëŠ¥ ì²´í¬ (PRì—ì„œë§Œ)
  performance-check:
    name: Performance Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: build-verification
    timeout-minutes: 5
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Bundle Analysis
        run: |
          pnpm build
          npx @next/bundle-analyzer --help || echo "Bundle analyzer not configured"