name: Deploy to Production

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - staging
        - production

env:
  NODE_VERSION: '20.x'
  MCP_PERFORMANCE_TEST: true
  MCP_LOAD_TEST: false

jobs:
  # MCP í…ŒìŠ¤íŠ¸ê°€ ëª¨ë‘ í†µê³¼í•´ì•¼ ë°°í¬ ì§„í–‰
  verify-mcp-tests:
    name: Verify MCP Tests
    runs-on: ubuntu-latest
    outputs:
      mcp-tests-passed: ${{ steps.check-tests.outputs.passed }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run MCP Tests
      id: mcp-tests
      run: |
        echo "ğŸ§ª MCP í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì¤‘..."
        npm run test:mcp:ci
        echo "tests_result=$?" >> $GITHUB_OUTPUT
        
    - name: Check MCP Tests Result
      id: check-tests
      run: |
        if [ "${{ steps.mcp-tests.outputs.tests_result }}" = "0" ]; then
          echo "âœ… ëª¨ë“  MCP í…ŒìŠ¤íŠ¸ í†µê³¼"
          echo "passed=true" >> $GITHUB_OUTPUT
        else
          echo "âŒ MCP í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨"
          echo "passed=false" >> $GITHUB_OUTPUT
          exit 1
        fi

  # ë¹Œë“œ ë° í…ŒìŠ¤íŠ¸
  build:
    name: Build Application
    runs-on: ubuntu-latest
    needs: verify-mcp-tests
    if: needs.verify-mcp-tests.outputs.mcp-tests-passed == 'true'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Build application
      run: npm run build
      
    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: build-files
        path: .next/
        retention-days: 1

  # ìŠ¤í…Œì´ì§• ë°°í¬
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [verify-mcp-tests, build]
    if: |
      needs.verify-mcp-tests.outputs.mcp-tests-passed == 'true' &&
      (github.event.inputs.environment == 'staging' || github.ref != 'refs/heads/main')
    environment:
      name: staging
      url: https://staging.yourapp.com
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: .next/
        
    - name: Deploy to Staging
      run: |
        echo "ğŸš€ ìŠ¤í…Œì´ì§• í™˜ê²½ì— ë°°í¬ ì¤‘..."
        # ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´ (ì˜ˆ: Vercel, Railway, AWS ë“±)
        # npm run deploy:staging
        echo "âœ… ìŠ¤í…Œì´ì§• ë°°í¬ ì™„ë£Œ"
        
    - name: Run Staging MCP Tests
      run: |
        echo "ğŸ§ª ìŠ¤í…Œì´ì§• í™˜ê²½ì—ì„œ MCP í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        # ìŠ¤í…Œì´ì§• URLë¡œ MCP í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        # MCP_TEST_URL=https://staging.yourapp.com npm run test:mcp:website
        echo "âœ… ìŠ¤í…Œì´ì§• MCP í…ŒìŠ¤íŠ¸ ì™„ë£Œ"

  # í”„ë¡œë•ì…˜ ë°°í¬
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [verify-mcp-tests, build, deploy-staging]
    if: |
      needs.verify-mcp-tests.outputs.mcp-tests-passed == 'true' &&
      github.ref == 'refs/heads/main' &&
      (github.event.inputs.environment == 'production' || github.event.inputs.environment == '')
    environment:
      name: production
      url: https://yourapp.com
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: build-files
        path: .next/
        
    - name: Deploy to Production
      run: |
        echo "ğŸš€ í”„ë¡œë•ì…˜ í™˜ê²½ì— ë°°í¬ ì¤‘..."
        # ì‹¤ì œ ë°°í¬ ëª…ë ¹ì–´
        # npm run deploy:production
        echo "âœ… í”„ë¡œë•ì…˜ ë°°í¬ ì™„ë£Œ"
        
    - name: Run Production Health Check
      run: |
        echo "ğŸ¥ í”„ë¡œë•ì…˜ í—¬ìŠ¤ ì²´í¬ ì‹¤í–‰..."
        # í”„ë¡œë•ì…˜ í—¬ìŠ¤ ì²´í¬
        # curl -f https://yourapp.com/api/health
        echo "âœ… í”„ë¡œë•ì…˜ í—¬ìŠ¤ ì²´í¬ ì™„ë£Œ"

  # ë°°í¬ í›„ ê²€ì¦
  post-deploy-verification:
    name: Post-Deploy Verification
    runs-on: ubuntu-latest
    needs: [deploy-production]
    if: always() && needs.deploy-production.result == 'success'
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: Install dependencies
      run: npm ci
      
    - name: Install Playwright browsers
      run: npx playwright install --with-deps
      
    - name: Run Production MCP Tests
      env:
        MCP_TEST_URL: https://yourapp.com
      run: |
        echo "ğŸ§ª í”„ë¡œë•ì…˜ í™˜ê²½ì—ì„œ MCP í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        # í”„ë¡œë•ì…˜ URLë¡œ MCP í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        # npm run test:mcp:website
        echo "âœ… í”„ë¡œë•ì…˜ MCP í…ŒìŠ¤íŠ¸ ì™„ë£Œ"
        
    - name: Performance Monitoring
      run: |
        echo "ğŸ“Š ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì‹œì‘..."
        # ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ë° ì•Œë¦¼
        # npm run monitor:performance
        echo "âœ… ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§ ì„¤ì • ì™„ë£Œ"

  # ë°°í¬ ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
  rollback:
    name: Rollback on Failure
    runs-on: ubuntu-latest
    needs: [deploy-production, post-deploy-verification]
    if: always() && (needs.deploy-production.result == 'failure' || needs.post-deploy-verification.result == 'failure')
    
    steps:
    - name: Rollback Deployment
      run: |
        echo "ğŸ”„ ë°°í¬ ë¡¤ë°± ì‹¤í–‰ ì¤‘..."
        # ë¡¤ë°± ëª…ë ¹ì–´
        # npm run rollback:production
        echo "âœ… ë¡¤ë°± ì™„ë£Œ"
        
    - name: Notify Team
      run: |
        echo "ğŸ“¢ íŒ€ì— ë¡¤ë°± ì•Œë¦¼ ì „ì†¡..."
        # Slack, Discord ë“±ìœ¼ë¡œ ì•Œë¦¼
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš¨ í”„ë¡œë•ì…˜ ë°°í¬ ì‹¤íŒ¨ë¡œ ì¸í•œ ë¡¤ë°± ì‹¤í–‰"}' \
        #   $SLACK_WEBHOOK_URL
        echo "âœ… ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"

  # ë°°í¬ ì„±ê³µ ì•Œë¦¼
  notify-success:
    name: Notify Deployment Success
    runs-on: ubuntu-latest
    needs: [post-deploy-verification]
    if: needs.post-deploy-verification.result == 'success'
    
    steps:
    - name: Notify Success
      run: |
        echo "ğŸ‰ ë°°í¬ ì„±ê³µ ì•Œë¦¼ ì „ì†¡..."
        # ì„±ê³µ ì•Œë¦¼
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì„±ê³µ! ëª¨ë“  MCP í…ŒìŠ¤íŠ¸ í†µê³¼ âœ…"}' \
        #   $SLACK_WEBHOOK_URL
        echo "âœ… ì„±ê³µ ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ"

