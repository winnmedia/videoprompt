# QA Lead Grace - ë¬´ê´€ìš© í’ˆì§ˆ ê²Œì´íŠ¸ íŒŒì´í”„ë¼ì¸
# Vercel ë¹Œë“œ ì‹¤íŒ¨ ë°©ì§€ ë° íšŒê·€ ì°¨ë‹¨

name: ğŸ›¡ï¸ Quality Gate Verification

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '8'

jobs:
  # 1ë‹¨ê³„: í™˜ê²½ ì„¤ì • ë° ê¸°ë³¸ ê²€ì¦
  setup-and-basic-checks:
    name: ğŸ“‹ Setup & Basic Validation
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ¯ Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: ğŸ—„ï¸ Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: ğŸ”§ Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ğŸš« Verify no npm/yarn usage (CLAUDE.md compliance)
        run: |
          if [ -f "package-lock.json" ] || [ -f "yarn.lock" ]; then
            echo "âŒ ERROR: npm/yarn lock files detected. Only pnpm is allowed (CLAUDE.md violation)"
            exit 1
          fi
          echo "âœ… pnpm compliance verified"

      - name: ğŸ“ Cache node_modules for subsequent jobs
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

  # 2ë‹¨ê³„: ìŠ¤í‚¤ë§ˆ ì¼ê´€ì„± ë° íƒ€ì… ì•ˆì „ì„± ê²€ì¦
  schema-consistency:
    name: ğŸ” Schema Consistency & Type Safety
    runs-on: ubuntu-latest
    needs: setup-and-basic-checks
    timeout-minutes: 15

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“ Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-node-modules-

      - name: ğŸ”§ Install dependencies (if cache miss)
        run: pnpm install --frozen-lockfile

      - name: ğŸ—„ï¸ Setup test database
        run: |
          # í…ŒìŠ¤íŠ¸ìš© PostgreSQL ì„¤ì •
          echo "DATABASE_URL=postgresql://test:test@localhost:5432/test_db" >> $GITHUB_ENV

      - name: ğŸ›¢ï¸ Start PostgreSQL service
        run: |
          sudo systemctl start postgresql
          sudo -u postgres createuser -d test
          sudo -u postgres createdb -O test test_db
          sudo -u postgres psql -c "ALTER USER test PASSWORD 'test';"

      - name: ğŸ”„ Generate Prisma Client
        run: |
          pnpm exec prisma generate
          echo "âœ… Prisma Client generated successfully"

      - name: ğŸ§ª Run schema consistency tests
        run: |
          pnpm exec jest __tests__/build-safety/schema-consistency.test.ts --verbose
          echo "âœ… Schema consistency tests passed"

      - name: ğŸ”’ Verify type safety guard
        run: |
          pnpm exec jest __tests__/shared/lib/type-safety-guard.test.ts --verbose
          echo "âœ… Type safety guard tests passed"

      - name: ğŸ—ï¸ Prisma schema validation
        run: |
          pnpm exec prisma validate
          echo "âœ… Prisma schema validation passed"

  # 3ë‹¨ê³„: TypeScript ì»´íŒŒì¼ ë° ë¹Œë“œ ê²€ì¦ (Vercel ì‹œë®¬ë ˆì´ì…˜)
  build-verification:
    name: ğŸ—ï¸ Build Verification (Vercel Simulation)
    runs-on: ubuntu-latest
    needs: schema-consistency
    timeout-minutes: 20

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“ Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ğŸ”§ Install dependencies (if cache miss)
        run: pnpm install --frozen-lockfile

      - name: ğŸ—„ï¸ Setup production-like environment
        run: |
          echo "NODE_ENV=production" >> $GITHUB_ENV
          echo "SKIP_ENV_VALIDATION=true" >> $GITHUB_ENV

      - name: ğŸ”„ Generate Prisma Client (Production Mode)
        run: |
          pnpm exec prisma generate
          echo "âœ… Prisma Client generated in production mode"

      - name: ğŸ¯ TypeScript compilation check
        run: |
          echo "ğŸ” Running TypeScript compilation check..."
          pnpm exec tsc --noEmit --incremental false
          echo "âœ… TypeScript compilation passed"

      - name: ğŸ—ï¸ Next.js build simulation
        run: |
          echo "ğŸ—ï¸ Starting Next.js build (Vercel simulation)..."
          pnpm run build
          echo "âœ… Next.js build completed successfully"

      - name: ğŸ“Š Build analysis
        run: |
          echo "ğŸ“Š Analyzing build output..."
          if [ -d ".next" ]; then
            echo "Build directory size: $(du -sh .next/)"
            echo "Static files: $(find .next/static -name "*.js" | wc -l) JS files"
            echo "âœ… Build analysis completed"
          else
            echo "âŒ Build directory not found"
            exit 1
          fi

      - name: ğŸ§ª Run build verification script
        run: |
          chmod +x scripts/build-verification.sh
          ./scripts/build-verification.sh

  # 4ë‹¨ê³„: $300 ì‚¬ê±´ íšŒê·€ ë°©ì§€ ê²€ì‚¬
  regression-prevention:
    name: ğŸš¨ $300 Incident Prevention
    runs-on: ubuntu-latest
    needs: setup-and-basic-checks
    timeout-minutes: 10

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸš« Scan for dangerous useEffect patterns
        run: |
          echo "ğŸ” Scanning for dangerous useEffect patterns..."

          # useEffect ì˜ì¡´ì„± ë°°ì—´ì— í•¨ìˆ˜ê°€ ìˆëŠ”ì§€ ê²€ì‚¬
          if grep -r "useEffect.*\[.*function" src/ || grep -r "useEffect.*\[.*\(\)" src/; then
            echo "âŒ CRITICAL: Dangerous useEffect pattern detected!"
            echo "This caused the $300 API cost incident"
            echo "Fix: Use empty dependency array [] for mount-only effects"
            exit 1
          fi

          echo "âœ… No dangerous useEffect patterns found"

      - name: ğŸš« Check for API call patterns
        run: |
          echo "ğŸ” Checking API call patterns..."

          # checkAuth í˜¸ì¶œ íŒ¨í„´ ê²€ì‚¬
          auth_calls=$(grep -r "checkAuth" src/ | grep -v "// safe" | wc -l)
          if [ "$auth_calls" -gt 10 ]; then
            echo "âš ï¸  WARNING: High number of checkAuth calls detected ($auth_calls)"
            echo "Verify rate limiting and caching"
          fi

          echo "âœ… API call pattern check completed"

      - name: ğŸ›¡ï¸ Rate limiting verification
        run: |
          echo "ğŸ” Verifying rate limiting implementation..."

          # rate limiting êµ¬í˜„ í™•ì¸
          if ! grep -r "rate.*limit\|throttle\|debounce" src/; then
            echo "âš ï¸  WARNING: No rate limiting patterns found"
            echo "Consider implementing API call throttling"
          else
            echo "âœ… Rate limiting patterns detected"
          fi

      - name: ğŸš« Verify no forbidden patterns
        run: |
          echo "ğŸ” Checking for forbidden patterns..."

          # CLAUDE.md ê¸ˆì§€ íŒ¨í„´ ê²€ì‚¬
          forbidden_found=false

          # @ts-ignore ì‚¬ìš© ê²€ì‚¬
          if grep -r "@ts-ignore\|@ts-nocheck" src/; then
            echo "âŒ ERROR: @ts-ignore or @ts-nocheck found (forbidden by CLAUDE.md)"
            forbidden_found=true
          fi

          # any íƒ€ì… ì‚¬ìš© ê²€ì‚¬ (íƒ€ì… ì •ì˜ íŒŒì¼ ì œì™¸)
          if grep -r ": any\|<any>" src/ --exclude-dir=types --exclude="*.d.ts"; then
            echo "âŒ ERROR: 'any' type usage found (forbidden by CLAUDE.md)"
            forbidden_found=true
          fi

          # moment.js ì‚¬ìš© ê²€ì‚¬
          if grep -r "import.*moment\|require.*moment" src/; then
            echo "âŒ ERROR: moment.js usage found (forbidden by CLAUDE.md)"
            forbidden_found=true
          fi

          if [ "$forbidden_found" = true ]; then
            echo "âŒ Forbidden patterns detected - quality gate FAILED"
            exit 1
          fi

          echo "âœ… No forbidden patterns found"

  # 5ë‹¨ê³„: ë³´ì•ˆ ë° ì„±ëŠ¥ ê²€ì‚¬
  security-performance:
    name: ğŸ”’ Security & Performance Audit
    runs-on: ubuntu-latest
    needs: setup-and-basic-checks
    timeout-minutes: 15

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: ğŸ“¦ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ğŸ“¥ Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: ğŸ“ Restore node_modules cache
        uses: actions/cache@v3
        with:
          path: |
            node_modules
            ~/.pnpm-store
          key: ${{ runner.os }}-node-modules-${{ hashFiles('**/pnpm-lock.yaml') }}

      - name: ğŸ”§ Install dependencies (if cache miss)
        run: pnpm install --frozen-lockfile

      - name: ğŸ”’ Security audit
        run: |
          echo "ğŸ” Running security audit..."
          pnpm audit --audit-level moderate || echo "âš ï¸  Security vulnerabilities detected - review required"

      - name: ğŸ“¦ Bundle analysis (if build exists)
        run: |
          if [ -d ".next" ]; then
            echo "ğŸ“Š Analyzing bundle size..."
            npx @next/bundle-analyzer
          else
            echo "â„¹ï¸  No build directory found for bundle analysis"
          fi

  # 6ë‹¨ê³„: ìµœì¢… í’ˆì§ˆ ê²Œì´íŠ¸ ê²€ì¦
  final-quality-gate:
    name: âœ… Final Quality Gate
    runs-on: ubuntu-latest
    needs: [schema-consistency, build-verification, regression-prevention, security-performance]
    timeout-minutes: 5

    steps:
      - name: ğŸ” Checkout code
        uses: actions/checkout@v4

      - name: âœ… Quality gate summary
        run: |
          echo "=============================================="
          echo "ğŸ›¡ï¸  QUALITY GATE VERIFICATION SUMMARY"
          echo "=============================================="
          echo "âœ… Schema consistency: PASSED"
          echo "âœ… Build verification: PASSED"
          echo "âœ… Regression prevention: PASSED"
          echo "âœ… Security & performance: PASSED"
          echo "=============================================="
          echo "ğŸ‰ ALL QUALITY GATES PASSED"
          echo "âœ… Production deployment AUTHORIZED"
          echo "âœ… Vercel build should succeed"
          echo "=============================================="

      - name: ğŸ“Š Create quality report
        run: |
          mkdir -p quality-reports
          cat > quality-reports/quality-gate-report.json << EOF
          {
            "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
            "commit": "${{ github.sha }}",
            "branch": "${{ github.ref_name }}",
            "quality_gates": {
              "schema_consistency": "PASSED",
              "build_verification": "PASSED",
              "regression_prevention": "PASSED",
              "security_performance": "PASSED"
            },
            "overall_status": "PASSED",
            "deployment_authorized": true,
            "notes": "All quality gates passed successfully. No regressions detected."
          }
          EOF

      - name: ğŸ“¤ Upload quality report
        uses: actions/upload-artifact@v3
        with:
          name: quality-gate-report
          path: quality-reports/
          retention-days: 30

  # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-on-failure:
    name: ğŸš¨ Failure Notification
    runs-on: ubuntu-latest
    needs: [schema-consistency, build-verification, regression-prevention, security-performance]
    if: failure()

    steps:
      - name: ğŸš¨ Quality gate failure notification
        run: |
          echo "=============================================="
          echo "ğŸš¨ QUALITY GATE FAILURE DETECTED"
          echo "=============================================="
          echo "âŒ One or more quality gates failed"
          echo "ğŸš« Production deployment BLOCKED"
          echo "ğŸ”§ Review and fix issues before merging"
          echo "=============================================="
          echo ""
          echo "ğŸ“‹ Action Required:"
          echo "1. Check job logs for specific failures"
          echo "2. Fix identified issues"
          echo "3. Re-run quality verification"
          echo "4. Ensure all tests pass before deployment"