name: Production API Integration Tests

on:
  # ë©”ì¸ ë¸Œëœì¹˜ì— í‘¸ì‹œë  ë•Œ
  push:
    branches: [main]
  
  # PRì´ ë©”ì¸ ë¸Œëœì¹˜ë¡œ ìƒì„±ë  ë•Œ
  pull_request:
    branches: [main]
  
  # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ (ë§¤ì¼ ì˜¤ì „ 9ì‹œ KST)
  schedule:
    - cron: '0 0 * * *'  # UTC 00:00 = KST 09:00
  
  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test Environment'
        required: true
        default: 'both'
        type: choice
        options:
          - local
          - production
          - both
      
      test_type:
        description: 'Test Type'
        required: true
        default: 'full'
        type: choice
        options:
          - health-check
          - auth-integration
          - full

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # í™˜ê²½ ì„¤ì • ë° ì¤€ë¹„
  setup:
    runs-on: ubuntu-latest
    outputs:
      test-environments: ${{ steps.set-matrix.outputs.environments }}
    steps:
      - name: Set Test Matrix
        id: set-matrix
        run: |
          if [ "${{ github.event.inputs.environment }}" = "local" ]; then
            echo "environments=[\"local\"]" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "environments=[\"production\"]" >> $GITHUB_OUTPUT
          else
            echo "environments=[\"local\", \"production\"]" >> $GITHUB_OUTPUT
          fi

  # Production API í†µí•© í…ŒìŠ¤íŠ¸
  production-api-tests:
    runs-on: ubuntu-latest
    needs: setup
    strategy:
      matrix:
        environment: ${{ fromJson(needs.setup.outputs.test-environments) }}
      fail-fast: false
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}
          run_install: false

      - name: Get pnpm store directory
        id: pnpm-cache
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path)" >> $GITHUB_OUTPUT

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ steps.pnpm-cache.outputs.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install Dependencies
        run: pnpm install --frozen-lockfile

      - name: Setup Test Environment Variables
        run: |
          cp .env.test .env.local
          echo "TEST_ENVIRONMENT=${{ matrix.environment }}" >> .env.local
          echo "GITHUB_RUN_ID=${{ github.run_id }}" >> .env.local
          echo "GITHUB_SHA=${{ github.sha }}" >> .env.local

      - name: Setup Local Test Server (if needed)
        if: matrix.environment == 'local'
        run: |
          # ë°±ê·¸ë¼ìš´ë“œì—ì„œ ë¡œì»¬ ì„œë²„ ì‹¤í–‰
          pnpm dev &
          
          # ì„œë²„ê°€ ì‹œì‘ë  ë•Œê¹Œì§€ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
          timeout=60
          while [ $timeout -gt 0 ]; do
            if curl -f http://localhost:3000/api/health > /dev/null 2>&1; then
              echo "Local server is ready"
              break
            fi
            echo "Waiting for local server to start... ($timeout seconds remaining)"
            sleep 2
            timeout=$((timeout - 2))
          done
          
          if [ $timeout -le 0 ]; then
            echo "Local server failed to start within timeout"
            exit 1
          fi

      - name: Run Health Check Tests
        if: github.event.inputs.test_type == 'health-check' || github.event.inputs.test_type == 'full' || github.event.inputs.test_type == ''
        run: |
          echo "ğŸ¥ Running Production Health Check Tests for ${{ matrix.environment }}"
          pnpm test src/__tests__/production-health-monitor.test.ts
        env:
          TEST_ENVIRONMENT: ${{ matrix.environment }}

      - name: Run Auth Integration Tests
        if: github.event.inputs.test_type == 'auth-integration' || github.event.inputs.test_type == 'full' || github.event.inputs.test_type == ''
        run: |
          echo "ğŸ” Running Auth Integration Tests for ${{ matrix.environment }}"
          pnpm test src/__tests__/auth-api-integration.test.ts
        env:
          TEST_ENVIRONMENT: ${{ matrix.environment }}

      - name: Cleanup Test Data
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up test data for ${{ matrix.environment }}"
          # í…ŒìŠ¤íŠ¸ ì •ë¦¬ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          curl -X GET "http://localhost:3000/api/test/cleanup-user" \
            -H "X-Test-Mode: 1" \
            -H "Content-Type: application/json" || true
        continue-on-error: true

      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.environment }}-${{ github.run_id }}
          path: |
            coverage/
            test-results.xml
            *.log
          retention-days: 7

  # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½ ë° ì•Œë¦¼
  test-summary:
    runs-on: ubuntu-latest
    needs: production-api-tests
    if: always()
    
    steps:
      - name: Download All Test Results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Generate Test Summary
        run: |
          echo "# ğŸ§ª Production API Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # í™˜ê²½ë³„ ê²°ê³¼ í‘œì‹œ
          if [ -d "test-results" ]; then
            echo "## ğŸ“Š Test Results by Environment" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Environment | Status | Artifacts |" >> $GITHUB_STEP_SUMMARY
            echo "|-------------|--------|-----------|" >> $GITHUB_STEP_SUMMARY
            
            for env_dir in test-results/test-results-*; do
              if [ -d "$env_dir" ]; then
                env_name=$(basename "$env_dir" | sed 's/test-results-//' | sed 's/-[0-9]*$//')
                if [ -f "$env_dir/test-results.xml" ]; then
                  echo "| $env_name | âœ… Passed | [Download]($env_dir) |" >> $GITHUB_STEP_SUMMARY
                else
                  echo "| $env_name | âŒ Failed | [Download]($env_dir) |" >> $GITHUB_STEP_SUMMARY
                fi
              fi
            done
          else
            echo "| N/A | â“ No Results | N/A |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ“ˆ Performance Metrics" >> $GITHUB_STEP_SUMMARY
          echo "Performance metrics and detailed logs are available in the test artifacts." >> $GITHUB_STEP_SUMMARY

      - name: Notify on Slack (Production Failures)
        if: failure() && (github.ref == 'refs/heads/main' || github.event_name == 'schedule')
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#dev-alerts'
          text: |
            ğŸš¨ Production API Tests Failed!
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            Please check the test results and investigate immediately.
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

  # ì„±ëŠ¥ íŠ¸ë Œë“œ ë¶„ì„ (ì„ íƒì )
  performance-analysis:
    runs-on: ubuntu-latest
    needs: production-api-tests
    if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Download Test Results
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Analyze Performance Trends
        run: |
          echo "ğŸ“Š Analyzing performance trends..."
          # ì—¬ê¸°ì— ì„±ëŠ¥ ë°ì´í„° ë¶„ì„ ë¡œì§ ì¶”ê°€
          # ì˜ˆ: í‰ê·  ì‘ë‹µ ì‹œê°„, ê°€ìš©ì„± ì¶”ì´ ë“±
          
          echo "Performance analysis completed. Check artifacts for detailed reports."

      - name: Upload Performance Report
        uses: actions/upload-artifact@v4
        with:
          name: performance-report-${{ github.run_id }}
          path: performance-report.json
          retention-days: 30

# ì›Œí¬í”Œë¡œìš° ë³´ì•ˆ ì„¤ì •
concurrency:
  group: production-api-tests-${{ github.ref }}
  cancel-in-progress: true