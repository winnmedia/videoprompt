name: ğŸ—„ï¸ DB ê³„ì•½ ê²€ì¦ í…ŒìŠ¤íŠ¸

# Benjaminì˜ ê³„ì•½ ìœ„ë°˜ ë°œê²¬ì‚¬í•­ ëŒ€ì‘ ìë™í™”
# - CineGenius v3 ì§€ì› SQLì´ ë¶€ë¶„ì ìœ¼ë¡œë§Œ ì ìš©ë¨
# - MigrationLog í…Œì´ë¸”ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŒ
# - ì¸ë±ìŠ¤ ë° ì œì•½ì¡°ê±´ ëˆ„ë½
# - ìˆ˜ë™ ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦ í”„ë¡œì„¸ìŠ¤ ë¶€ì¬

on:
  # PR ìƒì„±/ì—…ë°ì´íŠ¸ ì‹œ ìë™ ì‹¤í–‰
  pull_request:
    branches: [main, develop]
    paths:
      - 'prisma/**'
      - 'src/app/api/**'
      - 'src/lib/db/**'
      - 'tests/db/**'
      - '.github/workflows/db-contract-tests.yml'

  # ë©”ì¸/ê°œë°œ ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ì‹¤í–‰
  push:
    branches: [main, develop]
    paths:
      - 'prisma/**'
      - 'src/app/api/**'
      - 'src/lib/db/**'
      - 'tests/db/**'

  # ìˆ˜ë™ ì‹¤í–‰ ì§€ì›
  workflow_dispatch:
    inputs:
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ ì„ íƒ'
        required: false
        default: 'full'
        type: choice
        options:
          - 'full'
          - 'migration-only'
          - 'api-only'

jobs:
  # ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ë° ì‚¬ì „ ê²€ì¦
  db-connection-test:
    name: ğŸ”Œ DB ì—°ê²° í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    outputs:
      database_url: ${{ steps.setup-db.outputs.database_url }}
      
    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ pnpm ì„¤ì¹˜
        run: npm install -g pnpm

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ—„ï¸ ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
        id: setup-db
        run: |
          echo "database_url=postgresql://test_user:test_password@localhost:5432/test_db" >> $GITHUB_OUTPUT
          
      - name: ğŸ” DB ì—°ê²° í…ŒìŠ¤íŠ¸
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          # PostgreSQL í´ë¼ì´ì–¸íŠ¸ë¡œ ì—°ê²° í…ŒìŠ¤íŠ¸
          PGPASSWORD=test_password psql -h localhost -p 5432 -U test_user -d test_db -c "SELECT version();"

      - name: ğŸ“‹ Prisma ìŠ¤í‚¤ë§ˆ ì ìš©
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          pnpm prisma db push --accept-data-loss

      - name: âœ… ê¸°ë³¸ í…Œì´ë¸” ì¡´ì¬ í™•ì¸
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          PGPASSWORD=test_password psql -h localhost -p 5432 -U test_user -d test_db -c "
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' 
            AND table_name IN ('User', 'Project', 'Prompt', 'VideoAsset', 'Comment', 'ShareToken')
            ORDER BY table_name;
          "

  # ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬´ê²°ì„± ê²€ì¦
  migration-integrity:
    name: ğŸ”„ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬´ê²°ì„± ê²€ì¦
    runs-on: ubuntu-latest
    needs: db-connection-test
    if: github.event.inputs.test_mode == 'full' || github.event.inputs.test_mode == 'migration-only' || github.event.inputs.test_mode == ''

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ pnpm ì„¤ì¹˜
        run: npm install -g pnpm

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ“‹ Prisma ìŠ¤í‚¤ë§ˆ ì ìš©
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          pnpm prisma db push --accept-data-loss

      - name: ğŸ§ª ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬´ê²°ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          NODE_ENV: test
        run: |
          npx jest --config=tests/db/jest.config.js tests/db/migration-integrity.test.ts --ci --coverage=false

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: migration-integrity-results
          path: test-results/db/
          retention-days: 7

  # ìŠ¤í‚¤ë§ˆ ìœ„í—˜ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸
  schema-risk-scenarios:
    name: âš ï¸ ìŠ¤í‚¤ë§ˆ ìœ„í—˜ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦
    runs-on: ubuntu-latest
    needs: migration-integrity
    if: github.event.inputs.test_mode == 'full' || github.event.inputs.test_mode == 'migration-only' || github.event.inputs.test_mode == ''

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ pnpm ì„¤ì¹˜
        run: npm install -g pnpm

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ“‹ Prisma ìŠ¤í‚¤ë§ˆ ì ìš©
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          pnpm prisma db push --accept-data-loss

      - name: ğŸ§ª ìŠ¤í‚¤ë§ˆ ìœ„í—˜ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          NODE_ENV: test
        run: |
          npx jest --config=tests/db/jest.config.js tests/db/schema-risk-scenarios.test.ts --ci --coverage=false

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: schema-risk-results
          path: test-results/db/
          retention-days: 7

  # API ê³„ì•½ ê²€ì¦
  api-contract-validation:
    name: ğŸ”— API ê³„ì•½ ê²€ì¦
    runs-on: ubuntu-latest
    needs: db-connection-test
    if: github.event.inputs.test_mode == 'full' || github.event.inputs.test_mode == 'api-only' || github.event.inputs.test_mode == ''

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ pnpm ì„¤ì¹˜
        run: npm install -g pnpm

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ“‹ Prisma ìŠ¤í‚¤ë§ˆ ì ìš©
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          pnpm prisma db push --accept-data-loss

      - name: ğŸ§ª API ê³„ì•½ ê²€ì¦ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          NODE_ENV: test
        run: |
          npx jest --config=tests/db/jest.config.js tests/db/api-contract-validation.test.ts --ci --coverage=false

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: api-contract-results
          path: test-results/db/
          retention-days: 7

  # ë¡¤ë°± ì•ˆì „ì„± ê²€ì¦
  rollback-safety:
    name: ğŸ”„ ë¡¤ë°± ì•ˆì „ì„± ê²€ì¦
    runs-on: ubuntu-latest
    needs: [migration-integrity, schema-risk-scenarios]
    if: github.event.inputs.test_mode == 'full' || github.event.inputs.test_mode == 'migration-only' || github.event.inputs.test_mode == ''

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_DB: test_db
          POSTGRES_USER: test_user
          POSTGRES_PASSWORD: test_password
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: ğŸ“¥ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4

      - name: ğŸ”§ Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: ğŸ“¦ pnpm ì„¤ì¹˜
        run: npm install -g pnpm

      - name: ğŸ“š ì˜ì¡´ì„± ì„¤ì¹˜
        run: pnpm install --frozen-lockfile

      - name: ğŸ“‹ Prisma ìŠ¤í‚¤ë§ˆ ì ìš©
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
        run: |
          pnpm prisma db push --accept-data-loss

      - name: ğŸ§ª ë¡¤ë°± ì•ˆì „ì„± í…ŒìŠ¤íŠ¸ ì‹¤í–‰
        env:
          DATABASE_URL: postgresql://test_user:test_password@localhost:5432/test_db
          NODE_ENV: test
        run: |
          npx jest --config=tests/db/jest.config.js tests/db/rollback-safety.test.ts --ci --coverage=false

      - name: ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rollback-safety-results
          path: test-results/db/
          retention-days: 7

  # ì „ì²´ ê²°ê³¼ ë¦¬í¬íŠ¸ ìƒì„±
  final-report:
    name: ğŸ“‹ DB ê³„ì•½ ê²€ì¦ ë¦¬í¬íŠ¸
    runs-on: ubuntu-latest
    needs: [migration-integrity, schema-risk-scenarios, api-contract-validation, rollback-safety]
    if: always()

    steps:
      - name: ğŸ“¥ ëª¨ë“  í…ŒìŠ¤íŠ¸ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
        uses: actions/download-artifact@v4
        with:
          pattern: "*-results"
          merge-multiple: true
          path: all-test-results/

      - name: ğŸ“Š ìµœì¢… ë¦¬í¬íŠ¸ ìƒì„±
        run: |
          echo "# ğŸ—„ï¸ DB ê³„ì•½ ê²€ì¦ í…ŒìŠ¤íŠ¸ ê²°ê³¼" > REPORT.md
          echo "" >> REPORT.md
          echo "## ğŸ“ í…ŒìŠ¤íŠ¸ ê°œìš”" >> REPORT.md
          echo "" >> REPORT.md
          echo "Benjaminì˜ ê³„ì•½ ìœ„ë°˜ ë°œê²¬ì‚¬í•­ì— ëŒ€í•œ ìë™í™”ëœ ê²€ì¦:" >> REPORT.md
          echo "" >> REPORT.md
          echo "âœ… **í†µê³¼í•œ í…ŒìŠ¤íŠ¸ë“¤:**" >> REPORT.md
          
          # ê° í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìš”ì•½
          if [ "${{ needs.migration-integrity.result }}" == "success" ]; then
            echo "- ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬´ê²°ì„± ê²€ì¦" >> REPORT.md
          fi
          
          if [ "${{ needs.schema-risk-scenarios.result }}" == "success" ]; then
            echo "- ìŠ¤í‚¤ë§ˆ ìœ„í—˜ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦" >> REPORT.md
          fi
          
          if [ "${{ needs.api-contract-validation.result }}" == "success" ]; then
            echo "- API ê³„ì•½ ê²€ì¦" >> REPORT.md
          fi
          
          if [ "${{ needs.rollback-safety.result }}" == "success" ]; then
            echo "- ë¡¤ë°± ì•ˆì „ì„± ê²€ì¦" >> REPORT.md
          fi
          
          echo "" >> REPORT.md
          echo "âŒ **ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ë“¤:**" >> REPORT.md
          
          if [ "${{ needs.migration-integrity.result }}" == "failure" ]; then
            echo "- ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬´ê²°ì„± ê²€ì¦ (CineGenius v3.1 í•„ë“œ ëˆ„ë½ ê°€ëŠ¥ì„±)" >> REPORT.md
          fi
          
          if [ "${{ needs.schema-risk-scenarios.result }}" == "failure" ]; then
            echo "- ìŠ¤í‚¤ë§ˆ ìœ„í—˜ ì‹œë‚˜ë¦¬ì˜¤ ê²€ì¦ (ë°ì´í„° ì†ì‹¤ ìœ„í—˜)" >> REPORT.md
          fi
          
          if [ "${{ needs.api-contract-validation.result }}" == "failure" ]; then
            echo "- API ê³„ì•½ ê²€ì¦ (API-DB ìŠ¤í‚¤ë§ˆ ë¶ˆì¼ì¹˜)" >> REPORT.md
          fi
          
          if [ "${{ needs.rollback-safety.result }}" == "failure" ]; then
            echo "- ë¡¤ë°± ì•ˆì „ì„± ê²€ì¦ (ë¡¤ë°± ì‹œ ë°ì´í„° ì†ì‹¤ ìœ„í—˜)" >> REPORT.md
          fi
          
          echo "" >> REPORT.md
          echo "## ğŸ› ï¸ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­" >> REPORT.md
          echo "" >> REPORT.md
          echo "ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ê°€ ìˆë‹¤ë©´:" >> REPORT.md
          echo "1. \`prisma/migrations/000001_add_cinegenius_v3_support.sql\` ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰" >> REPORT.md
          echo "2. MigrationLog í…Œì´ë¸” ìƒì„± í™•ì¸" >> REPORT.md
          echo "3. API ì‘ë‹µ ìŠ¤í‚¤ë§ˆì™€ DB ìŠ¤í‚¤ë§ˆ ë™ê¸°í™”" >> REPORT.md
          echo "4. ì¸ë±ìŠ¤ ë° ì œì•½ì¡°ê±´ ì¶”ê°€ ê²€í† " >> REPORT.md

      - name: ğŸ“‹ ë¦¬í¬íŠ¸ ì¶œë ¥
        run: cat REPORT.md

      - name: ğŸ“¤ ìµœì¢… ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
        uses: actions/upload-artifact@v4
        with:
          name: final-db-contract-report
          path: |
            REPORT.md
            all-test-results/
          retention-days: 30

      - name: ğŸ“§ PR ëŒ“ê¸€ë¡œ ê²°ê³¼ ì•Œë¦¼ (PRì¸ ê²½ìš°)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const report = fs.readFileSync('REPORT.md', 'utf8');
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # ì‹¤íŒ¨ ì‹œ ìŠ¬ë™ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-failure:
    name: ğŸ“¢ ì‹¤íŒ¨ ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [migration-integrity, schema-risk-scenarios, api-contract-validation, rollback-safety]
    if: failure() && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')

    steps:
      - name: ğŸ“§ ì‹¤íŒ¨ ì•Œë¦¼ (ë¡œê·¸ë¡œ ëŒ€ì²´)
        run: |
          echo "ğŸš¨ DB ê³„ì•½ ê²€ì¦ ì‹¤íŒ¨!"
          echo "ğŸ’¥ ë¸Œëœì¹˜: ${{ github.ref }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo ""
          echo "ì‹¤íŒ¨í•œ ì‘ì—…ë“¤:"
          echo "- ë§ˆì´ê·¸ë ˆì´ì…˜ ë¬´ê²°ì„±: ${{ needs.migration-integrity.result }}"
          echo "- ìŠ¤í‚¤ë§ˆ ìœ„í—˜ ì‹œë‚˜ë¦¬ì˜¤: ${{ needs.schema-risk-scenarios.result }}"
          echo "- API ê³„ì•½ ê²€ì¦: ${{ needs.api-contract-validation.result }}"
          echo "- ë¡¤ë°± ì•ˆì „ì„±: ${{ needs.rollback-safety.result }}"
          echo ""
          echo "ì¦‰ì‹œ í™•ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!"