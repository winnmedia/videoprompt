name: Pre-Deployment Smoke Test

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      test_depth:
        description: 'Test Depth Level'
        required: true
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - comprehensive

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # í™˜ê²½ ë§¤íŠ¸ë¦­ìŠ¤ ì„¤ì • - ì‹¤ì œ ë°°í¬ í™˜ê²½ê³¼ ë™ì¼í•œ ì¡°ê±´
  setup-test-matrix:
    runs-on: ubuntu-latest
    outputs:
      environments: ${{ steps.set-matrix.outputs.environments }}
      test-depth: ${{ steps.set-matrix.outputs.test-depth }}
    steps:
      - name: Set Test Matrix
        id: set-matrix
        run: |
          # PRì—ì„œëŠ” ë¹ ë¥¸ í…ŒìŠ¤íŠ¸, main ë¸Œëœì¹˜ì—ì„œëŠ” í¬ê´„ì  í…ŒìŠ¤íŠ¸
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "environments=[\"development\"]" >> $GITHUB_OUTPUT
            echo "test-depth=quick" >> $GITHUB_OUTPUT
          else
            echo "environments=[\"development\", \"staging\", \"production\"]" >> $GITHUB_OUTPUT
            echo "test-depth=${{ github.event.inputs.test_depth || 'standard' }}" >> $GITHUB_OUTPUT
          fi

  # Real Environment Smoke Tests - Mock ì—†ëŠ” ì‹¤ì œ í…ŒìŠ¤íŠ¸
  real-environment-smoke-test:
    runs-on: ubuntu-latest
    needs: setup-test-matrix
    strategy:
      matrix:
        environment: ${{ fromJson(needs.setup-test-matrix.outputs.environments) }}
      fail-fast: false
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # ì‹¤ì œ í™˜ê²½ë³€ìˆ˜ë¡œ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ í…ŒìŠ¤íŠ¸
      - name: Test Real Environment Build
        run: |
          echo "ğŸ—ï¸ Testing build with real environment configuration for ${{ matrix.environment }}"

          # í™˜ê²½ë³„ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          case "${{ matrix.environment }}" in
            "development")
              export NODE_ENV=development
              export SUPABASE_URL="https://vvkuzxnmfnrvwamfkxuc.supabase.co"
              export SUPABASE_ANON_KEY="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ2a3V6eG5tZm5ydndhbWZreHVjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ0MzYwNjEsImV4cCI6MjA1MDAxMjA2MX0.QbvtKGQp7YN3ZZr7sJWM5q42Uiuy4W-2wCdC6lLI--Y"
              ;;
            "staging")
              export NODE_ENV=production
              export SUPABASE_URL="${{ secrets.STAGING_SUPABASE_URL }}"
              export SUPABASE_ANON_KEY="${{ secrets.STAGING_SUPABASE_ANON_KEY }}"
              ;;
            "production")
              export NODE_ENV=production
              export SUPABASE_URL="${{ secrets.PROD_SUPABASE_URL }}"
              export SUPABASE_ANON_KEY="${{ secrets.PROD_SUPABASE_ANON_KEY }}"
              ;;
          esac

          # í™˜ê²½ë³€ìˆ˜ ê²€ì¦ í…ŒìŠ¤íŠ¸
          echo "ğŸ”§ Validating environment configuration..."
          node -e "
            require('ts-node/register');
            const { validateEnvironment } = require('./src/shared/lib/env-validation.ts');
            const result = validateEnvironment({ failFast: false, logErrors: true });

            if (!result.success) {
              console.error('âŒ Environment validation failed:', result.errors);
              process.exit(1);
            }

            console.log('âœ… Environment validation passed for ${{ matrix.environment }}');
            console.log('ğŸ“Š Config status:', {
              mode: result.mode,
              canOperateSupabase: result.canOperateSupabase
            });
          "

          # ë¹Œë“œ í…ŒìŠ¤íŠ¸
          echo "ğŸ”¨ Testing build process..."
          if ! pnpm build; then
            echo "âŒ Build failed for ${{ matrix.environment }} environment"
            exit 1
          fi

          echo "âœ… Build successful for ${{ matrix.environment }} environment"

      # ì‹¤ì œ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ (Mock ì—†ìŒ)
      - name: Test Real Supabase Connection
        run: |
          echo "ğŸ”Œ Testing real Supabase connection for ${{ matrix.environment }}"

          # ì‹¤ì œ Supabase ì—°ê²° í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          node -e "
            require('ts-node/register');
            (async () => {
              try {
                const { createSupabaseClient } = require('./src/shared/lib/supabase-client.ts');
                const supabase = createSupabaseClient();

                // ì‹¤ì œ ì—°ê²° í…ŒìŠ¤íŠ¸ - ê°„ë‹¨í•œ SELECT ì¿¼ë¦¬
                const { data, error } = await supabase
                  .from('users')
                  .select('count')
                  .limit(1);

                if (error && !error.message.includes('relation \"users\" does not exist')) {
                  throw new Error(\`Supabase connection failed: \${error.message}\`);
                }

                console.log('âœ… Supabase connection test passed for ${{ matrix.environment }}');

                // Auth ì—”ë“œí¬ì¸íŠ¸ í…ŒìŠ¤íŠ¸
                const { data: authData, error: authError } = await supabase.auth.getSession();
                if (authError) {
                  console.warn('âš ï¸ Auth session check failed (expected in CI):', authError.message);
                } else {
                  console.log('âœ… Auth service is accessible');
                }

              } catch (error) {
                console.error('âŒ Real Supabase connection test failed:', error.message);
                if ('${{ matrix.environment }}' === 'production') {
                  process.exit(1); // í”„ë¡œë•ì…˜ì—ì„œëŠ” ì‹¤íŒ¨ ì‹œ ì¤‘ë‹¨
                } else {
                  console.warn('âš ï¸ Connection test failed but continuing for non-production environment');
                }
              }
            })();
          "

      # API ì—”ë“œí¬ì¸íŠ¸ Health Check (ì‹¤ì œ ì„œë²„ ì—†ì´ ì½”ë“œ ë ˆë²¨ ê²€ì¦)
      - name: Test API Routes Integrity
        run: |
          echo "ğŸ©º Testing API routes integrity..."

          # API ë¼ìš°íŠ¸ íŒŒì¼ë“¤ì˜ êµ¬ë¬¸ ë° íƒ€ì… ê²€ì¦
          for route_file in $(find src/app/api -name "route.ts"); do
            echo "Checking: $route_file"

            # TypeScript ì»´íŒŒì¼ í…ŒìŠ¤íŠ¸
            if ! npx tsc --noEmit --skipLibCheck "$route_file"; then
              echo "âŒ TypeScript compilation failed for $route_file"
              exit 1
            fi

            # ê¸°ë³¸ êµ¬ë¬¸ ê²€ì¦ (íŒŒì‹± í…ŒìŠ¤íŠ¸)
            node -e "
              require('ts-node/register');
              try {
                require('./$route_file');
                console.log('âœ… $route_file syntax validation passed');
              } catch (error) {
                console.error('âŒ $route_file syntax validation failed:', error.message);
                process.exit(1);
              }
            " || exit 1
          done

          echo "âœ… All API routes passed integrity check"

      # ì˜ì¡´ì„± ë³´ì•ˆ ë° ë²„ì „ ê²€ì¦
      - name: Test Dependency Security
        run: |
          echo "ğŸ”’ Testing dependency security and versions..."

          # ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
          if ! pnpm audit --audit-level moderate; then
            echo "âŒ Security vulnerabilities found in dependencies"
            exit 1
          fi

          # ì¤‘ìš” ì˜ì¡´ì„± ë²„ì „ ê²€ì¦
          node -e "
            const pkg = require('./package.json');
            const critical_deps = ['next', 'react', 'typescript', '@supabase/supabase-js'];

            for (const dep of critical_deps) {
              const version = pkg.dependencies[dep] || pkg.devDependencies[dep];
              if (!version) {
                console.error(\`âŒ Critical dependency \${dep} not found\`);
                process.exit(1);
              }
              console.log(\`âœ… \${dep}: \${version}\`);
            }

            console.log('âœ… All critical dependencies verified');
          "

      # ì„±ëŠ¥ ê¸°ì¤€ì„  ì¸¡ì •
      - name: Measure Performance Baseline
        if: needs.setup-test-matrix.outputs.test-depth != 'quick'
        run: |
          echo "ğŸ“Š Measuring performance baseline for ${{ matrix.environment }}"

          # ë¹Œë“œ ì‹œê°„ ì¸¡ì •
          start_time=$(date +%s)
          pnpm build > /dev/null 2>&1
          end_time=$(date +%s)
          build_duration=$((end_time - start_time))

          echo "ğŸ•’ Build time: ${build_duration}s"

          # ë²ˆë“¤ í¬ê¸° ë¶„ì„
          if [ -d ".next" ]; then
            bundle_size=$(du -sh .next | cut -f1)
            echo "ğŸ“¦ Bundle size: $bundle_size"

            # ì„±ëŠ¥ ì„ê³„ê°’ ê²€ì¦ (5ë¶„ = 300ì´ˆ)
            if [ $build_duration -gt 300 ]; then
              echo "âŒ Build time exceeded 5 minutes: ${build_duration}s"
              exit 1
            fi
          fi

          # ì„±ëŠ¥ ë©”íŠ¸ë¦­ì„ ì•„í‹°íŒ©íŠ¸ë¡œ ì €ì¥
          echo "{
            \"environment\": \"${{ matrix.environment }}\",
            \"build_time_seconds\": $build_duration,
            \"bundle_size\": \"$bundle_size\",
            \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"
          }" > performance-metrics-${{ matrix.environment }}.json

      # í™˜ê²½ë³„ ì°¨ì´ì  ê°ì§€
      - name: Environment Drift Detection
        if: matrix.environment != 'development'
        run: |
          echo "ğŸ” Detecting environment configuration drift..."

          # ê°œë°œ í™˜ê²½ê³¼ ì°¨ì´ì  ë¹„êµ
          echo "Comparing ${{ matrix.environment }} with development baseline..."

          # í™˜ê²½ë³€ìˆ˜ êµ¬ì¡° ë¹„êµ (ì‹¤ì œ ê°’ì€ ì œì™¸)
          node -e "
            require('ts-node/register');
            const { validateEnvironment } = require('./src/shared/lib/env-validation.ts');

            // í˜„ì¬ í™˜ê²½ ê²€ì¦
            const result = validateEnvironment({ failFast: false, logErrors: false });

            if (!result.success) {
              console.error('âŒ Environment configuration drift detected for ${{ matrix.environment }}');
              console.error('Errors:', result.errors);
              process.exit(1);
            }

            console.log('âœ… Environment configuration consistency verified');
          "

      # ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload Test Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: smoke-test-results-${{ matrix.environment }}-${{ github.run_id }}
          path: |
            performance-metrics-*.json
            .next/build-manifest.json
            *.log
          retention-days: 7

  # êµì°¨ í™˜ê²½ í˜¸í™˜ì„± ê²€ì¦
  cross-environment-compatibility:
    runs-on: ubuntu-latest
    needs: [setup-test-matrix, real-environment-smoke-test]
    if: needs.setup-test-matrix.outputs.test-depth != 'quick'
    timeout-minutes: 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download All Test Artifacts
        uses: actions/download-artifact@v4
        with:
          path: test-results

      - name: Analyze Cross-Environment Compatibility
        run: |
          echo "ğŸ”„ Analyzing cross-environment compatibility..."

          # ì„±ëŠ¥ ë©”íŠ¸ë¦­ ë¹„êµ
          if [ -d "test-results" ]; then
            echo "ğŸ“Š Performance comparison across environments:"
            echo "| Environment | Build Time | Bundle Size |"
            echo "|-------------|------------|-------------|"

            for metrics_file in test-results/*/performance-metrics-*.json; do
              if [ -f "$metrics_file" ]; then
                env_name=$(basename "$metrics_file" .json | sed 's/performance-metrics-//')
                build_time=$(jq -r '.build_time_seconds' "$metrics_file" 2>/dev/null || echo "N/A")
                bundle_size=$(jq -r '.bundle_size' "$metrics_file" 2>/dev/null || echo "N/A")
                echo "| $env_name | ${build_time}s | $bundle_size |"
              fi
            done
          fi

          echo "âœ… Cross-environment compatibility analysis completed"

  # ì¢…í•© ê²°ê³¼ ë¦¬í¬íŠ¸
  smoke-test-summary:
    runs-on: ubuntu-latest
    needs: [real-environment-smoke-test, cross-environment-compatibility]
    if: always()

    steps:
      - name: Generate Smoke Test Summary
        run: |
          echo "# ğŸš€ Pre-Deployment Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Test Run:** ${{ github.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Test Depth:** ${{ needs.setup-test-matrix.outputs.test-depth }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # í…ŒìŠ¤íŠ¸ ê²°ê³¼ ìƒíƒœ
          if [ "${{ needs.real-environment-smoke-test.result }}" = "success" ]; then
            echo "## âœ… Real Environment Tests: PASSED" >> $GITHUB_STEP_SUMMARY
            echo "ëª¨ë“  í™˜ê²½ì—ì„œ ì‹¤ì œ ì—°ê²° ë° ë¹Œë“œ í…ŒìŠ¤íŠ¸ê°€ ì„±ê³µí–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âŒ Real Environment Tests: FAILED" >> $GITHUB_STEP_SUMMARY
            echo "ì¼ë¶€ í™˜ê²½ì—ì„œ ì‹¤ì œ ì—°ê²° ë˜ëŠ” ë¹Œë“œ í…ŒìŠ¤íŠ¸ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ğŸ¯ Key Validations Performed" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Real Supabase connection (no mocks)" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Environment variable validation" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… API routes integrity check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Dependency security audit" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Performance baseline measurement" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Cross-environment compatibility" >> $GITHUB_STEP_SUMMARY

      # ì‹¤íŒ¨ ì‹œ Slack ì•Œë¦¼
      - name: Notify on Critical Failure
        if: failure() && github.ref == 'refs/heads/main'
        uses: 8398a7/action-slack@v3
        with:
          status: failure
          channel: '#deployment-alerts'
          text: |
            ğŸš¨ Pre-Deployment Smoke Test Failed!

            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}

            Critical runtime issues detected before deployment.
            Please investigate immediately.

            Details: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

# ë³´ì•ˆ ë° ë™ì‹œì„± ì„¤ì •
concurrency:
  group: smoke-test-${{ github.ref }}
  cancel-in-progress: true