name: Authentication Security Tests

on:
  push:
    branches: [main]
    paths:
      - 'src/app/api/auth/**'
      - 'src/entities/auth/**' 
      - 'src/features/auth/**'
      - 'src/widgets/auth/**'
      - 'tests/e2e/auth-401-recovery.spec.ts'
      - 'tests/fixtures/auth.ts'
  pull_request:
    branches: [main]
    paths:
      - 'src/app/api/auth/**'
      - 'src/entities/auth/**'
      - 'src/features/auth/**'
      - 'src/widgets/auth/**'
      - 'tests/e2e/auth-401-recovery.spec.ts'
      - 'tests/fixtures/auth.ts'
  schedule:
    # 매일 오전 2시에 보안 테스트 실행 (KST 11시)
    - cron: '0 2 * * *'

env:
  NODE_VERSION: '20'
  # 보안 테스트 전용 환경변수
  AUTH_TEST_MODE: 'true'
  JWT_SECRET: 'secure-ci-test-secret-do-not-use-in-production-401-recovery'
  
jobs:
  # 인증 보안 테스트 - 최우선 실행
  auth-security-tests:
    name: 401 Authentication Security Tests
    runs-on: ubuntu-latest
    timeout-minutes: 20
    
    # 서비스 컨테이너 - 테스트용 데이터베이스
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
          POSTGRES_DB: test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Setup test database
        run: |
          pnpm prisma:generate
          pnpm prisma migrate deploy
        env:
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          
      - name: Build application for testing
        run: pnpm build
        env:
          NODE_ENV: production
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          NEXT_PUBLIC_APP_URL: 'http://localhost:3100'
          JWT_SECRET: ${{ env.JWT_SECRET }}
          
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps chromium
        
      - name: Start application in background
        run: |
          pnpm start --port 3100 &
          sleep 10
          curl -f http://localhost:3100 || exit 1
        env:
          NODE_ENV: production
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          NEXT_PUBLIC_APP_URL: 'http://localhost:3100'
          JWT_SECRET: ${{ env.JWT_SECRET }}
          PORT: 3100
          
      - name: Run 401 Authentication Recovery Tests
        run: pnpm test:e2e:auth-401
        env:
          PW_BASE_URL: 'http://localhost:3100'
          DATABASE_URL: 'postgresql://test:test@localhost:5432/test'
          JWT_SECRET: ${{ env.JWT_SECRET }}
          
      - name: Generate test report
        if: always()
        run: |
          echo "## 401 Authentication Security Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Test execution completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "- Test environment: CI/CD Pipeline" >> $GITHUB_STEP_SUMMARY
          echo "- Database: PostgreSQL 15 (Test Container)" >> $GITHUB_STEP_SUMMARY
          echo "- Browser: Chromium (Playwright)" >> $GITHUB_STEP_SUMMARY
          
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-401-test-results
          path: |
            test-results/
            playwright-report/
          retention-days: 7
          
      - name: Upload failure artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: auth-401-failure-artifacts
          path: |
            test-results/
            playwright-report/
            screenshots/
            videos/
          retention-days: 14

  # 성능 벤치마크 테스트
  auth-performance-benchmark:
    name: Authentication Performance Benchmark
    runs-on: ubuntu-latest
    needs: auth-security-tests
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'
    timeout-minutes: 15
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run performance-focused auth tests
        run: |
          pnpm exec playwright test tests/e2e/auth-401-recovery.spec.ts \
            --grep "성능 테스트" \
            --reporter=json \
            --output-dir=performance-results
        env:
          PW_BASE_URL: 'http://localhost:3100'
          JWT_SECRET: ${{ env.JWT_SECRET }}
          
      - name: Analyze performance metrics
        run: |
          echo "## Authentication Performance Benchmark Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Key Metrics:" >> $GITHUB_STEP_SUMMARY
          echo "- API Response Time Target: ≤ 100ms" >> $GITHUB_STEP_SUMMARY
          echo "- Token Validation Target: ≤ 50ms" >> $GITHUB_STEP_SUMMARY
          echo "- Page Load Time Target: ≤ 3000ms" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Performance test completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY

  # 크로스 브라우저 호환성 테스트
  cross-browser-compatibility:
    name: Cross-Browser Authentication Tests
    runs-on: ubuntu-latest
    needs: auth-security-tests
    if: github.event_name == 'pull_request'
    timeout-minutes: 25
    
    strategy:
      matrix:
        browser: [chromium, firefox, webkit]
        
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Install Playwright browsers
        run: pnpm exec playwright install --with-deps ${{ matrix.browser }}
        
      - name: Run browser-specific tests
        run: |
          pnpm exec playwright test tests/e2e/auth-401-recovery.spec.ts \
            --project=${{ matrix.browser }} \
            --grep "브라우저 호환성" \
            --reporter=json
        env:
          PW_BASE_URL: 'http://localhost:3100'
          JWT_SECRET: ${{ env.JWT_SECRET }}
          
      - name: Upload browser-specific results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: auth-401-${{ matrix.browser }}-results
          path: |
            test-results/
            playwright-report/
          retention-days: 5

  # 보안 취약점 스캔
  security-vulnerability-scan:
    name: Security Vulnerability Scan
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'
    timeout-minutes: 10
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: latest
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Run security audit
        run: |
          pnpm audit --audit-level moderate
          echo "## Security Audit Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Security audit completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          
      - name: Check authentication-related dependencies
        run: |
          echo "## Authentication Dependencies Security Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          pnpm list --depth=0 | grep -E "(jwt|auth|crypto|bcrypt|passport)" || echo "No direct auth dependencies found"
          
  # 브랜치 보호 규칙 업데이트 (자동화)
  update-branch-protection:
    name: Update Branch Protection Rules
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    needs: [auth-security-tests]
    
    steps:
      - name: Update branch protection
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const protection = {
              required_status_checks: {
                strict: true,
                contexts: [
                  'Quality Gates',
                  'Build Verification', 
                  'Tests',
                  '401 Authentication Security Tests'
                ]
              },
              enforce_admins: true,
              required_pull_request_reviews: {
                required_approving_review_count: 1,
                dismiss_stale_reviews: true,
                require_code_owner_reviews: true
              },
              restrictions: null
            };
            
            try {
              await github.rest.repos.updateBranchProtection({
                owner: context.repo.owner,
                repo: context.repo.repo,
                branch: 'main',
                ...protection
              });
              console.log('✅ Branch protection rules updated successfully');
            } catch (error) {
              console.log('⚠️ Could not update branch protection:', error.message);
            }