openapi: 3.0.3
info:
  title: VideoPlanet Authentication API
  description: |
    통합 인증 시스템 - Supabase + 레거시 JWT 지원

    ## 인증 우선순위
    1. Supabase 토큰 (쿠키/Bearer)
    2. 레거시 JWT (Bearer)
    3. 게스트 모드 (allowGuest 옵션)

    ## 에러 코드 정의
    - 400: 잘못된 요청 (Invalid Request)
    - 401: 인증 실패 (Unauthorized)
    - 403: 권한 부족 (Forbidden)

    ## Graceful Degradation
    Service Role Key 미설정 시에도 기본 기능 제공
  version: '1.0.0'
  contact:
    name: VideoPlanet Backend
    email: backend@videoplanet.co.kr
  license:
    name: Proprietary

servers:
  - url: https://api.videoplanet.co.kr
    description: Production
  - url: https://staging-api.videoplanet.co.kr
    description: Staging
  - url: http://localhost:3000
    description: Development

components:
  securitySchemes:
    SupabaseAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "Supabase 인증 토큰"

    LegacyJWT:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: "레거시 JWT 토큰"

    SupabaseCookie:
      type: apiKey
      in: cookie
      name: sb-access-token
      description: "Supabase 세션 쿠키"

    LegacyCookie:
      type: apiKey
      in: cookie
      name: session
      description: "레거시 세션 쿠키"

  schemas:
    AuthenticatedUser:
      type: object
      required: [id, isAuthenticated, tokenType]
      properties:
        id:
          type: string
          description: "사용자 고유 ID"
          example: "550e8400-e29b-41d4-a716-446655440000"
        email:
          type: string
          format: email
          nullable: true
          description: "사용자 이메일"
          example: "user@videoplanet.co.kr"
        username:
          type: string
          nullable: true
          description: "사용자명"
          example: "videomaker01"
        isAuthenticated:
          type: boolean
          const: true
          description: "인증 상태 (항상 true)"
        tokenType:
          type: string
          enum: [supabase, legacy]
          description: "토큰 유형"
        emailVerified:
          type: boolean
          description: "이메일 인증 여부"
          example: true

    GuestUser:
      type: object
      required: [id, email, username, isAuthenticated, tokenType]
      properties:
        id:
          type: "null"
          description: "게스트는 ID 없음"
        email:
          type: "null"
          description: "게스트는 이메일 없음"
        username:
          type: "null"
          description: "게스트는 사용자명 없음"
        isAuthenticated:
          type: boolean
          const: false
          description: "인증 상태 (항상 false)"
        tokenType:
          type: string
          const: guest
          description: "게스트 토큰"

    AuthError:
      type: object
      required: [code, message, statusCode]
      properties:
        code:
          type: string
          enum:
            - UNAUTHORIZED
            - TOKEN_EXPIRED
            - INVALID_TOKEN
            - EMAIL_NOT_VERIFIED
            - SERVICE_UNAVAILABLE
            - GUEST_REQUIRED
          description: "에러 코드"
        message:
          type: string
          description: "에러 메시지 (한국어)"
          example: "유효한 인증 토큰이 필요합니다."
        statusCode:
          type: integer
          enum: [400, 401, 403]
          description: "HTTP 상태 코드"
        details:
          type: object
          nullable: true
          description: "추가 에러 정보"
          properties:
            tokenType:
              type: string
              enum: [supabase, legacy, none]
            degradationMode:
              type: boolean
              description: "Graceful degradation 모드 여부"

    AuthenticationResult:
      oneOf:
        - $ref: '#/components/schemas/AuthenticatedUser'
        - $ref: '#/components/schemas/GuestUser'
        - $ref: '#/components/schemas/AuthError'
      discriminator:
        propertyName: isAuthenticated
        mapping:
          true: '#/components/schemas/AuthenticatedUser'
          false: '#/components/schemas/GuestUser'

    AuthenticationOptions:
      type: object
      properties:
        allowGuest:
          type: boolean
          default: false
          description: "게스트 접근 허용 여부"
        requireEmailVerified:
          type: boolean
          default: false
          description: "이메일 인증 필수 여부"
        gracefulDegradation:
          type: boolean
          default: true
          description: "Service Role Key 없을 때 graceful degradation 허용"

    TokenValidationResult:
      type: object
      required: [valid, tokenType]
      properties:
        valid:
          type: boolean
          description: "토큰 유효성"
        tokenType:
          type: string
          enum: [supabase, legacy, unknown]
          description: "토큰 유형"
        userId:
          type: string
          nullable: true
          description: "사용자 ID (유효한 경우)"
        expiresAt:
          type: string
          format: date-time
          nullable: true
          description: "토큰 만료 시간"
        error:
          type: string
          nullable: true
          description: "검증 실패 사유"

  responses:
    UnauthorizedError:
      description: "인증 실패"
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthError'
          examples:
            invalid_token:
              summary: "유효하지 않은 토큰"
              value:
                code: "INVALID_TOKEN"
                message: "유효하지 않은 인증 토큰입니다."
                statusCode: 401
            token_expired:
              summary: "만료된 토큰"
              value:
                code: "TOKEN_EXPIRED"
                message: "인증 토큰이 만료되었습니다."
                statusCode: 401
            email_not_verified:
              summary: "이메일 미인증"
              value:
                code: "EMAIL_NOT_VERIFIED"
                message: "이메일 인증이 필요합니다."
                statusCode: 401

    ForbiddenError:
      description: "권한 부족"
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthError'
          examples:
            guest_required:
              summary: "게스트 전용 접근"
              value:
                code: "GUEST_REQUIRED"
                message: "게스트만 접근할 수 있습니다."
                statusCode: 403

    ServiceUnavailableError:
      description: "서비스 이용 불가 (Graceful Degradation)"
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/AuthError'
          examples:
            service_unavailable:
              summary: "인증 서비스 일시 중단"
              value:
                code: "SERVICE_UNAVAILABLE"
                message: "인증 서비스가 일시적으로 이용할 수 없습니다. 잠시 후 다시 시도해주세요."
                statusCode: 503
                details:
                  degradationMode: true

paths:
  /api/auth/validate:
    post:
      summary: "통합 인증 검증"
      description: |
        Supabase + 레거시 JWT 통합 인증 검증

        ## 검증 우선순위
        1. Supabase Bearer 토큰
        2. Supabase 쿠키
        3. 레거시 JWT Bearer 토큰
        4. 레거시 JWT 쿠키

        ## Graceful Degradation
        Service Role Key 미설정 시 제한된 기능으로 동작
      operationId: validateAuthentication
      security:
        - SupabaseAuth: []
        - LegacyJWT: []
        - SupabaseCookie: []
        - LegacyCookie: []
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthenticationOptions'
      responses:
        '200':
          description: "인증 성공"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthenticationResult'
              examples:
                supabase_user:
                  summary: "Supabase 사용자"
                  value:
                    id: "550e8400-e29b-41d4-a716-446655440000"
                    email: "user@videoplanet.co.kr"
                    username: "videomaker01"
                    isAuthenticated: true
                    tokenType: "supabase"
                    emailVerified: true
                legacy_user:
                  summary: "레거시 JWT 사용자"
                  value:
                    id: "legacy-user-123"
                    email: "legacy@videoplanet.co.kr"
                    username: "legacyuser"
                    isAuthenticated: true
                    tokenType: "legacy"
                guest_user:
                  summary: "게스트 사용자"
                  value:
                    id: null
                    email: null
                    username: null
                    isAuthenticated: false
                    tokenType: "guest"
        '401':
          $ref: '#/components/responses/UnauthorizedError'
        '403':
          $ref: '#/components/responses/ForbiddenError'
        '503':
          $ref: '#/components/responses/ServiceUnavailableError'

  /api/auth/me:
    get:
      summary: "현재 사용자 정보 조회"
      description: |
        현재 인증된 사용자의 정보를 반환합니다.

        ## 무한 루프 방지
        - 클라이언트 캐싱 필수 (1분)
        - 중복 요청 제한
        - 조건부 요청 지원 (If-None-Match)
      operationId: getCurrentUser
      security:
        - SupabaseAuth: []
        - LegacyJWT: []
        - SupabaseCookie: []
        - LegacyCookie: []
      parameters:
        - name: If-None-Match
          in: header
          schema:
            type: string
          description: "조건부 요청을 위한 ETag"
      responses:
        '200':
          description: "사용자 정보"
          headers:
            ETag:
              schema:
                type: string
              description: "응답 캐싱을 위한 ETag"
            Cache-Control:
              schema:
                type: string
                example: "public, max-age=60"
              description: "캐시 제어 헤더"
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthenticatedUser'
        '304':
          description: "Not Modified (캐시된 응답 사용)"
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/auth/refresh:
    post:
      summary: "토큰 갱신"
      description: |
        만료된 토큰을 갱신합니다.
        Supabase 토큰의 경우 자동 갱신, 레거시 JWT는 수동 갱신
      operationId: refreshToken
      security:
        - SupabaseAuth: []
        - LegacyJWT: []
      responses:
        '200':
          description: "토큰 갱신 성공"
          content:
            application/json:
              schema:
                type: object
                required: [success, tokenType]
                properties:
                  success:
                    type: boolean
                    const: true
                  tokenType:
                    type: string
                    enum: [supabase, legacy]
                  accessToken:
                    type: string
                    description: "새로운 액세스 토큰 (레거시 JWT만)"
                  expiresAt:
                    type: string
                    format: date-time
                    description: "토큰 만료 시간"
        '401':
          $ref: '#/components/responses/UnauthorizedError'

  /api/auth/logout:
    post:
      summary: "로그아웃"
      description: |
        모든 토큰을 무효화하고 세션을 종료합니다.
      operationId: logout
      security:
        - SupabaseAuth: []
        - LegacyJWT: []
        - SupabaseCookie: []
        - LegacyCookie: []
      responses:
        '200':
          description: "로그아웃 성공"
          content:
            application/json:
              schema:
                type: object
                required: [success]
                properties:
                  success:
                    type: boolean
                    const: true
                  message:
                    type: string
                    example: "로그아웃이 완료되었습니다."
        '401':
          description: "이미 로그아웃됨 (무시 가능)"

  # 보안 메타데이터 엔드포인트
  /api/auth/metadata:
    get:
      summary: "인증 시스템 메타데이터"
      description: |
        현재 인증 시스템의 상태와 설정 정보를 반환합니다.
        디버깅 및 모니터링 용도
      operationId: getAuthMetadata
      responses:
        '200':
          description: "인증 시스템 메타데이터"
          content:
            application/json:
              schema:
                type: object
                required: [supabaseEnabled, legacyJwtEnabled, gracefulDegradationEnabled]
                properties:
                  supabaseEnabled:
                    type: boolean
                    description: "Supabase 인증 활성화 여부"
                  legacyJwtEnabled:
                    type: boolean
                    description: "레거시 JWT 인증 활성화 여부"
                  gracefulDegradationEnabled:
                    type: boolean
                    description: "Graceful degradation 활성화 여부"
                  serviceRoleAvailable:
                    type: boolean
                    description: "Service Role Key 사용 가능 여부"
                  supportedTokenTypes:
                    type: array
                    items:
                      type: string
                      enum: [supabase, legacy]
                    description: "지원되는 토큰 유형 목록"
                  version:
                    type: string
                    example: "1.0.0"
                    description: "인증 시스템 버전"

# 에러 처리 가이드
x-error-handling:
  principles:
    - "400: 클라이언트 요청 오류 (잘못된 형식, 필수 필드 누락)"
    - "401: 인증 실패 (토큰 없음, 유효하지 않음, 만료됨)"
    - "403: 권한 부족 (인증은 되었으나 접근 권한 없음)"
    - "503: 서비스 일시 중단 (Graceful degradation)"

  examples:
    bad_request_400:
      description: "잘못된 요청 형식"
      code: "INVALID_REQUEST"
      statusCode: 400

    unauthorized_401:
      description: "인증 토큰 없음/유효하지 않음"
      code: "UNAUTHORIZED"
      statusCode: 401

    forbidden_403:
      description: "접근 권한 없음"
      code: "FORBIDDEN"
      statusCode: 403

# 무한 루프 방지 전략
x-loop-prevention:
  strategies:
    - "클라이언트 캐싱: 최소 1분"
    - "조건부 요청: ETag/If-None-Match 사용"
    - "Rate limiting: IP당 분당 60회"
    - "Circuit breaker: 연속 실패 시 일시 차단"
    - "Debouncing: 동일 요청 중복 제거"