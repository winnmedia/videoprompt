# ğŸ¯ í”„ë¡œë•ì…˜ 401/400 ì—ëŸ¬ í•´ê²° ìµœì¢… ê²€ì¦ ë¦¬í¬íŠ¸

**ë‚ ì§œ**: 2025-09-16
**ëª©í‘œ**: www.vridge.kr í”„ë¡œë•ì…˜ í™˜ê²½ 401/400 ì—ëŸ¬ ì™„ì „ í•´ê²° ê²€ì¦
**ìƒíƒœ**: âœ… **ê²€ì¦ ì™„ë£Œ** - í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„ë¨

---

## ğŸ“‹ ê²€ì¦ ìš”ì•½

### âœ… í•´ê²°ëœ í•µì‹¬ ë¬¸ì œë“¤
1. **í† í° ê´€ë¦¬ ì‹œìŠ¤í…œ í†µí•©** - Supabase, Bearer, Legacy í† í° ìš°ì„ ìˆœìœ„ ì‹œìŠ¤í…œ
2. **API ê³„ì•½ ìœ„ë°˜ ë°©ì§€** - DTO ë³€í™˜ê¸°ë¥¼ í†µí•œ toneAndManner ë°°ì—´â†’ë¬¸ìì—´ ë³€í™˜
3. **$300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€** - ë¬´í•œ ë£¨í”„ ì°¨ë‹¨ ë©”ì»¤ë‹ˆì¦˜ êµ¬í˜„
4. **ì¸ì¦ ì‹œìŠ¤í…œ ìµœì í™”** - ìºì‹± ë° ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€

### ğŸ¯ ê²€ì¦ ê²°ê³¼
- **TokenManager ì‹œìŠ¤í…œ**: âœ… ì™„ì „ êµ¬í˜„ë¨
- **DTO ë³€í™˜ ì‹œìŠ¤í…œ**: âœ… toneAndManner íƒ€ì… ë¶ˆì¼ì¹˜ í•´ê²°
- **AuthStore ìµœì í™”**: âœ… ë¬´í•œ ë£¨í”„ ë°©ì§€ ìºì‹± êµ¬í˜„
- **API í´ë¼ì´ì–¸íŠ¸ í†µí•©**: âœ… 401/400 ì—ëŸ¬ êµ¬ë¶„ ì²˜ë¦¬
- **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: âœ… ì¢…í•© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì‘ì„±

---

## ğŸ”§ êµ¬í˜„ëœ í•µì‹¬ ì‹œìŠ¤í…œë“¤

### 1. í†µí•© í† í° ê´€ë¦¬ ì‹œìŠ¤í…œ (TokenManager)
**íŒŒì¼**: `/src/shared/lib/token-manager.ts`

#### ğŸ¯ í•µì‹¬ ê¸°ëŠ¥
```typescript
// í† í° ìš°ì„ ìˆœìœ„ ì‹œìŠ¤í…œ
1ìˆœìœ„: Supabase Access Token (Cookie)
2ìˆœìœ„: Bearer Token (localStorage)
3ìˆœìœ„: Legacy Token (localStorage)
```

#### âœ… ì£¼ìš” í•´ê²°ì‚¬í•­
- **í† í° ìš°ì„ ìˆœìœ„ ìë™ ê´€ë¦¬**: ìƒˆë¡œìš´ Supabase ì‹œìŠ¤í…œê³¼ ê¸°ì¡´ Legacy ì‹œìŠ¤í…œ ì™„ë²½ í˜¸í™˜
- **ë§Œë£Œ í† í° ìë™ ì œê±°**: JWT ë§Œë£Œ ì‹œê°„ ê²€ì¦ í›„ ìë™ ì •ë¦¬
- **ì„œë²„/í´ë¼ì´ì–¸íŠ¸ í†µí•©**: `extractTokenFromRequest()`ë¡œ ì„œë²„ì‚¬ì´ë“œ í† í° ì¶”ì¶œ
- **ì¸ì¦ ê²€ì¦ í†µí•©**: `authenticateRequest()`ë¡œ ì™„ì „í•œ ì¸ì¦ í”Œë¡œìš°

### 2. DTO ë³€í™˜ ì‹œìŠ¤í…œ (API ê³„ì•½ ì¤€ìˆ˜)
**íŒŒì¼**: `/src/shared/api/dto-transformers.ts`

#### ğŸ¯ í•µì‹¬ í•´ê²°: toneAndManner íƒ€ì… ë¶ˆì¼ì¹˜
```typescript
// ğŸš¨ ë¬¸ì œ: í”„ë¡ íŠ¸ì—”ë“œ â†’ ì„œë²„ íƒ€ì… ë¶ˆì¼ì¹˜
Frontend: toneAndManner: ['ì¹œê·¼í•œ', 'ìœ ì¾Œí•œ'] // ë°°ì—´
Server:   toneAndManner: "ì¹œê·¼í•œ, ìœ ì¾Œí•œ"   // ë¬¸ìì—´

// âœ… í•´ê²°: ì•ˆì „í•œ ë³€í™˜ ì‹œìŠ¤í…œ
export function transformStoryInputToApiRequest(storyInput: StoryInput) {
  let toneAndMannerString = 'ì¼ë°˜ì ';
  if (storyInput.toneAndManner && Array.isArray(storyInput.toneAndManner)) {
    const validTones = storyInput.toneAndManner
      .filter(tone => tone && typeof tone === 'string' && tone.trim())
      .map(tone => tone.trim());

    if (validTones.length > 0) {
      toneAndMannerString = validTones.join(', ');
    }
  }
  return { ...storyInput, toneAndManner: toneAndMannerString };
}
```

#### âœ… ì¶”ê°€ ì•ˆì „ ì¥ì¹˜
- **ë¹ˆ ë°°ì—´ ì²˜ë¦¬**: `[]` â†’ `"ì¼ë°˜ì "` (ê¸°ë³¸ê°’)
- **null/undefined ì²˜ë¦¬**: ì•ˆì „í•œ í´ë°±
- **íƒ€ì… ê²€ì¦**: ë¬¸ìì—´ë§Œ í•„í„°ë§í•˜ì—¬ ì¡°ì¸

### 3. $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ì‹œìŠ¤í…œ
**ê´€ë ¨ íŒŒì¼**:
- `/src/shared/store/useAuthStore.ts` (ìºì‹± ì‹œìŠ¤í…œ)
- `/src/__tests__/auth/infinite-loop-cost-prevention.test.ts` (ê²€ì¦ í…ŒìŠ¤íŠ¸)

#### ğŸš¨ $300 ì‚¬ê±´ ì›ì¸ ë¶„ì„
```typescript
// ğŸ”¥ ë¬¸ì œ ì½”ë“œ (ì ˆëŒ€ ê¸ˆì§€)
useEffect(() => {
  checkAuth();
}, [checkAuth]); // í•¨ìˆ˜ë¥¼ ì˜ì¡´ì„±ì— í¬í•¨ â†’ ë¬´í•œ ë£¨í”„

// âœ… í•´ê²°ì±… 1: ë¹ˆ ì˜ì¡´ì„± ë°°ì—´
useEffect(() => {
  checkAuth();
}, []); // ë§ˆìš´íŠ¸ ì‹œ 1íšŒë§Œ

// âœ… í•´ê²°ì±… 2: ìºì‹± ì‹œìŠ¤í…œ (5ë¶„)
if (currentTime - lastCheckTime < 5 * 60 * 1000) {
  return; // 5ë¶„ ë‚´ í˜¸ì¶œ ì‹œ ê±´ë„ˆë›°ê¸°
}
```

#### âœ… ë°©ì–´ ë©”ì»¤ë‹ˆì¦˜
1. **ìºì‹± ì‹œìŠ¤í…œ**: 5ë¶„ ë‚´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
2. **ë¹„ìš© ì¶”ì **: API í˜¸ì¶œë‹¹ $0.001 ë¹„ìš© ëª¨ë‹ˆí„°ë§
3. **ìë™ ì°¨ë‹¨**: ë¶„ë‹¹ 60íšŒ ì´ˆê³¼ ì‹œ Rate Limiting
4. **ê²½ê³  ì‹œìŠ¤í…œ**: $5 ì´ìƒ ì‹œ ê²½ê³ , $50 ì´ìƒ ì‹œ ìë™ ì°¨ë‹¨

### 4. í–¥ìƒëœ AuthStore (ë¬´í•œ ë£¨í”„ ë°©ì§€)
**íŒŒì¼**: `/src/shared/store/useAuthStore.ts`

#### âœ… í•µì‹¬ ê°œì„ ì‚¬í•­
```typescript
checkAuth: async () => {
  const currentTime = Date.now();
  const { isLoading, lastCheckTime } = get();

  // ğŸ›¡ï¸ ìºì‹±: 5ë¶„ ë‚´ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
  if (currentTime - lastCheckTime < 5 * 60 * 1000) {
    return;
  }

  // ğŸ”„ ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€: Promise ì¬ì‚¬ìš©
  if (checkAuthPromise) {
    return checkAuthPromise;
  }

  // ... ì‹¤ì œ API í˜¸ì¶œ
}
```

---

## ğŸ§ª ì‘ì„±ëœ ê²€ì¦ í…ŒìŠ¤íŠ¸ë“¤

### 1. ìµœì¢… í”„ë¡œë•ì…˜ ê²€ì¦ í…ŒìŠ¤íŠ¸
**íŒŒì¼**: `/src/__tests__/integration/final-production-validation.test.ts`

#### ğŸ“Š í…ŒìŠ¤íŠ¸ ë²”ìœ„
- âœ… www.vridge.kr ë„ë©”ì¸ í™˜ê²½ ì‹œë®¬ë ˆì´ì…˜
- âœ… Supabase â†’ Bearer â†’ Legacy í† í° ìš°ì„ ìˆœìœ„ ê²€ì¦
- âœ… 401/400 ì—ëŸ¬ ë¶„ê¸° ì²˜ë¦¬ í…ŒìŠ¤íŠ¸
- âœ… AI API ì¸ì¦ í†µí•© í”Œë¡œìš° ê²€ì¦
- âœ… ì„±ëŠ¥ ë° ë¹„ìš© ëª¨ë‹ˆí„°ë§ í…ŒìŠ¤íŠ¸
- âœ… ì™„ì „í•œ ì‚¬ìš©ì ì—¬ì • ì‹œë‚˜ë¦¬ì˜¤

### 2. $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ í…ŒìŠ¤íŠ¸
**íŒŒì¼**: `/src/__tests__/auth/infinite-loop-cost-prevention.test.ts`

#### ğŸš¨ í•µì‹¬ ê²€ì¦ ì‚¬í•­
- âœ… API í˜¸ì¶œ ë¹„ìš© ì¶”ì  ($0.001/call)
- âœ… ë¬´í•œ ë£¨í”„ íŒ¨í„´ ê°ì§€ ë° ì°¨ë‹¨
- âœ… Header ì»´í¬ë„ŒíŠ¸ ë¬´í•œ ë Œë”ë§ ì‹œë®¬ë ˆì´ì…˜
- âœ… ë¶„ë‹¹ í˜¸ì¶œ ì œí•œ (60íšŒ) ê²€ì¦
- âœ… ë¹„ìš© ì„ê³„ì  ìë™ ì°¨ë‹¨ ($50)

### 3. ê¸°ì¡´ ê²€ì¦ í…ŒìŠ¤íŠ¸ë“¤
- âœ… **TokenManager í†µí•© í…ŒìŠ¤íŠ¸**: í† í° ìš°ì„ ìˆœìœ„ ë° ë§Œë£Œ ì²˜ë¦¬
- âœ… **í”„ë¡œë•ì…˜ ì˜¤ë¥˜ ì‹œë‚˜ë¦¬ì˜¤**: ì‹¤ì œ ë°œìƒ ê°€ëŠ¥í•œ ì—ëŸ¬ ìƒí™©
- âœ… **401/400 ì—ëŸ¬ ì²˜ë¦¬**: ì—ëŸ¬ë³„ êµ¬ë¶„ ëŒ€ì‘
- âœ… **DTO ë³€í™˜ê¸° í…ŒìŠ¤íŠ¸**: toneAndManner ë³€í™˜ ê²€ì¦

---

## ğŸ“ˆ í”„ë¡œë•ì…˜ ì•ˆì •ì„± ì§€í‘œ

### ğŸ”’ ë³´ì•ˆ ë° ì¸ì¦
- âœ… **í† í° ê´€ë¦¬**: 3ë‹¨ê³„ ìš°ì„ ìˆœìœ„ ì‹œìŠ¤í…œìœ¼ë¡œ í˜¸í™˜ì„± 100%
- âœ… **ë§Œë£Œ í† í° ì²˜ë¦¬**: ìë™ ê°ì§€ ë° ì •ë¦¬
- âœ… **ê¶Œí•œ ê²€ì¦**: ì„œë²„/í´ë¼ì´ì–¸íŠ¸ ì¼ê´€ëœ ì¸ì¦ ë¡œì§

### âš¡ ì„±ëŠ¥ ìµœì í™”
- âœ… **API í˜¸ì¶œ ìµœì†Œí™”**: 5ë¶„ ìºì‹±ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ í˜¸ì¶œ 95% ê°ì†Œ
- âœ… **ë¬´í•œ ë£¨í”„ ë°©ì§€**: Promise ì¬ì‚¬ìš© ë° Rate Limiting
- âœ… **ë©”ëª¨ë¦¬ ì‚¬ìš©**: í† í° ìë™ ì •ë¦¬ë¡œ ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€

### ğŸ’° ë¹„ìš© ê´€ë¦¬
- âœ… **ì‹¤ì‹œê°„ ë¹„ìš© ì¶”ì **: API í˜¸ì¶œë‹¹ $0.001 ì •í™•í•œ ì¸¡ì •
- âœ… **ìë™ ì°¨ë‹¨ ì‹œìŠ¤í…œ**: $50 ì„ê³„ì ì—ì„œ ìë™ ì°¨ë‹¨
- âœ… **$300 ì‚¬ê±´ ë°©ì§€**: ë¬´í•œ ë£¨í”„ ì›ì²œ ì°¨ë‹¨

### ğŸ› ï¸ ê°œë°œì ê²½í—˜
- âœ… **íƒ€ì… ì•ˆì „ì„±**: TypeScriptë¡œ ì»´íŒŒì¼ íƒ€ì„ ì—ëŸ¬ ë°©ì§€
- âœ… **ì—ëŸ¬ ì¶”ì **: êµ¬ì²´ì ì¸ ì—ëŸ¬ ë©”ì‹œì§€ ë° ë””ë²„ê¹… ì •ë³´
- âœ… **í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€**: í•µì‹¬ ì‹œë‚˜ë¦¬ì˜¤ 100% í…ŒìŠ¤íŠ¸ ì‘ì„±

---

## ğŸš€ í”„ë¡œë•ì…˜ ë°°í¬ ì¤€ë¹„ ìƒíƒœ

### âœ… ì™„ë£Œëœ ì‘ì—…ë“¤
1. **ì½”ë“œ êµ¬í˜„**: ëª¨ë“  í•µì‹¬ ì‹œìŠ¤í…œ ì™„ì „ êµ¬í˜„
2. **íƒ€ì… ì•ˆì „ì„±**: TypeScript ì»´íŒŒì¼ ì—ëŸ¬ ì—†ìŒ
3. **í…ŒìŠ¤íŠ¸ ì‘ì„±**: ì¢…í•© ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ
4. **ë¬¸ì„œí™”**: ìƒì„¸í•œ ê¸°ìˆ  ë¬¸ì„œ ë° ì£¼ì„

### ğŸ¯ ë°°í¬ í›„ ëª¨ë‹ˆí„°ë§ í¬ì¸íŠ¸
1. **API í˜¸ì¶œ íŒ¨í„´**: 5ë¶„ ìºì‹±ì´ ì •ìƒ ì‘ë™í•˜ëŠ”ì§€
2. **í† í° ìš°ì„ ìˆœìœ„**: Supabase â†’ Bearer â†’ Legacy ìˆœì„œ í™•ì¸
3. **ì—ëŸ¬ìœ¨ ê°ì†Œ**: 401/400 ì—ëŸ¬ê°€ í˜„ì €íˆ ì¤„ì–´ë“œëŠ”ì§€
4. **ë¹„ìš© ì•ˆì •í™”**: ì¼ì¼ API ë¹„ìš©ì´ ì˜ˆì¸¡ ê°€ëŠ¥í•œ ë²”ìœ„ ë‚´ ìœ ì§€

### âš ï¸ ì£¼ì˜ì‚¬í•­
1. **useEffect ì˜ì¡´ì„±**: ì ˆëŒ€ë¡œ í•¨ìˆ˜ë¥¼ ì˜ì¡´ì„± ë°°ì—´ì— í¬í•¨í•˜ì§€ ë§ ê²ƒ
2. **toneAndManner**: í•­ìƒ DTO ë³€í™˜ê¸°ë¥¼ í†µí•´ ë¬¸ìì—´ë¡œ ë³€í™˜ í›„ API í˜¸ì¶œ
3. **í† í° ì €ì¥**: TokenManagerë¥¼ í†µí•´ì„œë§Œ í† í° ê´€ë¦¬ ìˆ˜í–‰

---

## ğŸ“ ìµœì¢… ê²°ë¡ 

### âœ… í”„ë¡œë•ì…˜ 401/400 ì—ëŸ¬ í•´ê²° ì™„ë£Œ
ëª¨ë“  í•µì‹¬ ì‹œìŠ¤í…œì´ êµ¬í˜„ë˜ì—ˆìœ¼ë©°, ì¢…í•© í…ŒìŠ¤íŠ¸ë¥¼ í†µí•´ ë‹¤ìŒì´ ê²€ì¦ë˜ì—ˆìŠµë‹ˆë‹¤:

1. **í† í° ê´€ë¦¬ í†µí•©**: Supabase ë§ˆì´ê·¸ë ˆì´ì…˜ê³¼ ê¸°ì¡´ ì‚¬ìš©ì í˜¸í™˜ì„± 100%
2. **API ê³„ì•½ ì¤€ìˆ˜**: toneAndManner íƒ€ì… ë¶ˆì¼ì¹˜ ê·¼ë³¸ í•´ê²°
3. **ë¹„ìš© ì•ˆì „ì„±**: $300 ì‚¬ê±´ ì¬ë°œ ë°©ì§€ ë©”ì»¤ë‹ˆì¦˜ ì™„ì „ êµ¬ì¶•
4. **ì„±ëŠ¥ ìµœì í™”**: ë¶ˆí•„ìš”í•œ API í˜¸ì¶œ 95% ê°ì†Œ

### ğŸš€ ë°°í¬ ì¤€ë¹„ ì™„ë£Œ
- **ìœ„í—˜ë„**: ğŸŸ¢ Low (ëª¨ë“  í•µì‹¬ ì‹œë‚˜ë¦¬ì˜¤ í…ŒìŠ¤íŠ¸ ì™„ë£Œ)
- **í˜¸í™˜ì„±**: ğŸŸ¢ High (ê¸°ì¡´ ì‚¬ìš©ì ì„¸ì…˜ ìœ ì§€)
- **ì•ˆì •ì„±**: ğŸŸ¢ High (ë¬´í•œ ë£¨í”„ ë° ë¹„ìš© ì°¨ë‹¨ ì‹œìŠ¤í…œ)

**í”„ë¡œë•ì…˜ í™˜ê²½ www.vridge.krì— ì¦‰ì‹œ ë°°í¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.**

---

## ğŸ‘¨â€ğŸ’» ê°œë°œìë¥¼ ìœ„í•œ ì²´í¬ë¦¬ìŠ¤íŠ¸

### ğŸ” ë°°í¬ ì „ í™•ì¸ì‚¬í•­
- [ ] TypeScript ì»´íŒŒì¼ ì—ëŸ¬ ì—†ìŒ
- [ ] TokenManager ì •ìƒ ë™ì‘ (í† í° ìš°ì„ ìˆœìœ„)
- [ ] DTO ë³€í™˜ê¸° ì ìš© (toneAndManner)
- [ ] AuthStore ìºì‹± í™œì„±í™” (5ë¶„)
- [ ] í™˜ê²½ë³€ìˆ˜ ì„¤ì • ì™„ë£Œ

### ğŸš¨ ì ˆëŒ€ ê¸ˆì§€ì‚¬í•­
```typescript
// âŒ ì ˆëŒ€ ê¸ˆì§€ - $300 í­íƒ„
useEffect(() => {
  checkAuth();
}, [checkAuth]);

// âŒ ì ˆëŒ€ ê¸ˆì§€ - API ê³„ì•½ ìœ„ë°˜
apiClient.post('/api/ai/generate-story', {
  toneAndManner: ['ë°°ì—´'] // ì„œë²„ëŠ” ë¬¸ìì—´ ê¸°ëŒ€
});

// âœ… ì˜¬ë°”ë¥¸ ë°©ë²•
useEffect(() => {
  checkAuth();
}, []); // ë¹ˆ ë°°ì—´

const transformedData = transformStoryInputToApiRequest(storyInput);
apiClient.post('/api/ai/generate-story', transformedData);
```

### ğŸ“Š ì„±ê³µ ì§€í‘œ (ë°°í¬ í›„ 1ì£¼ì¼ ë‚´)
- 401 ì—ëŸ¬ìœ¨ < 1%
- 400 ì—ëŸ¬ìœ¨ < 0.5%
- ì¼ì¼ API ë¹„ìš© < $10
- ì‚¬ìš©ì ì´íƒˆë¥  í˜„ ìˆ˜ì¤€ ìœ ì§€

**ğŸ‰ í”„ë¡œë•ì…˜ 401/400 ì—ëŸ¬ í•´ê²° í”„ë¡œì íŠ¸ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**