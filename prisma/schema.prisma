generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  email              String              @unique
  avatarUrl          String?             @map("avatar_url")
  createdAt          DateTime            @default(now()) @map("created_at")
  preferences        Json?
  role               String
  updatedAt          DateTime            @updatedAt @map("updated_at")
  username           String              @unique
  id                 String              @id @default(uuid())
  passwordHash       String              @map("password_hash")
  emailVerified      Boolean             @default(false) @map("email_verified")
  verifiedAt         DateTime?           @map("verified_at")
  emailVerifications EmailVerification[]
  passwordResets     PasswordReset[]
  projects           Project[]
  refreshTokens      RefreshToken[]
}

model Project {
  id           String    @id @default(uuid())
  title        String
  description  String?
  thumbnailUrl String?   @map("thumbnail_url")
  status       String
  metadata     Json?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  userId       String    @map("user_id")
  tags         Json?
  scenario     String?
  prompt       String?
  video        String?
  user         User      @relation(fields: [userId], references: [id])
  scenes       Scene[]
  timeline     Timeline?
  videoGenerations VideoGeneration[]
}

model Scene {
  id           String   @id @default(uuid())
  title        String
  description  String
  prompt       Json
  thumbnailUrl String?  @map("thumbnail_url")
  duration     Int
  order        Int
  status       String
  aiGenerated  Boolean  @default(false) @map("ai_generated")
  projectId    String   @map("project_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  project      Project  @relation(fields: [projectId], references: [id])
}

model VideoGeneration {
  id            String   @id @default(uuid())
  projectId     String?  @map("project_id")
  seedanceJobId String   @unique @map("seedance_job_id")
  status        String   // queued, processing, completed, failed
  videoUrl      String?  @map("video_url")
  thumbnailUrl  String?  @map("thumbnail_url")
  prompt        String
  duration      Int
  aspectRatio   String   @map("aspect_ratio")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  metadata      Json?
  project       Project? @relation(fields: [projectId], references: [id])

  @@map("video_generations")
}

model Preset {
  id           String   @id @default(uuid())
  name         String
  description  String
  category     String
  thumbnailUrl String?  @map("thumbnail_url")
  data         Json
  isPublic     Boolean  @default(false) @map("is_public")
  userId       String   @map("user_id")
  downloads    Int      @default(0)
  rating       Float    @default(0)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  tags         Json
}

model Timeline {
  id            String   @id @default(uuid())
  projectId     String   @unique @map("project_id")
  totalDuration Int      @default(0) @map("total_duration")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")
  beads         Json     @default("[]")
  project       Project  @relation(fields: [projectId], references: [id])
}

model Scenario {
  id         String   @id @default(uuid())
  title      String
  logline    String?
  structure4 Json?
  shots12    Json?
  pdfUrl     String?  @map("pdf_url")
  version    Int      @default(1)
  createdBy  String?
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")
  userId     String?  @map("user_id")
  prompts    Prompt[]
}

model Prompt {
  id                String       @id @default(uuid())
  scenarioId        String       @map("scenario_id")
  metadata          Json
  timeline          Json
  negative          Json?
  version           Int          @default(1)
  createdAt         DateTime     @default(now()) @map("created_at")
  updatedAt         DateTime     @updatedAt @map("updated_at")
  userId            String?      @map("user_id")
  aiAnalysis        Json?        @map("ai_analysis")
  cinegeniusVersion String?      @map("cinegenius_version")
  generationControl Json?        @map("generation_control")
  projectConfig     Json?        @map("project_config")
  projectId         String?      @map("project_id")
  userInput         Json?        @map("user_input")
  scenario          Scenario     @relation(fields: [scenarioId], references: [id])
  videoAssets       VideoAsset[]
}

model VideoAsset {
  id                  String   @id @default(uuid())
  promptId            String   @map("prompt_id")
  provider            String
  status              String
  url                 String?
  codec               String?
  duration            Int?
  version             Int      @default(1)
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  userId              String?  @map("user_id")
  generation_metadata Json     @default("{}")
  quality_score       Decimal? @default(0.0) @db.Decimal(3, 2)
  prompt              Prompt   @relation(fields: [promptId], references: [id])

  @@index([status, provider], map: "idx_videoasset_status_provider")
}

model ShareToken {
  id          String   @id @default(uuid())
  token       String   @unique
  role        String
  nickname    String?
  targetType  String
  targetId    String
  expiresAt   DateTime @map("expires_at")
  createdAt   DateTime @default(now()) @map("created_at")
  userId      String?  @map("user_id")
  permissions Json     @default("{\"read\": true, \"share\": false, \"write\": false}")

  @@index([token, expiresAt], map: "idx_sharetoken_active")
  @@index([role, targetType, targetId], map: "idx_sharetoken_role_target")
}

model Comment {
  id            String   @id @default(uuid())
  targetType    String
  targetId      String
  author        String?
  text          String
  timecode      String?
  createdAt     DateTime @default(now()) @map("created_at")
  userId        String?  @map("user_id")
  comment_type  String?  @default("general")
  feedback_data Json?
  rating        Int?

  @@index([comment_type, targetType, targetId], map: "idx_comment_type_target")
}

model Story {
  id           String   @id @default(uuid())
  title        String
  oneLineStory String   @map("one_line_story")
  genre        String
  tone         String?
  target       String?
  structure    Json?
  userId       String?  @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
}

model Upload {
  id           String   @id @default(uuid())
  filename     String
  originalName String   @map("original_name")
  path         String
  mimetype     String
  size         Int
  userId       String?  @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
}

model EmailVerification {
  id        String   @id @default(uuid())
  email     String
  token     String   @unique
  code      String?
  userId    String?  @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")
  user      User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
}

model PasswordReset {
  id        String    @id @default(uuid())
  email     String
  token     String    @unique
  userId    String    @map("user_id")
  expiresAt DateTime  @map("expires_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([email])
  @@index([token])
}

model RefreshToken {
  id        String    @id @default(uuid())
  token     String    @unique
  userId    String    @map("user_id")
  deviceId  String?   @map("device_id")
  userAgent String?   @map("user_agent")
  ipAddress String?   @map("ip_address")
  expiresAt DateTime  @map("expires_at")
  revokedAt DateTime? @map("revoked_at")
  usedAt    DateTime? @map("used_at")
  createdAt DateTime  @default(now()) @map("created_at")
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("refresh_tokens")
}

model StoryTemplate {
  id           String   @id @default(uuid())
  name         String
  description  String?
  category     String
  template     Json
  thumbnailUrl String?  @map("thumbnail_url")
  isPublic     Boolean  @default(false) @map("is_public")
  userId       String?  @map("user_id")
  downloads    Int      @default(0)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  @@index([category])
  @@index([userId])
  @@index([isPublic])
  @@map("story_templates")
}

/// This table contains check constraints and requires additional setup for migrations. Visit https://pris.ly/d/check-constraints for more info.
model MigrationLog {
  id                Int      @id @default(autoincrement())
  migration_id      String   @unique @db.VarChar(100)
  migration_name    String   @db.VarChar(255)
  applied_at        DateTime @default(now())
  rollback_script   String?
  checksum          String   @db.VarChar(64)
  execution_time_ms Int?     @default(0)
  status            String?  @default("APPLIED") @db.VarChar(20)
  metadata          Json?    @default("{}")
  created_by        String?  @default("system") @db.VarChar(100)

  @@index([applied_at], map: "idx_migration_log_applied_at")
  @@index([status], map: "idx_migration_log_status")
}
